<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024, user-scalable=no">
  <meta name="robots" content="noindex">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="OptiPlan">
  <meta name="application-name" content="OptiPlan">
  <meta name="description" content="OptiPlan — מרכז בקרה לפרויקט הרחבת קו מטרו, גוש דן">
  <meta name="theme-color" content="#0991F3">
  <title>OptiPlan — מרכז בקרה</title>

  <!-- Home Screen Icons (iPad / iOS) -->
  <link rel="apple-touch-icon" href="user-data/LOGO-ICON.png">
  <link rel="apple-touch-icon" sizes="152x152" href="user-data/LOGO-ICON.png">
  <link rel="apple-touch-icon" sizes="167x167" href="user-data/LOGO-ICON.png">
  <link rel="apple-touch-icon" sizes="180x180" href="user-data/LOGO-ICON.png">

  <!-- Google Fonts — Varela Round (UI) + JetBrains Mono (data/mono) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Tabler Icons Webfont -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="user-data/LOGO-ICON.png">
  <link rel="icon" type="image/png" sizes="32x32" href="user-data/LOGO-ICON.png">
  <link rel="icon" type="image/png" sizes="16x16" href="user-data/LOGO-ICON.png">

  <style>
    /* ================================================================ */
    /* SECTION: CSS Reset & Base                                         */
    /* ================================================================ */

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-text-size-adjust: 100%;
      overflow: hidden;
      scroll-behavior: smooth;
    }

    body {
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    /* ================================================================ */
    /* SECTION: Design Tokens (Custom Properties)                        */
    /* ================================================================ */

    :root {
      /* Typography */
      --font-main: 'Varela Round', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;

      /* Spacing */
      --gap: 16px;
      --gap-sm: 8px;
      --gap-lg: 24px;

      /* Border Radius */
      --radius: 14px;
      --radius-sm: 8px;

      /* Transitions */
      --transition: 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      --transition-flip: 400ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-bounce: 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);

      /* Palette D — Module Colors */
      --optitrack: #0991F3;
      --optibiz: #F6AE2D;
      --optirisk: #FF7A3C;
      --optidocs: #4395FD;
      --optigantt: #0B3C5D;

      /* Status Colors */
      --status-online: #22C55E;
      --status-online-glow: rgba(34,197,94,0.5);
      --status-warning: #84CC16;
      --status-danger: #EF4444;
      --text-on-color: #FFFFFF;
    }

    [data-theme="dark"] {
      --bg-body: #0A0E1A;
      --bg-sidebar: #0F1328;
      --bg-card: #141833;
      --bg-card-hover: #1A2044;
      --bg-input: #181E3A;
      --border: rgba(255,255,255,0.07);
      --border-hover: rgba(255,255,255,0.12);
      --text-primary: #E5E7EB;
      --text-secondary: rgba(255,255,255,0.58);
      --text-muted: rgba(255,255,255,0.30);
      --shadow-card: 0 4px 20px rgba(0,0,0,0.40);
      --shadow-card-hover: 0 8px 36px rgba(0,0,0,0.55);
      --gradient-body: radial-gradient(ellipse 70% 55% at 15% 8%, rgba(9,145,243,0.06) 0%, transparent 55%),
                       radial-gradient(ellipse 55% 45% at 85% 85%, rgba(246,174,45,0.04) 0%, transparent 55%),
                       linear-gradient(165deg, #0A0E1A 0%, #0D1228 45%, #101636 75%, #0A0E1A 100%);
      --toggle-bg: #181E3A;
      --toggle-knob: #F59E0B;
      --sidebar-active: rgba(9,145,243,0.12);
      --bar-track: rgba(255,255,255,0.06);
      --ring-track: rgba(255,255,255,0.05);
      --feed-hover: rgba(255,255,255,0.08);
    }

    [data-theme="light"] {
      --bg-body: #F0F2F8;
      --bg-sidebar: #FFFFFF;
      --bg-card: #FFFFFF;
      --bg-card-hover: #F7F8FC;
      --bg-input: #F0F2F8;
      --border: rgba(0,0,0,0.07);
      --border-hover: rgba(0,0,0,0.13);
      --text-primary: #1A1E36;
      --text-secondary: rgba(0,0,0,0.55);
      --text-muted: rgba(0,0,0,0.32);
      --shadow-card: 0 2px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
      --shadow-card-hover: 0 6px 24px rgba(0,0,0,0.10);
      --gradient-body: linear-gradient(165deg, #F0F2F8 0%, #E8EBF4 50%, #F0F2F8 100%);
      --toggle-bg: #E2E6F0;
      --toggle-knob: #0991F3;
      --sidebar-active: rgba(9,145,243,0.08);
      --bar-track: rgba(0,0,0,0.06);
      --ring-track: rgba(0,0,0,0.06);
      --feed-hover: rgba(0,0,0,0.04);
    }

    /* ================================================================ */
    /* SECTION: Layout — Body & Main Shell                               */
    /* ================================================================ */

    body {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      background: var(--gradient-body);
      background-color: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font-main);
    }

    /* ================================================================ */
    /* SECTION: Layout — Sidebar (240px, RTL right-side)                 */
    /* ================================================================ */

    .sidebar {
      width: 240px;
      height: 100vh;
      position: fixed;
      inset-inline-end: 0;
      top: 0;
      background: var(--bg-sidebar);
      border-inline-start: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: width 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* --- Sidebar Collapsed State --- */
    .sidebar--collapsed {
      width: 60px;
    }

    .sidebar--collapsed .sidebar__nav-label,
    .sidebar--collapsed .sidebar__avatar-info,
    .sidebar--collapsed .sidebar__section-label,
    .sidebar--collapsed .sidebar__footer-api,
    .sidebar--collapsed .sidebar__footer-version,
    .sidebar--collapsed .theme-toggle__label,
    .sidebar--collapsed .ai-indicator__text {
      display: none;
    }

    .sidebar--collapsed .sidebar__nav-item {
      justify-content: center;
      padding: 0;
      border-inline-start: none;
    }

    .sidebar--collapsed .sidebar__avatar {
      justify-content: center;
      padding: 4px;
    }

    .sidebar--collapsed .sidebar__nav {
      padding: 0 4px;
    }

    .sidebar--collapsed .sidebar__footer {
      justify-content: center;
      padding: 4px;
    }

    .sidebar--collapsed .theme-toggle {
      justify-content: center;
      padding: 8px 0;
    }

    .sidebar--collapsed .sidebar__dot {
      display: none;
    }

    .sidebar--collapsed .sidebar__toggle-wrap {
      justify-content: center;
    }

    .sidebar--collapsed ~ .main-content {
      margin-inline-end: 60px;
    }

    .sidebar__toggle-wrap {
      display: flex;
      align-items: center;
      padding: var(--gap-sm) var(--gap);
    }

    /* ================================================================ */
    /* SECTION: Layout — Topbar (58px height)                            */
    /* ================================================================ */

    .topbar {
      height: 58px;
      background: var(--bg-sidebar);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 var(--gap);
      position: sticky;
      top: 0;
      z-index: 50;
      flex-shrink: 0;
    }

    /* ================================================================ */
    /* SECTION: Layout — Main Grid                                       */
    /* ================================================================ */

    .main-content {
      flex: 1;
      margin-inline-end: 240px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 100vh;
      position: relative;
      transition: margin-inline-end 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    #mainRegion {
      padding: 0 20px;
      flex: 1;
      overflow: hidden;
    }

    /* ================================================================ */
    /* SECTION: Theme Toggle                                             */
    /* ================================================================ */

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      touch-action: manipulation;
    }

    .theme-toggle__track {
      width: 44px;
      height: 24px;
      border-radius: 12px;
      background: var(--toggle-bg);
      border: 1px solid var(--border);
      position: relative;
      transition: background var(--transition), border-color var(--transition);
    }

    .theme-toggle__knob {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--toggle-knob);
      position: absolute;
      top: 2px;
      /* Physical right — avoids RTL inversion of inset-inline-end */
      right: 2px;
      left: auto;
      transition: transform var(--transition-bounce),
                  background var(--transition);
      will-change: transform;
    }

    /* Light theme: slide knob from right to left (20px travel = 42px inner - 18px knob - 4px pad) */
    [data-theme="light"] .theme-toggle__knob {
      transform: translateX(-20px);
    }

    .theme-toggle:active .theme-toggle__track {
      transform: scale(0.95);
    }

    .theme-toggle__label {
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--font-main);
    }

    /* ================================================================ */
    /* SECTION: Component — Sidebar Content                              */
    /* ================================================================ */

    .sidebar__brand {
      padding: var(--gap) var(--gap);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--gap-sm);
    }

    .sidebar__brand-logo {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }

    .sidebar__brand-text {
      font-family: var(--font-main);
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.5px;
    }

    .sidebar__avatar {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      margin-bottom: var(--gap-sm);
    }

    .sidebar__avatar-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--optitrack);
      color: var(--bg-body);
      font-family: var(--font-main);
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .sidebar__avatar-info {
      display: flex;
      flex-direction: column;
    }

    .sidebar__avatar-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: var(--font-main);
    }

    .sidebar__avatar-role {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: var(--font-main);
    }

    .sidebar__nav {
      flex: 1;
      overflow-y: auto;
      padding: 0 var(--gap-sm);
      scroll-behavior: smooth;
    }

    .sidebar__section-label {
      display: block;
      padding: var(--gap) var(--gap-sm) 4px;
      font-family: var(--font-mono);
      font-size: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }

    .sidebar__nav-item {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      min-height: 44px;
      padding: 0 var(--gap-sm);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      text-decoration: none;
      cursor: pointer;
      transition: background var(--transition), color var(--transition),
                  border-color var(--transition);
      border-inline-start: 3px solid transparent;
      touch-action: manipulation;
    }

    .sidebar__nav-item:active {
      background: var(--sidebar-active);
      transform: scale(0.98);
    }

    .sidebar__nav-item--active {
      border-inline-start: 3px solid var(--optitrack);
      background: var(--sidebar-active);
      color: var(--text-primary);
    }

    .sidebar__nav-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .sidebar__nav-label {
      font-family: var(--font-main);
      font-size: 14px;
      flex: 1;
    }

    .sidebar__dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .sidebar__footer {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      border-top: 1px solid var(--border);
    }

    .sidebar__footer-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--status-online);
      box-shadow: 0 0 6px var(--status-online-glow);
      animation: sidebar-pulse 2s ease-in-out infinite;
      flex-shrink: 0;
    }

    .sidebar__footer-api,
    .sidebar__footer-version {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    .sidebar__footer-version {
      margin-inline-start: auto;
    }

    /* ================================================================ */
    /* SECTION: Component — Topbar Content                               */
    /* ================================================================ */

    .topbar__brand {
      display: flex;
      align-items: center;
      gap: var(--gap);
    }

    .topbar__brand-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .topbar__title-block {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .topbar__title {
      font-family: var(--font-main);
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .topbar__subtitle {
      font-family: var(--font-main);
      font-size: 14px;
      color: var(--text-secondary);
    }

    .topbar__actions {
      display: flex;
      align-items: center;
      gap: var(--gap);
      margin-inline-start: auto;
    }

    .topbar__clock {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--text-muted);
    }

    .topbar__search {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: 6px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-family: var(--font-main);
      font-size: 13px;
      cursor: default;
    }

    .topbar__search-icon {
      font-size: 16px;
      color: var(--text-muted);
    }

    .topbar__search-text {
      color: var(--text-muted);
      font-family: var(--font-main);
      font-size: 13px;
    }

    .topbar__bell {
      position: relative;
      font-size: 20px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .sidebar-toggle {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-input);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      transition: background var(--transition), color var(--transition);
      touch-action: manipulation;
      flex-shrink: 0;
    }

    .sidebar-toggle:active {
      transform: scale(0.92);
    }

    .topbar__bell-badge {
      position: absolute;
      top: -2px;
      inset-inline-end: -2px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--optirisk);
    }

    /* ================================================================ */
    /* SECTION: Component — Hero Gauges                                  */
    /* ================================================================ */

    .hero-gauges {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: var(--gap);
      padding: 8px 0 4px;
    }

    .hero-gauge {
      width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .hero-gauge__svg {
      width: 100%;
      height: auto;
    }

    .hero-gauge__track {
      stroke: var(--ring-track);
    }

    .hero-gauge__fill {
      transition: stroke-dashoffset 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    [data-gauge="financial"] .hero-gauge__fill {
      stroke: var(--optibiz);
    }

    [data-gauge="coordination"] .hero-gauge__fill {
      stroke: var(--optitrack);
    }

    [data-gauge="schedule"] .hero-gauge__fill {
      stroke: var(--optigantt);
    }

    .hero-gauge__value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 20px;
      fill: var(--text-primary);
    }

    .hero-gauge__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 2px;
    }

    .hero-gauge__fill.is-animating {
      will-change: stroke-dashoffset;
    }

    .hero-gauge__fill.is-idle {
      animation: gauge-pulse 3s ease-in-out infinite;
      will-change: opacity;
    }

    /* ================================================================ */
    /* SECTION: Component — Stat Cards                                   */
    /* ================================================================ */

    .stat-cards-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      padding: 4px 0;
      max-width: 744px;
      margin: 0 auto;
    }

    .stat-card {
      border-radius: var(--radius);
      position: relative;
      cursor: pointer;
      min-width: 180px;
      min-height: 170px;
      flex: 1 1 calc(33.333% - 8px);
      max-width: calc(33.333% - 6px);
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
      transition: transform var(--transition);
      perspective: 1000px;
      -webkit-perspective: 1000px;
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    [data-module="optitrack"] { --module: var(--optitrack); }
    [data-module="optibiz"]   { --module: var(--optibiz); }
    [data-module="optirisk"]  { --module: var(--optirisk); }
    [data-module="optidocs"]  { --module: var(--optidocs); }
    [data-module="optigantt"] { --module: var(--optigantt); }

    .stat-card__name {
      display: block;
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-on-color);
    }

    .stat-card__value {
      display: block;
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 26px;
      color: var(--text-on-color);
      margin: 2px 0 1px;
    }

    .stat-card__label {
      display: block;
      font-size: 14px;
      color: rgba(255,255,255,0.85);
    }

    .stat-card__sublabel {
      display: block;
      font-size: 12px;
      opacity: 0.7;
      color: var(--text-on-color);
    }

    .stat-card__icon {
      position: absolute;
      bottom: 8px;
      inset-inline-start: 8px;
      font-size: 48px;
      opacity: 0.25;
      color: var(--text-on-color);
      pointer-events: none;
    }

    /* ================================================================ */
    /* SECTION: Component — Stat Card Flip                                */
    /* ================================================================ */

    .stat-card__front {
      position: absolute;
      inset: 0;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      transition: transform var(--transition-flip);
      transform: rotateY(0deg);
      z-index: 2;
      background: var(--module);
      background: linear-gradient(135deg, var(--module), color-mix(in srgb, var(--module) 68%, #000));
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      box-shadow: 0 4px 16px color-mix(in srgb, var(--module) 35%, transparent);
      border-radius: var(--radius);
      overflow: hidden;
      padding: 10px;
    }

    .stat-card__back {
      position: absolute;
      inset: 0;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      transition: transform var(--transition-flip);
      transform: rotateY(180deg);
      z-index: 1;
      background: var(--bg-card);
      border-top: 3px solid var(--module);
      border-radius: var(--radius);
      overflow-y: auto;
      overflow-x: hidden;
      padding: 8px;
      display: flex;
      flex-direction: column;
    }

    .stat-card--flipped .stat-card__front {
      transform: rotateY(-180deg);
      will-change: transform;
    }

    .stat-card--flipped .stat-card__back {
      transform: rotateY(0deg);
      will-change: transform;
    }

    /* Back face — header */
    .stat-card__back-header {
      margin-bottom: 4px;
    }

    .stat-card__back-title {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-secondary);
    }

    /* Back face — KPI rows */
    .stat-card__back-kpis {
      flex: 1;
    }

    .stat-card__kpi-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
      border-bottom: 1px solid var(--border);
    }

    .stat-card__kpi-row:last-child {
      border-bottom: none;
    }

    .stat-card__kpi-label {
      font-family: var(--font-main);
      font-size: 11px;
      color: var(--text-secondary);
    }

    .stat-card__kpi-value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 12px;
      color: var(--text-primary);
    }

    .stat-card__kpi-trend {
      font-size: 12px;
    }

    .stat-card__kpi-trend--up {
      color: var(--status-online);
    }

    .stat-card__kpi-trend--down {
      color: var(--status-danger);
    }

    .stat-card__kpi-trend--neutral {
      color: var(--text-muted);
    }

    /* Back face — CTA button */
    .stat-card__back-cta {
      width: 100%;
      padding: 5px;
      min-height: 28px;
      background: var(--module);
      color: var(--text-on-color);
      border: none;
      border-radius: var(--radius-sm);
      font-family: var(--font-main);
      font-size: 11px;
      cursor: pointer;
      touch-action: manipulation;
      margin-top: auto;
      flex-shrink: 0;
    }

    /* ================================================================ */
    /* SECTION: Component — Module Overlay                               */
    /* ================================================================ */

    .module-overlay-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 350ms ease;
      touch-action: none;
    }

    .module-overlay-backdrop--active {
      opacity: 1;
      pointer-events: auto;
    }

    .module-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      width: 80vw;
      height: 85vh;
      background: var(--bg-card);
      border-radius: var(--radius);
      z-index: 101;
      opacity: 0;
      pointer-events: none;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
      transition: transform 500ms cubic-bezier(0.16, 1, 0.3, 1),
                  opacity 500ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .module-overlay--active {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
      will-change: transform, opacity;
    }

    /* Faster close animation — retain GPU compositing hint */
    .module-overlay--closing {
      transition-duration: 350ms;
      will-change: transform, opacity;
    }

    .module-overlay__header {
      display: flex;
      align-items: center;
      gap: var(--gap);
      padding: var(--gap) var(--gap-lg, 20px);
      border-top: 3px solid var(--module);
      border-bottom: 1px solid var(--border);
      position: relative;
      flex-shrink: 0;
    }

    .module-overlay__icon {
      font-size: 24px;
      color: var(--module);
    }

    .module-overlay__header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .module-overlay__title {
      font-family: var(--font-main);
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .module-overlay__subtitle {
      font-family: var(--font-main);
      font-size: 14px;
      color: var(--text-secondary);
    }

    .module-overlay__back {
      position: absolute;
      top: 50%;
      inset-inline-end: var(--gap);
      transform: translateY(-50%);
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 20px;
      cursor: pointer;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
      transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
    }

    .module-overlay__back:active {
      transform: translateY(-50%) scale(0.95);
      background: var(--border);
    }

    .module-overlay__content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: var(--gap);
      overscroll-behavior: contain;
      direction: rtl;
      text-align: right;
      scroll-behavior: smooth;
    }

    /* ================================================================ */
    /* SECTION: Component — OptiTrack Module                              */
    /* ================================================================ */

    /* --- Metrics Summary Row --- */
    .optitrack-metrics {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    .optitrack-metric {
      flex: 1;
      min-width: 120px;
      background: var(--bg-card);
      background: color-mix(in srgb, var(--optitrack) 8%, var(--bg-card));
      border-radius: var(--radius-sm);
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(9, 145, 243, 0.15);
      border: 1px solid color-mix(in srgb, var(--optitrack) 15%, transparent);
    }

    .optitrack-metric__value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 24px;
      color: var(--text-primary);
      line-height: 1;
    }

    .optitrack-metric__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* --- Permit Matrix --- */
    .permit-matrix {
      margin-top: var(--gap);
    }

    .permit-matrix__svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .permit-cell--approved { fill: var(--status-online); }
    .permit-cell--pending { fill: var(--optibiz); }
    .permit-cell--objection { fill: var(--optirisk); }
    .permit-cell--not-submitted { fill: var(--text-muted); }
    .permit-cell--in-review { fill: var(--optitrack); }

    .permit-matrix__label {
      font-family: var(--font-main);
      font-size: 11px;
      fill: var(--text-primary);
    }

    .permit-matrix__col-label {
      font-family: var(--font-main);
      font-size: 9px;
      fill: var(--text-secondary);
    }

    .permit-matrix__cell-text {
      font-family: var(--font-mono);
      font-size: 10px;
      fill: var(--text-on-color);
      pointer-events: none;
    }

    /* --- Activity Feed --- */
    .activity-feed {
      margin-top: var(--gap);
      display: flex;
      flex-direction: column;
      gap: var(--gap-sm, 8px);
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: var(--gap);
      padding: var(--gap-sm, 8px) 0;
      border-bottom: 1px solid var(--border);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-item__avatar {
      width: 36px;
      height: 36px;
      min-width: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-main);
      font-size: 14px;
      font-weight: 700;
      color: var(--text-on-color);
    }

    .activity-item__body {
      flex: 1;
      min-width: 0;
    }

    .activity-item__header {
      display: flex;
      align-items: baseline;
      gap: var(--gap-sm, 8px);
      flex-wrap: wrap;
    }

    .activity-item__name {
      font-family: var(--font-main);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .activity-item__time {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    .activity-item__desc {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
      margin: 4px 0 0;
    }

    .activity-item__badge {
      font-family: var(--font-main);
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      white-space: nowrap;
      align-self: center;
    }

    .activity-item__badge--approved {
      background: rgba(34, 197, 94, 0.2);
      background: color-mix(in srgb, var(--status-online) 20%, transparent);
      color: var(--status-online);
    }

    .activity-item__badge--pending {
      background: rgba(246, 174, 45, 0.2);
      background: color-mix(in srgb, var(--optibiz) 20%, transparent);
      color: var(--optibiz);
    }

    .activity-item__badge--objection {
      background: rgba(255, 122, 60, 0.2);
      background: color-mix(in srgb, var(--optirisk) 20%, transparent);
      color: var(--optirisk);
    }

    .activity-item__badge--in-review {
      background: rgba(9, 145, 243, 0.2);
      background: color-mix(in srgb, var(--optitrack) 20%, transparent);
      color: var(--optitrack);
    }

    /* --- Section Headers --- */
    .optitrack-section-title {
      font-family: var(--font-main);
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: var(--gap);
      margin-bottom: var(--gap-sm, 8px);
      display: flex;
      align-items: center;
      gap: var(--gap-sm, 8px);
    }

    .optitrack-section-title__icon {
      font-size: 16px;
      color: var(--optitrack);
    }

    /* --- Staggered Entrance Animation --- */
    .optitrack-section {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 300ms cubic-bezier(0.16, 1, 0.3, 1),
                  transform 300ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .optitrack-section--visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ================================================================ */
    /* SECTION: Component — OptiBiz Module                                */
    /* ================================================================ */

    /* --- Metrics Summary Row --- */
    .optibiz-metrics {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    .optibiz-metric {
      flex: 1;
      min-width: 120px;
      background: var(--bg-card);
      background: color-mix(in srgb, var(--optibiz) 8%, var(--bg-card));
      border-radius: var(--radius-sm);
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(246, 174, 45, 0.15);
      border: 1px solid color-mix(in srgb, var(--optibiz) 15%, transparent);
    }

    .optibiz-metric__value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 24px;
      color: var(--text-primary);
      line-height: 1;
    }

    .optibiz-metric__value--negative {
      color: var(--optirisk);
    }

    .optibiz-metric__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .optibiz-metric__bar {
      height: 4px;
      background: var(--bar-track);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }

    .optibiz-metric__bar-fill {
      height: 100%;
      background: var(--optibiz);
      border-radius: 2px;
    }

    /* --- Cash Flow Chart --- */
    .optibiz-chart-wrap {
      margin-top: var(--gap);
    }

    .optibiz-chart__svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .optibiz-bar--plan {
      fill: var(--optibiz);
      opacity: 0.4;
    }

    .optibiz-bar--actual {
      fill: var(--optibiz);
    }

    .optibiz-trend-line {
      stroke: var(--optibiz);
      fill: none;
      stroke-width: 2;
      stroke-dasharray: 6, 3;
      opacity: 0.7;
    }

    .optibiz-trend-dot {
      fill: var(--optibiz);
      opacity: 0.7;
    }

    .optibiz-chart__axis-label {
      font-family: var(--font-mono);
      font-size: 10px;
      fill: var(--text-muted);
    }

    .optibiz-chart__month-label {
      font-family: var(--font-main);
      font-size: 10px;
      fill: var(--text-muted);
    }

    .optibiz-chart__grid-line {
      stroke: var(--border);
      stroke-opacity: 0.3;
    }

    .optibiz-chart__axis-label--right {
      font-family: var(--font-mono);
      font-size: 9px;
      fill: var(--text-muted);
      opacity: 0.7;
    }

    /* --- Legend --- */
    .optibiz-legend {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
      margin-top: var(--gap);
    }

    .optibiz-legend__item {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
    }

    .optibiz-legend__swatch {
      width: 16px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .optibiz-legend__swatch--plan {
      background: var(--optibiz);
      opacity: 0.4;
    }

    .optibiz-legend__swatch--actual {
      background: var(--optibiz);
    }

    .optibiz-legend__line {
      width: 16px;
      height: 2px;
      opacity: 0.7;
      flex-shrink: 0;
      border-top: 2px dashed var(--optibiz);
      background: none;
    }

    .optibiz-legend__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* --- Section Headers --- */
    .optibiz-section-title {
      font-family: var(--font-main);
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: var(--gap);
      margin-bottom: var(--gap-sm);
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
    }

    .optibiz-section-title__icon {
      font-size: 16px;
      color: var(--optibiz);
    }

    /* --- Staggered Entrance Animation --- */
    .optibiz-section {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 300ms cubic-bezier(0.16, 1, 0.3, 1),
                  transform 300ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .optibiz-section--visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ================================================================ */
    /* SECTION: Component — OptiRisk Module                               */
    /* ================================================================ */

    /* --- Metrics Summary Row --- */
    .optirisk-metrics {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    .optirisk-metric {
      flex: 1;
      min-width: 120px;
      background: var(--bg-card);
      background: color-mix(in srgb, var(--optirisk) 8%, var(--bg-card));
      border-radius: var(--radius-sm);
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(255, 122, 60, 0.15);
      border: 1px solid color-mix(in srgb, var(--optirisk) 15%, transparent);
    }

    .optirisk-metric__value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 24px;
      color: var(--text-primary);
      line-height: 1;
    }

    .optirisk-metric__value--critical {
      color: var(--optirisk);
    }

    .optirisk-metric__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* --- Heat Map SVG --- */
    .optirisk-heatmap-wrap {
      margin-top: var(--gap);
    }

    .optirisk-heatmap__svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .risk-cell--zone-0 { fill: var(--status-online); }
    .risk-cell--zone-1 { fill: var(--status-warning); }
    .risk-cell--zone-2 { fill: var(--optibiz); }
    .risk-cell--zone-3 { fill: var(--optirisk); }
    .risk-cell--zone-4 { fill: var(--status-danger); }

    .optirisk-heatmap__axis-title {
      font-family: var(--font-main);
      font-size: 12px;
      font-weight: 700;
      fill: var(--text-secondary);
    }

    .optirisk-heatmap__row-label {
      font-family: var(--font-main);
      font-size: 11px;
      fill: var(--text-secondary);
    }

    .optirisk-heatmap__col-label {
      font-family: var(--font-main);
      font-size: 11px;
      fill: var(--text-secondary);
    }

    .optirisk-heatmap__count {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 700;
    }

    .optirisk-heatmap__count--zero {
      fill: var(--text-muted);
    }

    .optirisk-heatmap__count--nonzero {
      fill: var(--text-on-color);
    }

    .optirisk-heatmap__count--bright {
      fill: var(--text-primary);
    }

    /* --- Color Scale Legend --- */
    .optirisk-legend {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
      margin-top: var(--gap-sm);
      align-items: center;
    }

    .optirisk-legend__item {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
    }

    .optirisk-legend__swatch {
      width: 16px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .optirisk-legend__swatch--zone-0 { background: var(--status-online); }
    .optirisk-legend__swatch--zone-1 { background: var(--status-warning); }
    .optirisk-legend__swatch--zone-2 { background: var(--optibiz); }
    .optirisk-legend__swatch--zone-3 { background: var(--optirisk); }
    .optirisk-legend__swatch--zone-4 { background: var(--status-danger); }

    .optirisk-legend__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* --- Top Risks Table --- */
    .optirisk-table {
      margin-top: var(--gap);
      width: 100%;
      direction: rtl;
    }

    .optirisk-table__header {
      display: flex;
      padding: var(--gap-sm) var(--gap);
      border-bottom: 1px solid var(--border);
      gap: var(--gap);
      direction: rtl;
    }

    .optirisk-table__col {
      font-family: var(--font-main);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .optirisk-table__col--name {
      flex: 4;
      min-width: 160px;
      text-align: right;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .optirisk-table__col--severity,
    .optirisk-table__col--trend,
    .optirisk-table__col--mitigation {
      flex: 1;
      text-align: center;
      min-width: 80px;
      flex-shrink: 0;
    }

    .optirisk-table__row {
      display: flex;
      padding: var(--gap-sm) var(--gap);
      gap: var(--gap);
      align-items: center;
      min-height: 44px;
      transition: background 150ms ease;
      direction: rtl;
    }

    .optirisk-table__row--alt {
      background: var(--bar-track);
    }

    .optirisk-table__row:hover {
      background: var(--feed-hover);
    }

    .optirisk-table__row .optirisk-table__col {
      color: var(--text-primary);
      font-size: 13px;
    }

    .optirisk-table__row .optirisk-table__col--name {
      font-weight: 600;
    }

    /* --- Severity & Mitigation Badges --- */
    .optirisk-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-family: var(--font-main);
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .optirisk-badge--critical { background: rgba(239, 68, 68, 0.2); color: var(--status-danger); }
    .optirisk-badge--high { background: rgba(255, 122, 60, 0.2); color: var(--optirisk); }
    .optirisk-badge--medium { background: rgba(246, 174, 45, 0.2); color: var(--optibiz); }
    .optirisk-badge--low { background: rgba(34, 197, 94, 0.2); color: var(--status-online); }

    .optirisk-badge--active { background: rgba(9, 145, 243, 0.2); color: var(--optitrack); }
    .optirisk-badge--monitoring { background: rgba(246, 174, 45, 0.15); color: var(--optibiz); }

    [data-theme="light"] .optirisk-badge--medium,
    [data-theme="light"] .optirisk-badge--monitoring {
      color: #AC7A1F;
      color: color-mix(in srgb, var(--optibiz) 70%, #000);
    }
    .optirisk-badge--resolved { background: rgba(34, 197, 94, 0.15); color: var(--status-online); }
    .optirisk-badge--legal-review { background: rgba(160, 164, 184, 0.2); color: var(--text-secondary); }

    /* --- Trend Arrows --- */
    .optirisk-trend {
      font-size: 14px;
      font-weight: 700;
    }

    .optirisk-trend--up { color: var(--status-danger); }
    .optirisk-trend--down { color: var(--status-online); }
    .optirisk-trend--stable { color: var(--text-muted); }

    /* --- Section Headers --- */
    .optirisk-section-title {
      font-family: var(--font-main);
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-top: var(--gap);
      margin-bottom: var(--gap-sm);
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
    }

    .optirisk-section-title__icon {
      font-size: 16px;
      color: var(--optirisk);
    }

    /* --- Staggered Entrance Animation --- */
    .optirisk-section {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 300ms cubic-bezier(0.16, 1, 0.3, 1),
                  transform 300ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .optirisk-section--visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ================================================================ */
    /* SECTION: Component — OptiDocs Module                              */
    /* ================================================================ */

    /* --- Metrics Summary Row --- */
    .optidocs-metrics {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    .optidocs-metric {
      flex: 1;
      min-width: 120px;
      background: var(--bg-card);
      background: color-mix(in srgb, var(--optidocs) 8%, var(--bg-card));
      border-radius: var(--radius-sm);
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(67, 149, 253, 0.15);
      border: 1px solid color-mix(in srgb, var(--optidocs) 15%, transparent);
    }

    .optidocs-metric__value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 24px;
      color: var(--text-primary);
      line-height: 1;
    }

    .optidocs-metric__value--overdue {
      color: var(--status-danger);
    }

    .optidocs-metric__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* --- Document Table --- */
    .optidocs-table-wrapper {
      overflow-y: auto;
      max-height: calc(100% - 120px);
      overscroll-behavior: contain;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      margin-top: var(--gap);
    }

    .optidocs-table__header,
    .optidocs-table__row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 0.6fr;
      align-items: center;
      gap: var(--gap-sm);
      padding: 10px var(--gap);
    }

    .optidocs-table__header {
      position: sticky;
      top: 0;
      z-index: 1;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
    }

    .optidocs-table__col--header {
      font-family: var(--font-main);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .optidocs-table__row {
      min-height: 44px;
      transition: background 150ms ease;
    }

    .optidocs-table__row--alt {
      background: var(--bar-track);
    }

    .optidocs-table__row:hover {
      background: var(--feed-hover);
    }

    .optidocs-table__col--name {
      font-family: var(--font-main);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .optidocs-table__col--type {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    .optidocs-table__col--date {
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* --- Status Badges --- */
    .optidocs-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-family: var(--font-main);
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .optidocs-badge--approved {
      background: rgba(34, 197, 94, 0.2);
      color: var(--status-online);
    }

    .optidocs-badge--pending {
      background: rgba(246, 174, 45, 0.2);
      color: var(--optibiz);
    }

    .optidocs-badge--overdue {
      background: rgba(239, 68, 68, 0.2);
      color: var(--status-danger);
    }

    [data-theme="light"] .optidocs-badge--pending {
      color: #AC7A1F;
      color: color-mix(in srgb, var(--optibiz) 70%, #000);
    }

    /* --- Assignee Initials --- */
    .optidocs-assignee {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--bg-card);
      background: color-mix(in srgb, var(--optidocs) 15%, var(--bg-card));
      color: var(--optidocs);
      font-family: var(--font-main);
      font-size: 11px;
      font-weight: 600;
    }

    /* --- Staggered Entrance Animation --- */
    .optidocs-section {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 300ms cubic-bezier(0.16, 1, 0.3, 1),
                  transform 300ms cubic-bezier(0.16, 1, 0.3, 1);
      will-change: transform, opacity;
    }

    .optidocs-section--visible {
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      .optidocs-section {
        transition: none;
        opacity: 1;
        transform: none;
      }
    }

    /* ================================================================ */
    /* SECTION: Component — OptiGantt Module                              */
    /* ================================================================ */

    /* --- Metrics Summary Row --- */
    .optigantt-metrics {
      display: flex;
      gap: var(--gap);
      flex-wrap: wrap;
    }

    .optigantt-metric {
      flex: 1;
      min-width: 120px;
      background: var(--bg-card);
      background: color-mix(in srgb, var(--optigantt) 8%, var(--bg-card));
      border-radius: var(--radius-sm);
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: 1px solid rgba(11, 60, 93, 0.15);
      border: 1px solid color-mix(in srgb, var(--optigantt) 15%, transparent);
    }

    .optigantt-metric__value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 22px;
      color: var(--text-primary);
      line-height: 1;
    }

    .optigantt-metric__label {
      font-family: var(--font-main);
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* --- SVG Gantt Chart --- */
    .optigantt-chart {
      width: 100%;
      margin-top: var(--gap);
    }

    .optigantt-chart__svg {
      width: 100%;
      height: auto;
      display: block;
    }

    .optigantt-chart__grid-line {
      stroke: var(--border);
      stroke-opacity: 0.3;
      stroke-width: 1;
    }

    .optigantt-chart__axis-label {
      fill: var(--text-muted);
      font-family: var(--font-main);
      font-size: 10px;
    }

    .optigantt-chart__year-label {
      fill: var(--text-secondary);
      font-family: var(--font-main);
      font-size: 11px;
      font-weight: 600;
    }

    .optigantt-chart__row-label {
      fill: var(--text-secondary);
      font-family: var(--font-main);
      font-size: 11px;
    }

    .optigantt-chart__row-separator {
      stroke: var(--border);
      stroke-opacity: 0.04;
      stroke-width: 1;
    }

    .optigantt-bar--plan {
      fill: var(--optigantt);
      opacity: 0.4;
    }

    .optigantt-bar--actual {
      fill: var(--optigantt);
    }

    .optigantt-milestone {
      fill: var(--optigantt);
    }

    .optigantt-milestone--review {
      fill: var(--optigantt);
      opacity: 0.7;
    }

    .optigantt-milestone--launch {
      fill: var(--optigantt);
      opacity: 0.85;
    }

    .optigantt-milestone__label {
      fill: var(--text-muted);
      font-family: var(--font-main);
      font-size: 10px;
    }

    .optigantt-today {
      stroke: var(--text-secondary);
      stroke-width: 1.5;
      stroke-dasharray: 6,4;
    }

    .optigantt-today__label {
      fill: var(--text-secondary);
      font-family: var(--font-main);
      font-size: 10px;
      font-weight: 600;
    }

    /* --- Staggered Entrance Animation --- */
    .optigantt-section {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 300ms cubic-bezier(0.16, 1, 0.3, 1),
                  transform 300ms cubic-bezier(0.16, 1, 0.3, 1);
      will-change: transform, opacity;
    }

    .optigantt-section--visible {
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      .optigantt-section {
        transition: none;
        opacity: 1;
        transform: none;
      }
    }

    /* ================================================================ */
    /* SECTION: Component — Ambient Background                            */
    /* ================================================================ */

    .main-content::before {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.4;
      background:
        radial-gradient(ellipse 60% 50% at 20% 20%, rgba(9, 145, 243, 0.05) 0%, transparent 60%),
        radial-gradient(ellipse 50% 40% at 80% 80%, rgba(246, 174, 45, 0.04) 0%, transparent 55%),
        radial-gradient(ellipse 40% 35% at 50% 50%, rgba(67, 149, 253, 0.03) 0%, transparent 50%);
      background:
        radial-gradient(ellipse 60% 50% at 20% 20%, color-mix(in srgb, var(--optitrack) 5%, transparent) 0%, transparent 60%),
        radial-gradient(ellipse 50% 40% at 80% 80%, color-mix(in srgb, var(--optibiz) 4%, transparent) 0%, transparent 55%),
        radial-gradient(ellipse 40% 35% at 50% 50%, color-mix(in srgb, var(--optidocs) 3%, transparent) 0%, transparent 50%);
      background-size: 200% 200%;
      animation: ambient-gradient 20s ease-in-out infinite;
      will-change: background-position;
    }

    /* ================================================================ */
    /* SECTION: Component — AI Agent Indicator                             */
    /* ================================================================ */

    .ai-indicator {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: 4px 12px;
      margin-top: 2px;
    }

    .ai-indicator__dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--status-online);
      animation: ai-pulse 2s ease-in-out infinite;
      flex-shrink: 0;
    }

    .ai-indicator__text {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* ================================================================ */
    /* SECTION: Component — Tooltip                                      */
    /* ================================================================ */

    .tooltip {
      position: fixed;
      z-index: 1100;
      max-width: 280px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-card-hover);
      padding: 12px 16px;
      pointer-events: none;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 350ms cubic-bezier(0.16, 1, 0.3, 1),
                  transform 150ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .tooltip--visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .tooltip--fading {
      opacity: 0;
      transition: opacity 500ms ease-out;
    }

    .tooltip--below {
      transform: translateY(-6px);
    }

    .tooltip--below.tooltip--visible {
      transform: translateY(0);
    }

    .tooltip__text {
      font-family: var(--font-main);
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-primary);
      direction: rtl;
      text-align: right;
    }

    .tooltip__arrow {
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-top-color: var(--bg-card);
    }

    .tooltip__arrow::after {
      content: '';
      position: absolute;
      bottom: 5px;
      left: -7px;
      width: 0;
      height: 0;
      border: 7px solid transparent;
      border-top-color: var(--border);
      z-index: -1;
    }

    .tooltip--below .tooltip__arrow {
      border-top-color: transparent;
      border-bottom-color: var(--bg-card);
      top: -12px;
      bottom: auto;
    }

    .tooltip--below .tooltip__arrow::after {
      border-top-color: transparent;
      border-bottom-color: var(--border);
      bottom: auto;
      top: 5px;
      left: -7px;
    }

    [data-tooltip] {
      -webkit-touch-callout: none;
      cursor: pointer;
    }

    @media (prefers-reduced-motion: reduce) {
      .tooltip {
        transition-duration: 0.01ms !important;
      }
    }

    /* ================================================================ */
    /* SECTION: Component — AI Agent Insights                            */
    /* ================================================================ */

    .ai-insights {
      padding: 2px 0 4px;
      max-width: 744px;
      margin: 0 auto;
    }

    .ai-insights__title {
      font-family: var(--font-main);
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-align: right;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .ai-insights__title-icon {
      font-size: 13px;
      color: var(--optitrack);
    }

    .ai-insights__grid {
      display: flex;
      flex-direction: column;
      gap: 2px;
      direction: rtl;
    }

    .ai-insight-card {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 6px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 3px 8px;
      cursor: pointer;
      transition: background var(--transition), box-shadow var(--transition),
                  transform var(--transition);
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
    }

    .ai-insight-card::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: auto;
      width: 3px;
      background: var(--insight-accent);
    }

    .ai-insight-card:hover,
    .ai-insight-card:active {
      background: var(--feed-hover);
      box-shadow: var(--shadow-card);
    }

    .ai-insight-card:active {
      transform: scale(0.99);
    }

    .ai-insight-card__icon {
      width: 22px;
      height: 22px;
      min-width: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-on-color);
      flex-shrink: 0;
    }

    .ai-insight-card__name {
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 700;
      color: var(--text-secondary);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .ai-insight-card__text {
      font-family: var(--font-main);
      font-size: 11px;
      line-height: 1.3;
      color: var(--text-primary);
      direction: rtl;
      text-align: right;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0;
    }

    .ai-insight-card__chevron {
      font-size: 12px;
      color: var(--text-muted);
      flex-shrink: 0;
      transition: transform var(--transition);
    }

    .ai-insight-card:hover .ai-insight-card__chevron {
      transform: translateX(-3px);
    }

    /* ================================================================ */
    /* SECTION: Component — AI Chat Panel                                */
    /* ================================================================ */

    .chat-panel-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 350ms cubic-bezier(0.16, 1, 0.3, 1),
                  visibility 350ms;
    }

    .chat-panel-backdrop--active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    .chat-panel {
      position: fixed;
      top: 0;
      inset-inline-start: 0;
      width: 400px;
      height: 100vh;
      height: 100dvh;
      background: var(--bg-card);
      border-inline-end: 1px solid var(--border);
      z-index: 201;
      display: flex;
      flex-direction: column;
      -webkit-transform: translateX(100%);
      transform: translateX(100%);
      opacity: 0;
      pointer-events: none;
      transition: transform 250ms cubic-bezier(0.16, 1, 0.3, 1),
                  opacity 250ms cubic-bezier(0.16, 1, 0.3, 1),
                  -webkit-transform 250ms cubic-bezier(0.16, 1, 0.3, 1);
    }

    .chat-panel--open {
      -webkit-transform: translateX(0);
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
      transition-duration: 350ms;
    }

    .chat-panel__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--gap);
      height: 58px;
      min-height: 58px;
      border-bottom: 1px solid var(--border);
    }

    .chat-panel__header-title {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      font-family: var(--font-main);
      font-weight: 700;
      font-size: 16px;
      color: var(--text-primary);
    }

    .chat-panel__header-title .ti-sparkles {
      color: var(--optitrack);
    }

    .chat-panel__close {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: background 150ms ease, color 150ms ease;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
    }

    .chat-panel__close:active {
      background: rgba(128, 128, 128, 0.15);
      background: color-mix(in srgb, var(--text-muted) 15%, transparent);
      color: var(--text-primary);
    }

    .chat-panel__messages {
      flex: 1;
      overflow-y: auto;
      overscroll-behavior: contain;
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      gap: var(--gap-sm);
    }

    .chat-bubble {
      max-width: 85%;
      padding: var(--gap-sm) var(--gap);
      border-radius: var(--radius);
      font-family: var(--font-main);
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-primary);
      word-wrap: break-word;
    }

    .chat-bubble--user {
      margin-inline-start: auto;
      background: var(--bg-input);
      background: color-mix(in srgb, var(--optitrack) 12%, var(--bg-input));
      border-end-end-radius: var(--radius-sm);
    }

    .chat-bubble--ai {
      margin-inline-end: auto;
      background: var(--bg-input);
      border-end-start-radius: var(--radius-sm);
    }

    .chat-bubble__text {
      direction: rtl;
      text-align: right;
    }

    .chat-bubble--ai .chat-bubble__numeric {
      font-family: var(--font-mono);
      font-weight: 500;
    }

    .chat-bubble__time {
      display: block;
      margin-top: 4px;
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
    }

    .chat-typing {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: var(--gap-sm) var(--gap);
      margin-inline-end: auto;
      background: var(--bg-input);
      border-radius: var(--radius);
      width: fit-content;
    }

    @keyframes chatBounce {
      0%, 80%, 100% { -webkit-transform: translateY(0); transform: translateY(0); }
      40% { -webkit-transform: translateY(-6px); transform: translateY(-6px); }
    }

    .chat-typing__dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      -webkit-animation: chatBounce 1.4s ease-in-out infinite;
      animation: chatBounce 1.4s ease-in-out infinite;
    }

    .chat-typing__dot:nth-child(2) { -webkit-animation-delay: 0.2s; animation-delay: 0.2s; }
    .chat-typing__dot:nth-child(3) { -webkit-animation-delay: 0.4s; animation-delay: 0.4s; }

    .chat-panel__chips {
      display: flex;
      flex-wrap: wrap;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      border-top: 1px solid var(--border);
    }

    .chat-panel__chip {
      min-height: 44px;
      padding: var(--gap-sm) var(--gap);
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: var(--font-main);
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: transform 150ms ease, background 150ms ease;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
      display: flex;
      align-items: center;
      text-align: right;
      direction: rtl;
    }

    .chat-panel__chip:active {
      -webkit-transform: scale(0.98);
      transform: scale(0.98);
      background: var(--bg-input);
      background: color-mix(in srgb, var(--optitrack) 8%, var(--bg-input));
    }

    .chat-panel__input-row {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      border-top: 1px solid var(--border);
    }

    .chat-panel__input {
      flex: 1;
      height: 44px;
      padding: 0 var(--gap);
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: var(--font-main);
      font-size: 14px;
      color: var(--text-primary);
      direction: rtl;
      touch-action: manipulation;
      user-select: auto;
    }

    .chat-panel__input::placeholder {
      color: var(--text-muted);
    }

    .chat-panel__input:focus {
      outline: none;
      border-color: var(--optitrack);
    }

    .chat-panel__send {
      width: 44px;
      height: 44px;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-input);
      background: color-mix(in srgb, var(--optitrack) 15%, var(--bg-input));
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--optitrack);
      cursor: pointer;
      transition: background 150ms ease, opacity 150ms ease;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
    }

    .chat-panel__send:active {
      background: var(--bg-input);
      background: color-mix(in srgb, var(--optitrack) 25%, var(--bg-input));
    }

    .chat-panel__send:disabled {
      opacity: 0.5;
      cursor: default;
    }

    @media (prefers-reduced-motion: reduce) {
      .chat-panel,
      .chat-panel-backdrop {
        transition: none;
      }
      .chat-typing__dot {
        -webkit-animation: none;
        animation: none;
      }
    }

    /* ================================================================ */
    /* SECTION: Animations & Keyframes                                   */
    /* ================================================================ */

    @keyframes stat-card-entrance {
      from {
        opacity: 0;
        transform: translateY(18px) scale(0.97);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes sidebar-pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 0 6px var(--status-online-glow);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.15);
        box-shadow: 0 0 10px var(--status-online-glow);
      }
    }

    @keyframes gauge-pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.85;
      }
    }

    @keyframes ai-pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.4;
        transform: scale(0.7);
      }
    }

    @keyframes ambient-gradient {
      0% {
        background-position: 0% 0%;
      }
      33% {
        background-position: 100% 50%;
      }
      66% {
        background-position: 50% 100%;
      }
      100% {
        background-position: 0% 0%;
      }
    }

    /* ================================================================ */
    /* SECTION: Utilities                                                */
    /* ================================================================ */

    .u-hidden {
      display: none !important;
    }

    .u-rtl-flip {
      transform: scaleX(-1);
    }

    /* ================================================================ */
    /* SECTION: Responsive / Accessibility                               */
    /* ================================================================ */

    /* Reduced motion — accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      .stat-card { transform: none !important; }
      .stat-card__front,
      .stat-card__back { transition: none !important; }
      .hero-gauge__fill { transition: none !important; stroke-dashoffset: 0 !important; }
      .ambient-gradient { animation: none !important; }
    }

    /* SECTION: Component — Rotation/Screen Prompts */
    .viewport-overlay--phone,
    .viewport-overlay--portrait {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: var(--bg-body);
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      direction: rtl;
    }

    .viewport-overlay__icon {
      font-size: 64px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .viewport-overlay__text {
      font-family: var(--font-main);
      font-size: 20px;
      color: var(--text-secondary);
      max-width: 300px;
    }

    /* Portrait iPad — show rotation prompt, hide dashboard */
    @media (orientation: portrait) and (min-width: 768px) {
      .viewport-overlay--portrait { display: flex; }
      .sidebar, main, .chat-panel { display: none !important; }
    }

    /* Small screens (phone) — show mobile warning, hide dashboard */
    @media (max-width: 767px) {
      .viewport-overlay--phone { display: flex; }
      .sidebar, main, .chat-panel { display: none !important; }
    }

    /* Tablet portrait (sidebar collapse) */
    @media (max-width: 1023px) and (min-width: 768px) and (orientation: landscape) {
      .sidebar { width: 60px; }
      .sidebar .sidebar__nav-label,
      .sidebar .sidebar__brand-text,
      .sidebar .sidebar__avatar-info { display: none; }
    }

    /* Touch interaction baseline */
    * {
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Preserve text selection and restore touch defaults in standard text contexts */
    input, textarea, [contenteditable] {
      user-select: text;
      -webkit-user-select: text;
      touch-action: auto;
      -webkit-touch-callout: auto;
    }
  </style>
</head>
<body data-theme="light" data-palette="d" data-skin="1">
  <!-- data-palette and data-skin reserved for future story variants (palettes A-C, skins 2+) -->

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="ניווט ראשי">
    <!-- Sidebar Toggle Button -->
    <div class="sidebar__toggle-wrap">
      <button class="sidebar-toggle" id="sidebarToggle" aria-label="כיווץ/הרחבת סרגל צד">
        <i class="ti ti-layout-sidebar-right-collapse"></i>
      </button>
    </div>

    <!-- Navigation: Modules -->
    <nav class="sidebar__nav">
      <span class="sidebar__section-label">מודולים</span>
      <a class="sidebar__nav-item sidebar__nav-item--active" data-module="dashboard" href="#" role="button" aria-current="page">
        <i class="ti ti-dashboard sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">לוח בקרה</span>
        <span class="sidebar__dot" style="background: var(--optitrack)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optitrack" href="#" role="button">
        <i class="ti ti-chart-dots-3 sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiTrack — תיאומים</span>
        <span class="sidebar__dot" style="background: var(--optitrack)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optibiz" href="#" role="button">
        <i class="ti ti-chart-bar sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiBiz — פיננסי</span>
        <span class="sidebar__dot" style="background: var(--optibiz)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optirisk" href="#" role="button">
        <i class="ti ti-shield-check sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiRisk — סיכונים</span>
        <span class="sidebar__dot" style="background: var(--optirisk)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optidocs" href="#" role="button">
        <i class="ti ti-file-text sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiDocs — מסמכים</span>
        <span class="sidebar__dot" style="background: var(--optidocs)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optigantt" href="#" role="button">
        <i class="ti ti-calendar-event sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiGantt — לוח זמנים</span>
        <span class="sidebar__dot" style="background: var(--optigantt)"></span>
      </a>

      <!-- Tools Section -->
      <span class="sidebar__section-label">כלים</span>
      <a class="sidebar__nav-item" data-module="opium-ai" href="#" role="button">
        <i class="ti ti-robot sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">Opium AI</span>
      </a>
      <div class="ai-indicator" data-tooltip="סוכני AI סורקים מיילים, מסמכים ודוחות — מפיקים תובנות בזמן אמת">
        <span class="ai-indicator__dot"></span>
        <span class="ai-indicator__text">3 סוכנים פעילים</span>
      </div>
      <a class="sidebar__nav-item" data-module="section-map" href="#" role="button">
        <i class="ti ti-map sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">מפת קטעים</span>
      </a>
      <a class="sidebar__nav-item" data-module="reports" href="#" role="button">
        <i class="ti ti-report sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">דוחות</span>
      </a>

      <!-- System Section -->
      <span class="sidebar__section-label">מערכת</span>
      <a class="sidebar__nav-item" data-module="settings" href="#" role="button">
        <i class="ti ti-settings sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">הגדרות</span>
      </a>
    </nav>

    <!-- User Avatar (above toggle) -->
    <div class="sidebar__avatar">
      <div class="sidebar__avatar-circle">בע</div>
      <div class="sidebar__avatar-info">
        <span class="sidebar__avatar-name">בן עקיבא</span>
        <span class="sidebar__avatar-role">מנהל פרויקט</span>
      </div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle" role="button" aria-label="החלפת ערכת נושא" tabindex="0">
      <div class="theme-toggle__track" aria-hidden="true">
        <div class="theme-toggle__knob"></div>
      </div>
      <span class="theme-toggle__label">ערכת נושא</span>
    </div>

    <!-- Footer -->
    <div class="sidebar__footer">
      <span class="sidebar__footer-dot"></span>
      <span class="sidebar__footer-api">API 18ms</span>
      <span class="sidebar__footer-version">v2.4.1</span>
    </div>
  </aside>

  <!-- Main content area -->
  <div class="main-content">
    <!-- Topbar -->
    <header class="topbar" aria-label="סרגל עליון">
      <div class="topbar__brand">
        <img class="topbar__brand-logo" src="user-data/LOGO-ICON.png" alt="OptiPlan Logo" width="40" height="40" decoding="async">
        <div class="topbar__title-block">
          <span class="topbar__title" lang="en" dir="ltr">OptiPlan</span>
          <span class="topbar__subtitle">מרכז בקרה</span>
        </div>
      </div>
      <div class="topbar__actions">
        <span class="topbar__clock" id="topbarClock"></span>
        <div class="topbar__search">
          <i class="ti ti-search topbar__search-icon"></i>
          <span class="topbar__search-text">חיפוש...</span>
        </div>
        <div class="topbar__bell">
          <i class="ti ti-bell"></i>
          <span class="topbar__bell-badge"></span>
        </div>
      </div>
    </header>

    <!-- Primary content region (hero gauges, stat cards etc. added in Stories 1.4–1.5) -->
    <main id="mainRegion">
      <!-- Hero Gauges — 3 animated SVG ring gauges (Story 1.4) -->
      <section class="hero-gauges">
        <!-- Values must match PROJECT_DATA/module_DATA constants -->
        <div class="hero-gauge" data-gauge="financial" data-tooltip="ניטור התקדמות תקציבית ב-₪1.8 מיליארד תקציב — סטיות מזוהות בזמן אמת">
          <svg class="hero-gauge__svg" viewBox="0 0 120 120">
            <circle class="hero-gauge__track" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" />
            <circle class="hero-gauge__fill" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" stroke-linecap="round"
                    transform="rotate(-90 60 60)" />
            <text class="hero-gauge__value" x="60" y="60"
                  text-anchor="middle" dominant-baseline="central"></text>
          </svg>
          <span class="hero-gauge__label">התקדמות תקציבית</span>
        </div>
        <div class="hero-gauge" data-gauge="coordination" data-tooltip="תיאום עם 5 רשויות ממשלתיות — בפלטפורמה אחת">
          <svg class="hero-gauge__svg" viewBox="0 0 120 120">
            <circle class="hero-gauge__track" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" />
            <circle class="hero-gauge__fill" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" stroke-linecap="round"
                    transform="rotate(-90 60 60)" />
            <text class="hero-gauge__value" x="60" y="60"
                  text-anchor="middle" dominant-baseline="central"></text>
          </svg>
          <span class="hero-gauge__label">השלמת תיאומים</span>
        </div>
        <div class="hero-gauge" data-gauge="schedule" data-tooltip="מעקב לוחות זמנים ב-6 קטעי ביצוע — חריגות מזוהות אוטומטית">
          <svg class="hero-gauge__svg" viewBox="0 0 120 120">
            <circle class="hero-gauge__track" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" />
            <circle class="hero-gauge__fill" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" stroke-linecap="round"
                    transform="rotate(-90 60 60)" />
            <text class="hero-gauge__value" x="60" y="60"
                  text-anchor="middle" dominant-baseline="central"></text>
          </svg>
          <span class="hero-gauge__label">עמידה בלוח זמנים</span>
        </div>
      </section>

      <!-- Stat Cards — 5 module KPI cards (Story 1.5, flip added Story 2.1) -->
      <section class="stat-cards-row">
        <!-- Values must match *_DATA constants -->
        <div class="stat-card" data-module="optitrack" data-tooltip="בקרת תיאומים — 347 פריטים מול 5 רשויות, מכל הקטעים" style="opacity: 0; transform: translateY(18px) scale(0.97);">
          <div class="stat-card__front">
            <span class="stat-card__name">OptiTrack</span>
            <span class="stat-card__value"></span>
            <span class="stat-card__label"></span>
            <span class="stat-card__sublabel"></span>
            <i class="stat-card__icon ti ti-route"></i>
          </div>
          <div class="stat-card__back">
            <div class="stat-card__back-header"><span class="stat-card__back-title">OptiTrack</span></div>
            <div class="stat-card__back-kpis">
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
            </div>
            <button class="stat-card__back-cta">למודול המלא</button>
          </div>
        </div>
        <div class="stat-card" data-module="optibiz" data-tooltip="ניהול תזרים מזומנים — תכנון מול ביצוע, חודש בחודש" style="opacity: 0; transform: translateY(18px) scale(0.97);">
          <div class="stat-card__front">
            <span class="stat-card__name">OptiBiz</span>
            <span class="stat-card__value"></span>
            <span class="stat-card__label"></span>
            <span class="stat-card__sublabel"></span>
            <i class="stat-card__icon ti ti-chart-bar"></i>
          </div>
          <div class="stat-card__back">
            <div class="stat-card__back-header"><span class="stat-card__back-title">OptiBiz</span></div>
            <div class="stat-card__back-kpis">
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
            </div>
            <button class="stat-card__back-cta">למודול המלא</button>
          </div>
        </div>
        <div class="stat-card" data-module="optirisk" data-tooltip="מיפוי סיכונים — 23 סיכונים פעילים, 8 קריטיים, עם מגמות" style="opacity: 0; transform: translateY(18px) scale(0.97);">
          <div class="stat-card__front">
            <span class="stat-card__name">OptiRisk</span>
            <span class="stat-card__value"></span>
            <span class="stat-card__label"></span>
            <span class="stat-card__sublabel"></span>
            <i class="stat-card__icon ti ti-alert-triangle"></i>
          </div>
          <div class="stat-card__back">
            <div class="stat-card__back-header"><span class="stat-card__back-title">OptiRisk</span></div>
            <div class="stat-card__back-kpis">
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
            </div>
            <button class="stat-card__back-cta">למודול המלא</button>
          </div>
        </div>
        <div class="stat-card" data-module="optidocs" data-tooltip="מעקב מסמכים ומשימות — 847 פריטים, 94% הושלמו" style="opacity: 0; transform: translateY(18px) scale(0.97);">
          <div class="stat-card__front">
            <span class="stat-card__name">OptiDocs</span>
            <span class="stat-card__value"></span>
            <span class="stat-card__label"></span>
            <span class="stat-card__sublabel"></span>
            <i class="stat-card__icon ti ti-file-text"></i>
          </div>
          <div class="stat-card__back">
            <div class="stat-card__back-header"><span class="stat-card__back-title">OptiDocs</span></div>
            <div class="stat-card__back-kpis">
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
            </div>
            <button class="stat-card__back-cta">למודול המלא</button>
          </div>
        </div>
        <div class="stat-card" data-module="optigantt" data-tooltip="לוח זמנים גאנט — 6 קטעים, אבני דרך, ניתוח חריגות" style="opacity: 0; transform: translateY(18px) scale(0.97);">
          <div class="stat-card__front">
            <span class="stat-card__name">OptiGantt</span>
            <span class="stat-card__value"></span>
            <span class="stat-card__label"></span>
            <span class="stat-card__sublabel"></span>
            <i class="stat-card__icon ti ti-calendar-stats"></i>
          </div>
          <div class="stat-card__back">
            <div class="stat-card__back-header"><span class="stat-card__back-title">OptiGantt</span></div>
            <div class="stat-card__back-kpis">
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
              <div class="stat-card__kpi-row"><span class="stat-card__kpi-label"></span><span class="stat-card__kpi-value"></span><span class="stat-card__kpi-trend"></span></div>
            </div>
            <button class="stat-card__back-cta">למודול המלא</button>
          </div>
        </div>
      </section>

      <!-- AI Agent Insights — Clickable notification feed (Story A2) -->
      <section class="ai-insights">
        <div class="ai-insights__title">
          <i class="ti ti-sparkles ai-insights__title-icon"></i>
          תובנות סוכני AI
        </div>
        <div class="ai-insights__grid">
          <div class="ai-insight-card" style="--insight-accent: #FF7A3C;"
               data-insight-context="זוהו 3 סיכונים חדשים בממשק עם רשות המים. פרט את הסיכונים והמלצות לטיפול.">
            <div class="ai-insight-card__icon" style="background: #FF7A3C;"><i class="ti ti-shield-check"></i></div>
            <span class="ai-insight-card__name">סוכן סיכונים</span>
            <p class="ai-insight-card__text">זוהו 3 סיכונים חדשים בממשק עם רשות המים — נדרשת תשומת לב מיידית</p>
            <i class="ti ti-chevron-left ai-insight-card__chevron"></i>
          </div>
          <div class="ai-insight-card" style="--insight-accent: #F6AE2D;"
               data-insight-context="חריגה תקציבית של 2.3% צפויה ברבעון הבא. מהן הסיבות והמלצות?">
            <div class="ai-insight-card__icon" style="background: #F6AE2D;"><i class="ti ti-chart-bar"></i></div>
            <span class="ai-insight-card__name">סוכן פיננסי</span>
            <p class="ai-insight-card__text">חריגה תקציבית של 2.3% צפויה ברבעון הבא — מומלץ לעדכן תחזית</p>
            <i class="ti ti-chevron-left ai-insight-card__chevron"></i>
          </div>
          <div class="ai-insight-card" style="--insight-accent: #0991F3;"
               data-insight-context="4 משימות תיאום עם חברת החשמל בעיכוב של מעל שבועיים. מהן המשימות וסטטוס הטיפול?">
            <div class="ai-insight-card__icon" style="background: #0991F3;"><i class="ti ti-arrows-exchange"></i></div>
            <span class="ai-insight-card__name">סוכן תיאומים</span>
            <p class="ai-insight-card__text">4 משימות תיאום עם חברת החשמל נמצאות בעיכוב של מעל שבועיים</p>
            <i class="ti ti-chevron-left ai-insight-card__chevron"></i>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Module Expansion Overlay (Layer 3) -->
  <div class="module-overlay-backdrop"></div>
  <div class="module-overlay" role="dialog" aria-modal="true" aria-label="Module detail view">
    <div class="module-overlay__header">
      <i class="module-overlay__icon ti"></i>
      <div class="module-overlay__header-text">
        <span class="module-overlay__title"></span>
        <span class="module-overlay__subtitle"></span>
      </div>
      <button class="module-overlay__back" aria-label="Back to dashboard">
        <i class="ti ti-arrow-right"></i>
      </button>
    </div>
    <div class="module-overlay__content"></div>
  </div>

  <!-- AI Chat Panel -->
  <div class="chat-panel-backdrop" id="chatBackdrop"></div>
  <div class="chat-panel" id="chatPanel" role="dialog" aria-modal="true" aria-label="Opium AI Chat">
    <div class="chat-panel__header">
      <div class="chat-panel__header-title">
        <i class="ti ti-sparkles"></i>
        <span>Opium AI</span>
      </div>
      <button class="chat-panel__close" id="chatClose" aria-label="סגירת צ'אט">
        <i class="ti ti-x"></i>
      </button>
    </div>
    <div class="chat-panel__messages" id="chatMessages"></div>
    <div class="chat-panel__chips" id="chatChips"></div>
    <div class="chat-panel__input-row">
      <input type="text" class="chat-panel__input" id="chatInput" placeholder="שאלו על הפרויקט..." autocomplete="off">
      <button class="chat-panel__send" id="chatSend" aria-label="שליחת הודעה">
        <i class="ti ti-send"></i>
      </button>
    </div>
  </div>

  <!-- Rotation prompt for portrait orientation -->
  <div class="viewport-overlay--portrait" role="alert" aria-live="polite">
    <i class="ti ti-device-ipad-horizontal viewport-overlay__icon"></i>
    <p class="viewport-overlay__text">אנא סובב את המכשיר למצב לרוחב</p>
  </div>
  <!-- Small screen warning -->
  <div class="viewport-overlay--phone" role="alert" aria-live="polite">
    <i class="ti ti-device-ipad viewport-overlay__icon"></i>
    <p class="viewport-overlay__text">הדשבורד מותאם למסך iPad לרוחב</p>
  </div>

  <script>
    // ================================================================
    // SECTION: Configuration Constants
    // ================================================================

    const IDLE_TIMEOUT_MS = 90000;
    const MAX_CHAT_HISTORY = 5;
    const API_KEY = '';
    const LLM_API_URL = 'https://api.anthropic.com/v1/messages';
    const LLM_MODEL = 'claude-sonnet-4-5-20250514';
    const LLM_TIMEOUT_MS = 8000;
    const LLM_MAX_TOKENS = 512;

    // ================================================================
    // SECTION: Data Constants
    // ================================================================

    const PROJECT_DATA = {
      projectName: 'הרחבת קו מטרו, גוש דן',
      projectSubtitle: 'קו M1 — מת"א מרכז לפ"ת',
      client: 'נת"ע',
      projectId: 'NTA-M1-2022',
      totalBudget: 1800000000,
      currency: 'NIS',
      startDate: '2022-04-01',
      targetEndDate: '2027-12-31',
      // Section IDs and progress must match OPTIGANTT_DATA.sections
      sections: [
        { id: 'a1', name: 'תל אביב מרכז – גבעתיים', phase: 'complete', progress: 100 },
        { id: 'a2', name: 'גבעתיים – רמת גן', phase: 'execution', progress: 78 },
        { id: 'a3', name: 'רמת גן – בני ברק', phase: 'execution', progress: 52 },
        { id: 'a4', name: 'בני ברק – פתח תקווה', phase: 'planning', progress: 31 },
        { id: 'a5', name: 'פתח תקווה מרכז – שרונה', phase: 'planning', progress: 15 },
        { id: 'a6', name: 'שרונה – גוש דן מזרח', phase: 'design', progress: 8 }
      ]
    };

    const OPTITRACK_DATA = {
      totalItems: 347,
      approved: 222,
      // Derived: approved / totalItems * 100 (rounded)
      approvalRate: 64,
      pending: 35,
      objections: 12,
      inReview: 78,
      // Monthly change rate displayed on stat card sublabel
      growthRate: 18,
      authorities: [
        { name: 'עירייה', nameEn: 'Municipality', total: 89, approved: 62, pending: 14, objections: 4, inReview: 9, trafficLicensing: 'אושר' },
        { name: 'חברת חשמל', nameEn: 'Israel Electric Corp', total: 72, approved: 51, pending: 8, objections: 3, inReview: 10, trafficLicensing: 'בתהליך' },
        { name: 'מקורות', nameEn: 'Water Authority', total: 68, approved: 45, pending: 7, objections: 3, inReview: 13, trafficLicensing: 'אושר' },
        { name: 'בזק', nameEn: 'Communications', total: 61, approved: 40, pending: 4, objections: 2, inReview: 15, trafficLicensing: 'ממתין' },
        { name: 'רשות העתיקות', nameEn: 'Antiquities Authority', total: 57, approved: 24, pending: 2, objections: 0, inReview: 31, trafficLicensing: 'לא הוגש' }
      ],
      // Traffic arrangements & licensing data per section
      trafficLicensing: [
        { section: 'א1', status: 'אושר', authority: 'עירייה', details: 'הסדר תנועה מלא — רישיון תפוסה הונפק' },
        { section: 'א2', status: 'בתהליך', authority: 'עירייה + חברת חשמל', details: 'הסדר תנועה חלקי — ממתין לאישור סופי' },
        { section: 'א3', status: 'בתהליך', authority: 'עירייה + מקורות', details: 'תוכנית הסדרי תנועה הוגשה — ממתין לבדיקה' },
        { section: 'א4', status: 'ממתין', authority: 'עירייה', details: 'הגשה צפויה ברבעון הבא' },
        { section: 'א5', status: 'לא הוגש', authority: '—', details: 'טרם הגיע למועד הגשה' },
        { section: 'א6', status: 'לא הוגש', authority: '—', details: 'טרם הגיע למועד הגשה' }
      ],
      permitMatrix: [
        { section: 'a1', statuses: ['approved','approved','approved','approved','approved'] },
        { section: 'a2', statuses: ['approved','approved','approved','pending','objection'] },
        { section: 'a3', statuses: ['approved','approved','in-review','pending','objection'] },
        { section: 'a4', statuses: ['in-review','in-review','pending','pending','not-submitted'] },
        { section: 'a5', statuses: ['pending','not-submitted','not-submitted','not-submitted','not-submitted'] },
        { section: 'a6', statuses: ['not-submitted','not-submitted','not-submitted','not-submitted','not-submitted'] }
      ],
      activityFeed: [
        { id: 1, initials: 'ד.ל', name: 'דניאלה לוי', timestamp: 'לפני 3 דק׳', description: 'אישור עיריית גבעתיים לפריסת תשתית קטע א2', status: 'approved' },
        { id: 2, initials: 'מ.כ', name: 'מיכאל כהן', timestamp: 'לפני 18 דק׳', description: 'הגשת בקשה לרשות העתיקות — קטע א3 חפירות', status: 'pending' },
        { id: 3, initials: 'א.ש', name: 'אביטל שמאי', timestamp: 'לפני 42 דק׳', description: 'התנגדות חברת חשמל לתנאי חציית מנהרה קטע א2', status: 'objection' },
        { id: 4, initials: 'ר.ב', name: 'רונן בן-דוד', timestamp: 'לפני 1:15 שע׳', description: 'חתימת הסכם תיאום עם מקורות — קטע א1 הושלם', status: 'approved' },
        { id: 5, initials: 'נ.פ', name: 'נטע פרידמן', timestamp: 'לפני 2:30 שע׳', description: 'בדיקת ביניים בזק — חוות דעת מקצועית בהכנה', status: 'in-review' },
        { id: 6, initials: 'י.ג', name: 'יובל גרין', timestamp: 'לפני 4 שע׳', description: 'פגישת תיאום עם נציגי עירייה — לוח זמנים קטע א4', status: 'in-review' }
      ]
    };

    const OPTIBIZ_DATA = {
      // Must equal PROJECT_DATA.totalBudget
      budgetTotal: 1800000000,
      budgetUtilized: 1220000000,
      // Derived: budgetUtilized / budgetTotal * 100 (rounded)
      budgetUtilization: 68,
      burnRate: 101666667,
      variance: -22000000,
      monthLabels: ['ינו׳','פבר׳','מרץ','אפר׳','מאי','יונ׳','יול׳','אוג׳','ספט׳','אוק׳','נוב׳','דצמ׳'],
      cashFlow: [
        { month: 'ינו׳', plan: 100000000, actual: 72000000 },
        { month: 'פבר׳', plan: 118000000, actual: 85000000 },
        { month: 'מרץ',  plan: 138000000, actual: 98000000 },
        { month: 'אפר׳', plan: 150000000, actual: 110000000 },
        { month: 'מאי',  plan: 160000000, actual: 118000000 },
        { month: 'יונ׳', plan: 165000000, actual: 125000000 },
        { month: 'יול׳', plan: 168000000, actual: 128000000 },
        { month: 'אוג׳', plan: 175000000, actual: 135000000 },
        { month: 'ספט׳', plan: 168000000, actual: 130000000 },
        { month: 'אוק׳', plan: 162000000, actual: 122000000 },
        { month: 'נוב׳', plan: 152000000, actual: 55000000 },
        { month: 'דצמ׳', plan: 144000000, actual: 42000000 }
      ]
    };

    const OPTIRISK_DATA = {
      activeRisks: 23,
      critical: 8,
      heatMap: [
        [0, 1, 0, 0, 0],
        [1, 2, 1, 0, 0],
        [0, 2, 2, 1, 0],
        [0, 1, 3, 2, 2],
        [0, 0, 1, 2, 2]
      ],
      probLabels: ['נמוכה', 'נמוכה-בינונית', 'בינונית', 'בינונית-גבוהה', 'גבוהה'],
      impactLabels: ['נמוכה', 'נמוכה-בינונית', 'בינונית', 'גבוהה', 'קריטי'],
      topRisks: [
        { id: 1, name: 'עיכובי רשות העתיקות — קטע א4', severity: 'critical', trend: 'up', mitigation: 'active', prob: 4, impact: 5 },
        { id: 2, name: 'עלייה בעלות חומרי גלם וחציבה', severity: 'critical', trend: 'up', mitigation: 'monitoring', prob: 5, impact: 4 },
        { id: 3, name: 'מחלוקות קנין — קטע א3', severity: 'critical', trend: 'stable', mitigation: 'legal-review', prob: 4, impact: 4 },
        { id: 4, name: 'מחסור בכוח אדם מהנדסים', severity: 'high', trend: 'down', mitigation: 'resolved', prob: 3, impact: 4 },
        { id: 5, name: 'סיכוני ממשק בין-קבלני — קטע א2/א3', severity: 'high', trend: 'up', mitigation: 'active', prob: 4, impact: 3 },
        { id: 6, name: 'אי עמידה בלוח זמנים — קטע א5', severity: 'high', trend: 'up', mitigation: 'monitoring', prob: 5, impact: 3 }
      ]
    };

    const OPTIDOCS_DATA = {
      total: 847,
      approved: 796,
      // Derived: approved / total * 100 (rounded)
      completionRate: 94,
      pending: 38,
      overdue: 13,
      documents: [
        { id: 'D001', name: 'תוכנית בינוי קטע א1', type: 'תוכנית', status: 'approved', date: '2024-03-15', assignee: 'ד.ל' },
        { id: 'D002', name: 'דוח סקר קרקע א2', type: 'דוח', status: 'approved', date: '2024-05-22', assignee: 'מ.כ' },
        { id: 'D003', name: 'היתר בנייה א3 — שלב א', type: 'היתר', status: 'pending', date: '2024-09-10', assignee: 'א.ש' },
        { id: 'D004', name: 'תסקיר השפעה על הסביבה', type: 'תסקיר', status: 'approved', date: '2024-01-30', assignee: 'ר.ב' },
        { id: 'D005', name: 'חוזה קבלן ראשי — קטע א4', type: 'חוזה', status: 'approved', date: '2024-07-08', assignee: 'נ.פ' },
        { id: 'D006', name: 'בקשת שינוי — מנהרה א3', type: 'בקשת שינוי', status: 'overdue', date: '2024-10-01', assignee: 'י.ג' },
        { id: 'D007', name: 'תוכנית ניהול בטיחות א2', type: 'תוכנית', status: 'approved', date: '2024-04-18', assignee: 'ד.ל' },
        { id: 'D008', name: 'פרוטוקול בדיקת איכות א1', type: 'פרוטוקול', status: 'approved', date: '2024-06-30', assignee: 'מ.כ' }
      ]
    };

    const OPTIGANTT_DATA = {
      sections: [
        { id: 'a1', name: 'תל אביב מרכז – גבעתיים', plannedStart: '2022-04-01', plannedEnd: '2024-06-30', actualStart: '2022-04-01', actualEnd: '2024-07-15', progress: 100 },
        { id: 'a2', name: 'גבעתיים – רמת גן', plannedStart: '2023-01-01', plannedEnd: '2025-03-31', actualStart: '2023-01-15', actualEnd: null, progress: 78 },
        { id: 'a3', name: 'רמת גן – בני ברק', plannedStart: '2023-07-01', plannedEnd: '2025-12-31', actualStart: '2023-08-01', actualEnd: null, progress: 52 },
        { id: 'a4', name: 'בני ברק – פתח תקווה', plannedStart: '2024-01-01', plannedEnd: '2026-06-30', actualStart: '2024-03-01', actualEnd: null, progress: 31 },
        { id: 'a5', name: 'פתח תקווה מרכז – שרונה', plannedStart: '2024-07-01', plannedEnd: '2027-03-31', actualStart: '2024-10-01', actualEnd: null, progress: 15 },
        { id: 'a6', name: 'שרונה – גוש דן מזרח', plannedStart: '2025-01-01', plannedEnd: '2027-12-31', actualStart: '2025-03-01', actualEnd: null, progress: 8 }
      ],
      milestones: [
        { date: '2024-07-15', label: 'השלמת קטע א1', section: 'a1', type: 'completion' },
        { date: '2025-06-30', label: 'בדיקות הפעלה — שלב א', section: 'a2', type: 'review' },
        { date: '2026-12-31', label: 'תחילת הפעלה מסחרית', section: 'a4', type: 'launch' },
        { date: '2027-12-31', label: 'השלמת פרויקט', section: 'a6', type: 'completion' }
      ]
    };

    const AI_CACHE = {
      'תקציב': {
        question: 'מה המצב התקציבי של הפרויקט?',
        answer: 'פרויקט הרחבת קו המטרו עומד על תקציב כולל של 1.8 מיליארד ₪. נכון להיום, נוצל 1.22 מיליארד ₪ — שיעור ניצול של 68%. הפרויקט נמצא מתחת לתקציב המתוכנן בכ-22 מיליון ₪, המעיד על ניהול פיננסי יעיל.'
      },
      'לוח זמנים': {
        question: 'האם הפרויקט עומד בלוח הזמנים?',
        answer: 'הפרויקט מציג ביצועי לוח זמנים מעורבים: קטע א1 הושלם בהצלחה, קטע א2 מתקדם ב-78%, וקטע א3 ב-52%. קטעים א4–א6 בשלבי תכנון ועיצוב. לוח הזמנים הכולל — פיניש דצמבר 2027 — נשמר.'
      },
      'סיכונים': {
        question: 'מהם הסיכונים הקריטיים של הפרויקט?',
        answer: 'זוהו 23 סיכונים פעילים, מתוכם 8 סיכונים קריטיים. הסיכונים המשמעותיים ביותר: עיכובי רשות העתיקות בקטע א4, עלייה בעלות חומרי גלם, ומחלוקות קנין בקטע א3. כל הסיכונים הקריטיים מנוהלים אקטיבית עם תוכניות מיטיגציה.'
      },
      'תיאומים': {
        question: 'מה מצב התיאומים עם הרשויות?',
        answer: 'מתוך 347 פריטי תיאום עם 5 רשויות, 222 אושרו (64%), 35 ממתינים לאישור, ו-12 נמצאים בהתנגדות. רשות העתיקות מציגה את קצב האישור האיטי ביותר — מה שמשפיע ישירות על קטע א4.'
      },
      'קטע א3': {
        question: 'מה מצב קטע א3?',
        answer: 'קטע א3 (רמת גן – בני ברק) מתקדם ב-52% ביחס לתכנון. שלב הביצוע החל באוגוסט 2023, עם תאריך יעד לסיום בסוף 2025. האתגרים הנוכחיים: מחלוקות קנין שנמצאות בבדיקה משפטית ותיאומים עם רשות העתיקות.'
      },
      'ניצול תקציב': {
        question: 'מה שיעור ניצול התקציב?',
        answer: 'שיעור ניצול התקציב עומד על 68% — 1.22 מיליארד ₪ מתוך 1.8 מיליארד ₪. קצב השריפה החודשי הממוצע הוא כ-102 מיליון ₪. בהינתן לוח הזמנים הנוכחי, הפרויקט צפוי לסיים בתוך המסגרת התקציבית.'
      },
      'הצלחה': {
        question: 'האם הפרויקט יצליח?',
        answer: 'על בסיס נתוני פרויקט הרחבת קו המטרו, המדדים מצביעים על מגמה חיובית: קטע א1 הושלם בהצלחה, הניצול התקציבי ביחס לתכנון תקין, ו-64% מהתיאומים עם רשויות אושרו. הפרויקט מציג בשלות תפעולית גבוהה ועמידה ביעדיו העיקריים.'
      },
      'הישגים': {
        question: 'מה ההישגים העיקריים עד כה?',
        answer: 'ההישגים הבולטים: (1) השלמת מלאה של קטע א1 — 17 ק"מ של תשתית מטרו. (2) 222 אישורים רגולטוריים מ-5 רשויות שונות. (3) שמירה על תקציב עם חיסכון של 22 מיליון ₪. (4) קצב בנייה של קטע א2 עולה על התחזית ב-3%.'
      }
    };

    // Freeze all data constants to enforce read-only access at runtime
    Object.freeze(PROJECT_DATA);
    Object.freeze(PROJECT_DATA.sections);
    Object.freeze(OPTITRACK_DATA);
    Object.freeze(OPTITRACK_DATA.authorities);
    Object.freeze(OPTITRACK_DATA.permitMatrix);
    Object.freeze(OPTITRACK_DATA.activityFeed);
    Object.freeze(OPTITRACK_DATA.trafficLicensing);
    Object.freeze(OPTIBIZ_DATA);
    Object.freeze(OPTIBIZ_DATA.cashFlow);
    Object.freeze(OPTIRISK_DATA);
    Object.freeze(OPTIRISK_DATA.heatMap);
    Object.freeze(OPTIRISK_DATA.topRisks);
    Object.freeze(OPTIDOCS_DATA);
    Object.freeze(OPTIDOCS_DATA.documents);
    Object.freeze(OPTIGANTT_DATA);
    Object.freeze(OPTIGANTT_DATA.sections);
    Object.freeze(OPTIGANTT_DATA.milestones);
    Object.freeze(AI_CACHE);

    // Data lookup map (const declarations aren't on window object)
    var MODULE_DATA = {
      OPTITRACK_DATA: OPTITRACK_DATA,
      OPTIBIZ_DATA: OPTIBIZ_DATA,
      OPTIRISK_DATA: OPTIRISK_DATA,
      OPTIDOCS_DATA: OPTIDOCS_DATA,
      OPTIGANTT_DATA: OPTIGANTT_DATA
    };

    // ================================================================
    // SECTION: OptiPlan Namespace & State Management
    // ================================================================

    const _ALLOWED_TRANSITIONS = {
      'idle':          ['overview'],
      'overview':      ['card-flip', 'module-expand', 'idle'],
      'card-flip':     ['overview', 'module-expand'],
      'module-expand': ['overview', 'module-expand']
    };

    const OptiPlan = {
      state: {
        currentLayer: 'idle',
        activeModule: null,
        activeCard: null,
        theme: 'light',
        _idleTimer: null,
        _clockInterval: null,

        transition: function(targetLayer) {
          var allowed = _ALLOWED_TRANSITIONS[this.currentLayer];
          if (!allowed || !allowed.includes(targetLayer)) {
            console.warn('[OptiPlan State] Invalid transition:', this.currentLayer, '→', targetLayer);
            return false;
          }
          this.currentLayer = targetLayer;
          OptiPlan.ui.reflectLayer(targetLayer);
          return true;
        },

        set: function(key, value) {
          this[key] = value;
          OptiPlan.ui.reflect(key, value);
        }
      },

      components: {},
      animations: {},
      modules: {},
      ai: {},
      touch: {},
      utils: {},
      data: {},
      ui: {}
    };

    // ================================================================
    // SECTION: Utility Functions
    // ================================================================

    OptiPlan.utils.formatCurrency = function(amount) {
      if (typeof amount !== 'number' || isNaN(amount)) {
        console.warn('[OptiPlan Utils] Invalid currency amount:', amount);
        return '';
      }
      return new Intl.NumberFormat('he-IL').format(amount);
    };

    OptiPlan.utils.formatCurrencyShort = function(amount, forceScale) {
      if (typeof amount !== 'number' || isNaN(amount)) {
        console.warn('[OptiPlan Utils] Invalid currency amount:', amount);
        return '';
      }
      var abs = Math.abs(amount);
      if (abs === 0) return '\u20AA0';
      if (forceScale === 'B' || (!forceScale && abs >= 1000000000)) {
        return '\u20AA' + (abs / 1000000000).toFixed(2) + 'B';
      }
      return '\u20AA' + Math.round(abs / 1000000) + 'M';
    };

    OptiPlan.utils.formatPercent = function(value) {
      if (typeof value !== 'number' || isNaN(value)) {
        console.warn('[OptiPlan Utils] Invalid percent value:', value);
        return '';
      }
      return `${value}%`;
    };

    OptiPlan.utils.formatDate = function(dateStr) {
      if (!dateStr || isNaN(new Date(dateStr))) {
        console.warn('[OptiPlan Utils] Invalid date string:', dateStr);
        return '';
      }
      var d = new Date(dateStr);
      var day   = String(d.getDate()).padStart(2, '0');
      var month = String(d.getMonth() + 1).padStart(2, '0');
      var year  = String(d.getFullYear()).slice(-2);
      return `${day}/${month}/${year}`;
    };

    // ================================================================
    // SECTION: Session Diagnostics (callable from Safari Web Inspector)
    // ================================================================

    OptiPlan.utils.sessionDiagnostics = function() {
      var componentCount = 0;
      var totalTracked = 0;
      var componentNames = Object.keys(OptiPlan.components);
      totalTracked = componentNames.length;
      for (var c = 0; c < componentNames.length; c++) {
        if (OptiPlan.components[componentNames[c]]._initialized) {
          componentCount++;
        }
      }
      // Also count OptiPlan.touch and OptiPlan.ai (not under components namespace)
      totalTracked += 2;
      if (OptiPlan.touch && OptiPlan.touch._initialized) componentCount++;
      if (OptiPlan.ai && OptiPlan.ai._initialized) componentCount++;

      var activeTimers = 0;
      if (OptiPlan.state._clockInterval) activeTimers++;
      if (OptiPlan.state._idleTimer) activeTimers++;
      if (OptiPlan.components.heroGauges._fillTimeout) activeTimers++;
      if (OptiPlan.components.heroGauges._pulseTimeout) activeTimers++;
      if (OptiPlan.components.moduleOverlay._transitionTimeouts.length > 0) {
        activeTimers += OptiPlan.components.moduleOverlay._transitionTimeouts.length;
      }
      if (OptiPlan.ai._responseTimeout) activeTimers++;

      var domCount = document.querySelectorAll('*').length;
      var chatBubbles = document.querySelectorAll('.chat-bubble').length;
      var uptime = Math.round((Date.now() - window._optiplanLoadTime) / 1000);

      var diag = {
        currentLayer: OptiPlan.state.currentLayer,
        activeModule: OptiPlan.state.activeModule,
        chatOpen: OptiPlan.state.chatOpen,
        theme: document.body.getAttribute('data-theme'),
        initializedComponents: componentCount + '/' + totalTracked,
        activeTimers: activeTimers,
        chatHistoryLength: OptiPlan.ai.history.length,
        chatBubblesInDOM: chatBubbles,
        domElementCount: domCount,
        uptimeSeconds: uptime,
        uptimeFormatted: Math.floor(uptime / 3600) + 'h ' + Math.floor((uptime % 3600) / 60) + 'm ' + (uptime % 60) + 's'
      };

      console.log('[OptiPlan Diagnostics]', JSON.stringify(diag, null, 2));
      return diag;
    };

    // Store load timestamp for uptime tracking
    window._optiplanLoadTime = Date.now();

    // Manual test checklist helper — callable from console
    OptiPlan.utils.runTestChecklist = function() {
      var checks = [
        '1. Page load: first paint <1s, fully interactive <2s',
        '2. All 5 stat cards visible with correct data',
        '3. Theme toggle: dark \u2192 light \u2192 dark works',
        '4. Card flip: tap any card, verify flip animation smooth',
        '5. Module expansion: tap CTA, verify overlay opens',
        '6. Back button: verify overlay closes on hardware back',
        '7. Sidebar nav: tap each module, verify correct overlay',
        '8. AI chat: open panel, send message, receive response',
        '9. Idle reset: wait 90s, verify return to clean state',
        '10. 10-minute stability: interact for 10 minutes, verify no degradation'
      ];
      console.log('[OptiPlan Test Checklist] Manual verification steps:');
      for (var i = 0; i < checks.length; i++) {
        console.log('  [ ] ' + checks[i]);
      }
      console.log('\nRun OptiPlan.utils.sessionDiagnostics() to check current state.');
      return checks;
    };

    // ================================================================
    // SECTION: UI Reflection Layer
    // ================================================================

    OptiPlan.ui.reflectLayer = function(layer) {
      // Stub — expanded by future stories
      // No logging on valid transitions; only log in error paths
    };

    OptiPlan.ui.reflect = function(key, value) {
      // Stub — expanded by future stories
      if (key === 'theme') {
        document.body.setAttribute('data-theme', value);
      }
      if (key === 'chatOpen') {
        var $panel = document.getElementById('chatPanel');
        var $backdrop = document.getElementById('chatBackdrop');
        if (value) {
          if ($panel) $panel.classList.add('chat-panel--open');
          if ($backdrop) $backdrop.classList.add('chat-panel-backdrop--active');
        } else {
          if ($panel) $panel.classList.remove('chat-panel--open');
          if ($backdrop) $backdrop.classList.remove('chat-panel-backdrop--active');
        }
      }
    };

    // ================================================================
    // SECTION: Animation Orchestration (stub)
    // ================================================================

    // OptiPlan.animations populated by future stories

    // ================================================================
    // SECTION: Touch & Event Management
    // ================================================================

    // Prevent pull-to-refresh on iOS Safari
    function handleTouchMovePrevent(e) {
      // Only prevent on elements that shouldn't scroll
      if (!e.target.closest('.module-overlay__content, .chat-panel__messages, .activity-feed, .chat-panel__input')) {
        if (e.touches.length === 1) {
          e.preventDefault();
        }
      }
    }

    OptiPlan.touch = {
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        document.addEventListener('touchmove', handleTouchMovePrevent, { passive: false });
        this._initialized = true;
      },

      destroy: function() {
        document.removeEventListener('touchmove', handleTouchMovePrevent);
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Component — Tooltip
    // ================================================================

    OptiPlan.components.tooltip = {
      $tooltip: null,
      $arrow: null,
      _activeTarget: null,
      _isVisible: false,
      _lastTouchTime: 0,
      _lastDismissTouchTime: 0,
      _autoHideTimer: null,
      _fadeTimer: null,

      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        var self = this;

        // Create single tooltip DOM element
        var $el = document.createElement('div');
        $el.className = 'tooltip';
        $el.innerHTML = '<span class="tooltip__text"></span><div class="tooltip__arrow"></div>';
        document.body.appendChild($el);
        self.$tooltip = $el;
        self.$arrow = $el.querySelector('.tooltip__arrow');

        self._syncTooltipData();
        self._bindEvents();
        self._initialized = true;
      },

      // Sync data-tooltip attributes with data constants (single source of truth)
      _syncTooltipData: function() {
        var budgetB = (PROJECT_DATA.totalBudget / 1000000000).toFixed(1);
        var authCount = OPTITRACK_DATA.authorities.length;
        var sectionCount = OPTIGANTT_DATA.sections.length;

        var gaugeTooltips = {
          financial: '\u05E0\u05D9\u05D8\u05D5\u05E8 \u05D4\u05EA\u05E7\u05D3\u05DE\u05D5\u05EA \u05EA\u05E7\u05E6\u05D9\u05D1\u05D9\u05EA \u05D1-\u20AA' + budgetB + ' \u05DE\u05D9\u05DC\u05D9\u05D0\u05E8\u05D3 \u05EA\u05E7\u05E6\u05D9\u05D1 \u2014 \u05E1\u05D8\u05D9\u05D5\u05EA \u05DE\u05D6\u05D5\u05D4\u05D5\u05EA \u05D1\u05D6\u05DE\u05DF \u05D0\u05DE\u05EA',
          coordination: '\u05EA\u05D9\u05D0\u05D5\u05DD \u05E2\u05DD ' + authCount + ' \u05E8\u05E9\u05D5\u05D9\u05D5\u05EA \u05DE\u05DE\u05E9\u05DC\u05EA\u05D9\u05D5\u05EA \u2014 \u05D1\u05E4\u05DC\u05D8\u05E4\u05D5\u05E8\u05DE\u05D4 \u05D0\u05D7\u05EA',
          schedule: '\u05DE\u05E2\u05E7\u05D1 \u05DC\u05D5\u05D7\u05D5\u05EA \u05D6\u05DE\u05E0\u05D9\u05DD \u05D1-' + sectionCount + ' \u05E7\u05D8\u05E2\u05D9 \u05D1\u05D9\u05E6\u05D5\u05E2 \u2014 \u05D7\u05E8\u05D9\u05D2\u05D5\u05EA \u05DE\u05D6\u05D5\u05D4\u05D5\u05EA \u05D0\u05D5\u05D8\u05D5\u05DE\u05D8\u05D9\u05EA'
        };

        var moduleTooltips = {
          optitrack: '\u05D1\u05E7\u05E8\u05EA \u05EA\u05D9\u05D0\u05D5\u05DE\u05D9\u05DD \u2014 ' + OPTITRACK_DATA.totalItems + ' \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD \u05DE\u05D5\u05DC ' + authCount + ' \u05E8\u05E9\u05D5\u05D9\u05D5\u05EA, \u05DE\u05DB\u05DC \u05D4\u05E7\u05D8\u05E2\u05D9\u05DD',
          optirisk: '\u05DE\u05D9\u05E4\u05D5\u05D9 \u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD \u2014 ' + OPTIRISK_DATA.activeRisks + ' \u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD \u05E4\u05E2\u05D9\u05DC\u05D9\u05DD, ' + OPTIRISK_DATA.critical + ' \u05E7\u05E8\u05D9\u05D8\u05D9\u05D9\u05DD, \u05E2\u05DD \u05DE\u05D2\u05DE\u05D5\u05EA',
          optidocs: '\u05DE\u05E2\u05E7\u05D1 \u05DE\u05E1\u05DE\u05DB\u05D9\u05DD \u05D5\u05DE\u05E9\u05D9\u05DE\u05D5\u05EA \u2014 ' + OPTIDOCS_DATA.total + ' \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD, ' + OPTIDOCS_DATA.completionRate + '% \u05D4\u05D5\u05E9\u05DC\u05DE\u05D5',
          optigantt: '\u05DC\u05D5\u05D7 \u05D6\u05DE\u05E0\u05D9\u05DD \u05D2\u05E0\u05D8 \u2014 ' + sectionCount + ' \u05E7\u05D8\u05E2\u05D9\u05DD, \u05D0\u05D1\u05E0\u05D9 \u05D3\u05E8\u05DA, \u05E0\u05D9\u05EA\u05D5\u05D7 \u05D7\u05E8\u05D9\u05D2\u05D5\u05EA'
        };

        var gaugeKeys = ['financial', 'coordination', 'schedule'];
        for (var g = 0; g < gaugeKeys.length; g++) {
          var $gauge = document.querySelector('[data-gauge="' + gaugeKeys[g] + '"]');
          if ($gauge) $gauge.setAttribute('data-tooltip', gaugeTooltips[gaugeKeys[g]]);
        }

        var moduleKeys = ['optitrack', 'optirisk', 'optidocs', 'optigantt'];
        for (var m = 0; m < moduleKeys.length; m++) {
          var $card = document.querySelector('[data-module="' + moduleKeys[m] + '"]');
          if ($card) $card.setAttribute('data-tooltip', moduleTooltips[moduleKeys[m]]);
        }
      },

      _bindEvents: function() {
        var $triggers = document.querySelectorAll('[data-tooltip]');
        for (var i = 0; i < $triggers.length; i++) {
          $triggers[i].addEventListener('touchstart', handleTooltipShow, { passive: true });
          $triggers[i].addEventListener('click', handleTooltipShow);
        }
        document.addEventListener('touchstart', handleTooltipDismiss, { passive: true });
        document.addEventListener('click', handleTooltipDismiss);
      },

      show: function(target) {
        var self = this;
        if (!self.$tooltip) return;
        var text = target.dataset.tooltip;
        if (!text) return;

        // Don't show tooltip on flipped stat cards
        if (target.classList.contains('stat-card--flipped')) return;

        // Clear any pending auto-hide/fade timers
        if (self._autoHideTimer) { clearTimeout(self._autoHideTimer); self._autoHideTimer = null; }
        if (self._fadeTimer) { clearTimeout(self._fadeTimer); self._fadeTimer = null; }
        self.$tooltip.classList.remove('tooltip--fading');

        var $text = self.$tooltip.querySelector('.tooltip__text');
        $text.textContent = text;

        self._position(target);
        self.$tooltip.classList.add('tooltip--visible');
        self._activeTarget = target;
        self._isVisible = true;

        // Auto-hide after 3 seconds with fade-out
        self._autoHideTimer = setTimeout(function() {
          self.$tooltip.classList.add('tooltip--fading');
          self._fadeTimer = setTimeout(function() {
            self.hide();
          }, 500);
        }, 3000);
      },

      hide: function() {
        var self = this;
        if (!self.$tooltip) return;
        if (self._autoHideTimer) { clearTimeout(self._autoHideTimer); self._autoHideTimer = null; }
        if (self._fadeTimer) { clearTimeout(self._fadeTimer); self._fadeTimer = null; }
        self.$tooltip.classList.remove('tooltip--visible');
        self.$tooltip.classList.remove('tooltip--fading');
        self.$tooltip.classList.remove('tooltip--below');
        self._activeTarget = null;
        self._isVisible = false;
      },

      _position: function(target) {
        var self = this;
        var $tip = self.$tooltip;
        var $arrow = self.$arrow;

        // Remove below class before measuring
        $tip.classList.remove('tooltip--below');

        // Temporarily show off-screen for measurement
        $tip.style.visibility = 'hidden';
        $tip.style.display = 'block';
        $tip.classList.add('tooltip--visible');

        var tipW = $tip.offsetWidth;
        var tipH = $tip.offsetHeight;

        $tip.classList.remove('tooltip--visible');
        $tip.style.visibility = '';
        $tip.style.display = '';

        var triggerRect = target.getBoundingClientRect();
        var gap = 12;
        var edgePad = 8;

        // Default: above
        var top = triggerRect.top - tipH - gap;
        var left = triggerRect.left + (triggerRect.width / 2) - (tipW / 2);

        // Viewport overflow — top: switch to below
        if (top < edgePad) {
          top = triggerRect.bottom + gap;
          $tip.classList.add('tooltip--below');
        }

        // Viewport overflow — horizontal clamping
        var viewW = window.innerWidth;
        if (left < edgePad) {
          left = edgePad;
        } else if (left + tipW > viewW - edgePad) {
          left = viewW - tipW - edgePad;
        }

        $tip.style.top = top + 'px';
        $tip.style.left = left + 'px';

        // Adjust arrow to point at trigger center
        var triggerCenter = triggerRect.left + (triggerRect.width / 2);
        var arrowLeft = triggerCenter - left;
        // Clamp arrow within tooltip bounds (12px from edges)
        if (arrowLeft < 12) arrowLeft = 12;
        if (arrowLeft > tipW - 12) arrowLeft = tipW - 12;
        $arrow.style.left = arrowLeft + 'px';
      },

      destroy: function() {
        var self = this;
        var $triggers = document.querySelectorAll('[data-tooltip]');
        for (var i = 0; i < $triggers.length; i++) {
          $triggers[i].removeEventListener('touchstart', handleTooltipShow);
          $triggers[i].removeEventListener('click', handleTooltipShow);
        }
        document.removeEventListener('touchstart', handleTooltipDismiss);
        document.removeEventListener('click', handleTooltipDismiss);
        if (self.$tooltip && self.$tooltip.parentNode) {
          self.$tooltip.parentNode.removeChild(self.$tooltip);
        }
        self.$tooltip = null;
        self.$arrow = null;
        self._activeTarget = null;
        self._isVisible = false;
        self._lastTouchTime = 0;
        self._lastDismissTouchTime = 0;
        self._initialized = false;
      }
    };

    function handleTooltipShow(e) {
      var tooltip = OptiPlan.components.tooltip;
      var target = e.currentTarget;

      // Prevent duplicate handling (touchstart + click)
      if (e.type === 'click' && tooltip._lastTouchTime && (Date.now() - tooltip._lastTouchTime < 500)) {
        return;
      }
      if (e.type === 'touchstart') {
        tooltip._lastTouchTime = Date.now();
      }

      // Toggle: if tapping the already-active target, hide
      if (tooltip._activeTarget === target) {
        tooltip.hide();
        return;
      }

      // Hide any existing, then show for new target
      tooltip.hide();
      tooltip.show(target);
    }

    function handleTooltipDismiss(e) {
      var tooltip = OptiPlan.components.tooltip;
      if (!tooltip._isVisible) return;

      // Prevent duplicate handling (touchstart + click)
      if (e.type === 'click' && tooltip._lastDismissTouchTime && (Date.now() - tooltip._lastDismissTouchTime < 500)) {
        return;
      }
      if (e.type === 'touchstart') {
        tooltip._lastDismissTouchTime = Date.now();
      }

      // Don't dismiss if tap is inside tooltip or on active target
      if (tooltip.$tooltip && tooltip.$tooltip.contains(e.target)) return;
      if (tooltip._activeTarget && tooltip._activeTarget.contains(e.target)) return;

      tooltip.hide();
    }

    // ================================================================
    // SECTION: Component — Sidebar
    // ================================================================

    function handleNavItemTap(e) {
      e.preventDefault();
      var $tapped = e.currentTarget;
      var moduleId = $tapped.dataset.module;

      // If tapping Dashboard, close overlay and/or chat
      if (moduleId === 'dashboard') {
        if (OptiPlan.state.currentLayer === 'module-expand') {
          OptiPlan.components.moduleOverlay.close();
        }
        if (OptiPlan.state.chatOpen) {
          handleChatClose(e);
          return;
        }
        _resetSidebarToDashboard();
        return;
      }

      // If tapping Opium AI, open chat panel
      if (moduleId === 'opium-ai') {
        handleChatOpen(e);
        return;
      }

      // If tapping a module nav item, open/switch overlay
      var moduleIds = ['optitrack', 'optibiz', 'optirisk', 'optidocs', 'optigantt'];
      if (moduleIds.indexOf(moduleId) !== -1) {
        // Close chat if open (mutually exclusive)
        if (OptiPlan.state.chatOpen) {
          handleChatClose(e);
        }
        OptiPlan.components.moduleOverlay.expand(moduleId);
        return;
      }

      // For non-module items (tools, system), just update visual state
      var $items = OptiPlan.components.sidebar.$navItems;
      $items.forEach(function($item) {
        $item.classList.remove('sidebar__nav-item--active');
        $item.removeAttribute('aria-current');
      });
      $tapped.classList.add('sidebar__nav-item--active');
      $tapped.setAttribute('aria-current', 'page');
    }

    function handleSidebarToggle(e) {
      if (e) e.preventDefault();
      var $sidebar = OptiPlan.components.sidebar.$sidebar;
      var $toggleIcon = document.querySelector('#sidebarToggle i');
      if (!$sidebar) return;
      var isCollapsed = $sidebar.classList.toggle('sidebar--collapsed');
      OptiPlan.state.sidebarCollapsed = isCollapsed;
      if ($toggleIcon) {
        $toggleIcon.className = isCollapsed
          ? 'ti ti-layout-sidebar-right-expand'
          : 'ti ti-layout-sidebar-right-collapse';
      }
      handleActivityReset();
    }

    OptiPlan.components.sidebar = {
      $sidebar: null,
      $navItems: null,
      $toggle: null,
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        this.$sidebar = document.querySelector('.sidebar');
        this.$navItems = this.$sidebar.querySelectorAll('.sidebar__nav-item');
        this.$navItems.forEach(function($item) {
          $item.addEventListener('touchstart', handleNavItemTap, { passive: false });
          $item.addEventListener('click', handleNavItemTap);
        });
        this.$toggle = document.getElementById('sidebarToggle');
        if (this.$toggle) {
          this.$toggle.addEventListener('click', handleSidebarToggle);
        }
        this.render();
        this._initialized = true;
      },

      render: function() {
        var $dashboard = this.$sidebar.querySelector('[data-module="dashboard"]');
        if ($dashboard) {
          $dashboard.classList.add('sidebar__nav-item--active');
          $dashboard.setAttribute('aria-current', 'page');
        }
      },

      destroy: function() {
        if (this.$navItems) {
          this.$navItems.forEach(function($item) {
            $item.removeEventListener('touchstart', handleNavItemTap);
            $item.removeEventListener('click', handleNavItemTap);
          });
        }
        if (this.$toggle) {
          this.$toggle.removeEventListener('click', handleSidebarToggle);
          this.$toggle = null;
        }
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Component — Topbar
    // ================================================================

    var _clockFormatter = new Intl.DateTimeFormat('he-IL', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });

    function updateTopbarClock() {
      var $clock = OptiPlan.components.topbar.$clock;
      if (!$clock) return;
      $clock.textContent = _clockFormatter.format(new Date());
    }

    OptiPlan.components.topbar = {
      $topbar: null,
      $clock: null,
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        this.$topbar = document.querySelector('.topbar');
        this.$clock = document.getElementById('topbarClock');
        updateTopbarClock();
        OptiPlan.state._clockInterval = setInterval(updateTopbarClock, 30000);
        this._initialized = true;
      },

      render: function() {
        updateTopbarClock();
      },

      destroy: function() {
        if (OptiPlan.state._clockInterval) {
          clearInterval(OptiPlan.state._clockInterval);
          OptiPlan.state._clockInterval = null;
        }
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Component — Hero Gauges
    // ================================================================

    // Computed: average of OPTIGANTT_DATA.sections[].progress (schedule adherence)
    var _scheduleAdherence = Math.round(
      OPTIGANTT_DATA.sections.reduce(function(sum, s) { return sum + s.progress; }, 0) / OPTIGANTT_DATA.sections.length
    );

    var HERO_GAUGE_CONFIG = [
      { key: 'financial', value: OPTIBIZ_DATA.budgetUtilization, label: '\u05D4\u05EA\u05E7\u05D3\u05DE\u05D5\u05EA \u05EA\u05E7\u05E6\u05D9\u05D1\u05D9\u05EA' },
      { key: 'coordination', value: OPTITRACK_DATA.approvalRate, label: '\u05D4\u05E9\u05DC\u05DE\u05EA \u05EA\u05D9\u05D0\u05D5\u05DE\u05D9\u05DD' },
      { key: 'schedule', value: _scheduleAdherence, label: '\u05E2\u05DE\u05D9\u05D3\u05D4 \u05D1\u05DC\u05D5\u05D7 \u05D6\u05DE\u05E0\u05D9\u05DD' }
    ];

    var HERO_GAUGE_RADIUS = 50;
    var HERO_GAUGE_CIRCUMFERENCE = 2 * Math.PI * HERO_GAUGE_RADIUS;
    var HERO_GAUGE_FILL_DELAY = 400;
    var HERO_GAUGE_PULSE_DELAY = 1200;

    function _heroGaugeSetOffset($fill, percent) {
      var offset = HERO_GAUGE_CIRCUMFERENCE * (1 - percent / 100);
      $fill.style.strokeDashoffset = offset;
    }

    OptiPlan.components.heroGauges = {
      $heroGauges: null,
      $gauges: null,
      _fillTimeout: null,
      _pulseTimeout: null,
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        this.$heroGauges = document.querySelector('.hero-gauges');
        if (!this.$heroGauges) return;
        this.$gauges = this.$heroGauges.querySelectorAll('.hero-gauge');
        this.render();
        this._initialized = true;
      },

      render: function() {
        var self = this;
        var circumference = HERO_GAUGE_CIRCUMFERENCE;

        self.$gauges.forEach(function($gauge, index) {
          var config = HERO_GAUGE_CONFIG[index];
          if (!config) return;

          var $fill = $gauge.querySelector('.hero-gauge__fill');
          var $value = $gauge.querySelector('.hero-gauge__value');

          // Set initial state: full circumference = hidden
          $fill.style.strokeDasharray = circumference;
          $fill.style.strokeDashoffset = circumference;

          // Set percentage text
          $value.textContent = OptiPlan.utils.formatPercent(config.value);
        });

        // After 400ms delay, animate to target offset (CSS transition handles animation)
        self._fillTimeout = setTimeout(function() {
          self.$gauges.forEach(function($gauge, index) {
            var config = HERO_GAUGE_CONFIG[index];
            if (!config) return;
            var $fill = $gauge.querySelector('.hero-gauge__fill');
            $fill.classList.add('is-animating');
            _heroGaugeSetOffset($fill, config.value);
          });
        }, HERO_GAUGE_FILL_DELAY);

        // After fill animation completes (~1200ms), remove will-change and add idle pulse class
        self._pulseTimeout = setTimeout(function() {
          self.$gauges.forEach(function($gauge) {
            var $fill = $gauge.querySelector('.hero-gauge__fill');
            $fill.classList.remove('is-animating');
            $fill.classList.add('is-idle');
          });
        }, HERO_GAUGE_PULSE_DELAY);
      },

      destroy: function() {
        if (this._fillTimeout) {
          clearTimeout(this._fillTimeout);
          this._fillTimeout = null;
        }
        if (this._pulseTimeout) {
          clearTimeout(this._pulseTimeout);
          this._pulseTimeout = null;
        }
        if (this.$gauges) {
          this.$gauges.forEach(function($gauge) {
            var $fill = $gauge.querySelector('.hero-gauge__fill');
            $fill.classList.remove('is-animating');
            $fill.classList.remove('is-idle');
          });
        }
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Component — Stat Cards
    // ================================================================

    var STAT_CARD_CONFIG = [
      { key: 'optitrack', name: 'OptiTrack', icon: 'ti-route',
        value: OPTITRACK_DATA.approved, label: '\u05EA\u05D9\u05D0\u05D5\u05DE\u05D9\u05DD \u05DE\u05D0\u05D5\u05E9\u05E8\u05D9\u05DD',
        sublabel: '+' + OPTITRACK_DATA.growthRate + '%' },
      { key: 'optibiz', name: 'OptiBiz', icon: 'ti-chart-bar',
        value: null, label: '\u05E0\u05D9\u05E6\u05D5\u05DC \u05EA\u05E7\u05E6\u05D9\u05D1',
        sublabel: OPTIBIZ_DATA.budgetUtilization + '%',
        formatter: function() {
          return '\u20AA' + (OPTIBIZ_DATA.budgetUtilized / 1000000000).toFixed(2) + 'B';
        }},
      { key: 'optirisk', name: 'OptiRisk', icon: 'ti-alert-triangle',
        value: OPTIRISK_DATA.activeRisks, label: '\u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD \u05E4\u05E2\u05D9\u05DC\u05D9\u05DD',
        sublabel: OPTIRISK_DATA.critical + ' \u05E7\u05E8\u05D9\u05D8\u05D9\u05D9\u05DD' },
      { key: 'optidocs', name: 'OptiDocs', icon: 'ti-file-text',
        value: OPTIDOCS_DATA.total, label: '\u05DE\u05E1\u05DE\u05DB\u05D9\u05DD',
        sublabel: OPTIDOCS_DATA.completionRate + '% \u05D4\u05D5\u05E9\u05DC\u05DD' },
      { key: 'optigantt', name: 'OptiGantt', icon: 'ti-calendar-stats',
        value: OPTIGANTT_DATA.sections.length, label: '\u05E7\u05D8\u05E2\u05D9 \u05E4\u05E8\u05D5\u05D9\u05E7\u05D8',
        sublabel: null,
        sublabelCompute: function() {
          var delayed = OPTIGANTT_DATA.sections.filter(function(s) {
            return s.progress < 50;
          }).length;
          return delayed + ' \u05D1\u05E2\u05D9\u05DB\u05D5\u05D1';
        }}
    ];

    var STAT_CARD_ENTRANCE_DELAY = 1200;
    var STAT_CARD_STAGGER_MS = 60;

    var CARD_BACK_CONFIG = {
      optitrack: {
        title: 'OptiTrack',
        kpis: [
          { label: '\u05E1\u05D4"\u05DB \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD', getValue: function() { return OPTITRACK_DATA.totalItems; }, trend: 'neutral' },
          { label: '\u05D0\u05D7\u05D5\u05D6 \u05D0\u05D9\u05E9\u05D5\u05E8', getValue: function() { return OPTITRACK_DATA.approvalRate + '%'; }, trend: 'up' },
          { label: '\u05D4\u05EA\u05E0\u05D2\u05D3\u05D5\u05D9\u05D5\u05EA', getValue: function() { return OPTITRACK_DATA.objections; }, trend: 'down' },
          { label: '\u05DE\u05DE\u05EA\u05D9\u05E0\u05D9\u05DD', getValue: function() { return OPTITRACK_DATA.pending; }, trend: 'neutral' }
        ]
      },
      optibiz: {
        title: 'OptiBiz',
        kpis: [
          { label: '\u05E0\u05D9\u05E6\u05D5\u05DC \u05EA\u05E7\u05E6\u05D9\u05D1', getValue: function() { return '\u20AA' + (OPTIBIZ_DATA.budgetUtilized / 1000000000).toFixed(2) + 'B'; }, trend: 'up' },
          { label: '\u05D0\u05D7\u05D5\u05D6 \u05EA\u05E7\u05E6\u05D9\u05D1', getValue: function() { return OPTIBIZ_DATA.budgetUtilization + '%'; }, trend: 'neutral' },
          { label: '\u05E7\u05E6\u05D1 \u05E9\u05E8\u05D9\u05E4\u05D4', getValue: function() { return '\u20AA' + Math.round(OPTIBIZ_DATA.burnRate / 1000000) + 'M'; }, trend: 'neutral' },
          { label: '\u05E1\u05D8\u05D9\u05D9\u05D4 Q1', getValue: function() { return '\u20AA' + Math.round(OPTIBIZ_DATA.variance / 1000000) + 'M'; }, trend: 'down' }
        ]
      },
      optirisk: {
        title: 'OptiRisk',
        kpis: [
          { label: '\u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD \u05E4\u05E2\u05D9\u05DC\u05D9\u05DD', getValue: function() { return OPTIRISK_DATA.activeRisks; }, trend: 'down' },
          { label: '\u05E7\u05E8\u05D9\u05D8\u05D9\u05D9\u05DD', getValue: function() { return OPTIRISK_DATA.critical; }, trend: 'down' },
          { label: '\u05DE\u05D8\u05D5\u05E4\u05DC\u05D9\u05DD', getValue: function() { return OPTIRISK_DATA.topRisks.filter(function(r) { return r.mitigation === 'resolved'; }).length; }, trend: 'up' },
          { label: '\u05DE\u05D2\u05DE\u05D4', getValue: function() {
            var worsening = OPTIRISK_DATA.topRisks.filter(function(r) { return r.trend === 'up'; }).length;
            var improving = OPTIRISK_DATA.topRisks.filter(function(r) { return r.trend === 'down'; }).length;
            if (improving > worsening) return '\u05DE\u05E9\u05EA\u05E4\u05E8';
            if (worsening > improving) return '\u05DE\u05D7\u05DE\u05D9\u05E8';
            return '\u05D9\u05E6\u05D9\u05D1';
          }, trend: 'down' }
        ]
      },
      optidocs: {
        title: 'OptiDocs',
        kpis: [
          { label: '\u05E1\u05D4"\u05DB \u05DE\u05E1\u05DE\u05DB\u05D9\u05DD', getValue: function() { return OPTIDOCS_DATA.total; }, trend: 'neutral' },
          { label: '\u05D0\u05D7\u05D5\u05D6 \u05D4\u05E9\u05DC\u05DE\u05D4', getValue: function() { return OPTIDOCS_DATA.completionRate + '%'; }, trend: 'up' },
          { label: '\u05DE\u05DE\u05EA\u05D9\u05E0\u05D9\u05DD', getValue: function() { return OPTIDOCS_DATA.pending; }, trend: 'neutral' },
          { label: '\u05D1\u05D0\u05D9\u05D7\u05D5\u05E8', getValue: function() { return OPTIDOCS_DATA.overdue; }, trend: 'down' }
        ]
      },
      optigantt: {
        title: 'OptiGantt',
        kpis: [
          { label: '\u05E7\u05D8\u05E2\u05D9\u05DD', getValue: function() { return OPTIGANTT_DATA.sections.length; }, trend: 'neutral' },
          { label: '\u05D1\u05DE\u05E1\u05DC\u05D5\u05DC', getValue: function() {
            return OPTIGANTT_DATA.sections.filter(function(s) { return s.progress >= 50; }).length;
          }, trend: 'up' },
          { label: '\u05D1\u05E2\u05D9\u05DB\u05D5\u05D1', getValue: function() {
            return OPTIGANTT_DATA.sections.filter(function(s) { return s.progress < 50; }).length;
          }, trend: 'down' },
          { label: '\u05D0\u05D1\u05E0\u05D9 \u05D3\u05E8\u05DA', getValue: function() { return OPTIGANTT_DATA.milestones.length; }, trend: 'neutral' }
        ]
      }
    };

    const MODULE_OVERLAY_CONFIG = {
      optitrack: {
        title: 'OptiTrack',
        subtitle: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05EA\u05D9\u05D0\u05D5\u05DE\u05D9\u05DD',
        icon: 'ti-route',
        dataKey: 'OPTITRACK_DATA'
      },
      optibiz: {
        title: 'OptiBiz',
        subtitle: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05E4\u05D9\u05E0\u05E0\u05E1\u05D9',
        icon: 'ti-chart-bar',
        dataKey: 'OPTIBIZ_DATA'
      },
      optirisk: {
        title: 'OptiRisk',
        subtitle: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD',
        icon: 'ti-alert-triangle',
        dataKey: 'OPTIRISK_DATA'
      },
      optidocs: {
        title: 'OptiDocs',
        subtitle: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05DE\u05E1\u05DE\u05DB\u05D9\u05DD',
        icon: 'ti-file-text',
        dataKey: 'OPTIDOCS_DATA'
      },
      optigantt: {
        title: 'OptiGantt',
        subtitle: '\u05DC\u05D5\u05D7 \u05D6\u05DE\u05E0\u05D9\u05DD',
        icon: 'ti-calendar',
        dataKey: 'OPTIGANTT_DATA'
      }
    };

    function handleStatCardTouchStart(e) {
      var card = e.currentTarget;
      card.style.transition = 'none';
      card.style.transform = 'scale(0.98)';
    }

    function handleStatCardTouchEnd(e) {
      var card = e.currentTarget;
      card.style.transform = '';
      void card.offsetHeight;
      card.style.transition = '';
    }

    // ================================================================
    // SECTION: Component — Card Flip Interaction
    // ================================================================

    function handleStatCardTap(e) {
      var card = e.currentTarget;
      var moduleId = card.dataset.module;

      // If tapping the CTA button, open module overlay
      if (e.target.classList.contains('stat-card__back-cta')) {
        OptiPlan.components.tooltip.hide();
        var ctaModuleId = e.currentTarget.dataset.module;
        OptiPlan.components.moduleOverlay.expand(ctaModuleId);
        return;
      }

      // If same card is already flipped, don't re-flip
      if (card.classList.contains('stat-card--flipped')) {
        return;
      }

      // If another card is flipped, snap it back immediately
      var currentlyFlipped = document.querySelector('.stat-card--flipped');
      if (currentlyFlipped) {
        var frontFace = currentlyFlipped.querySelector('.stat-card__front');
        var backFace = currentlyFlipped.querySelector('.stat-card__back');
        if (frontFace) frontFace.style.transition = 'none';
        if (backFace) backFace.style.transition = 'none';
        currentlyFlipped.classList.remove('stat-card--flipped');
        // Force reflow to apply snap
        void currentlyFlipped.offsetHeight;
        if (frontFace) frontFace.style.transition = '';
        if (backFace) backFace.style.transition = '';
      }

      // Flip the tapped card
      card.classList.add('stat-card--flipped');
      OptiPlan.state.activeModule = moduleId;
      // Only transition if not already in card-flip (switching cards stays in same layer)
      if (OptiPlan.state.currentLayer !== 'card-flip') {
        OptiPlan.state.transition('card-flip');
      }
    }

    function handleOutsideTap(e) {
      // Don't process if no card is flipped
      if (OptiPlan.state.currentLayer !== 'card-flip') return;

      // Check if tap is inside any stat card
      var isInsideCard = e.target.closest('.stat-card');
      if (isInsideCard) return;

      // Flip the active card back
      var flippedCard = document.querySelector('.stat-card--flipped');
      if (flippedCard) {
        flippedCard.classList.remove('stat-card--flipped');
      }

      OptiPlan.state.activeModule = null;
      OptiPlan.state.transition('overview');
    }

    OptiPlan.components.statCards = {
      $statCardsRow: null,
      $statCards: null,
      _entranceTimeouts: [],
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        this.$statCardsRow = document.querySelector('.stat-cards-row');
        if (!this.$statCardsRow) return;
        this.$statCards = this.$statCardsRow.querySelectorAll('.stat-card');
        this.render();
        this._bindEvents();
        this._initialized = true;
      },

      render: function(data) {
        var self = this;
        // Populate front face content from config
        STAT_CARD_CONFIG.forEach(function(config, i) {
          var $card = self.$statCards[i];
          if (!$card) return;
          var $value = $card.querySelector('.stat-card__value');
          var $label = $card.querySelector('.stat-card__label');
          var $sublabel = $card.querySelector('.stat-card__sublabel');
          if ($value) {
            $value.textContent = config.formatter
              ? config.formatter()
              : config.value;
          }
          if ($label) $label.textContent = config.label;
          if ($sublabel) {
            $sublabel.textContent = config.sublabelCompute
              ? config.sublabelCompute()
              : config.sublabel;
          }
        });

        // Populate back face content from CARD_BACK_CONFIG
        for (var i = 0; i < self.$statCards.length; i++) {
          var $card = self.$statCards[i];
          var moduleKey = $card.dataset.module;
          var backConfig = CARD_BACK_CONFIG[moduleKey];
          if (!backConfig) continue;

          var $kpiRows = $card.querySelectorAll('.stat-card__kpi-row');
          for (var j = 0; j < backConfig.kpis.length && j < $kpiRows.length; j++) {
            var kpi = backConfig.kpis[j];
            var $row = $kpiRows[j];
            var $kpiLabel = $row.querySelector('.stat-card__kpi-label');
            var $kpiValue = $row.querySelector('.stat-card__kpi-value');
            var $kpiTrend = $row.querySelector('.stat-card__kpi-trend');

            if ($kpiLabel) $kpiLabel.textContent = kpi.label;
            if ($kpiValue) $kpiValue.textContent = kpi.getValue();
            if ($kpiTrend) {
              $kpiTrend.className = 'stat-card__kpi-trend stat-card__kpi-trend--' + kpi.trend;
              if (kpi.trend === 'up') $kpiTrend.textContent = '\u25B2';
              else if (kpi.trend === 'down') $kpiTrend.textContent = '\u25BC';
              else $kpiTrend.textContent = '\u2014';
            }
          }
        }

        // Staggered entrance animation
        STAT_CARD_CONFIG.forEach(function(config, i) {
          var timeout = setTimeout(function() {
            var $card = self.$statCards[i];
            if ($card) {
              $card.style.animation = 'stat-card-entrance 0.65s cubic-bezier(0.16, 1, 0.3, 1) forwards';
              $card.addEventListener('animationend', function handler() {
                $card.removeEventListener('animationend', handler);
                $card.style.animation = '';
                $card.style.opacity = '1';
                $card.style.transform = '';
              });
            }
          }, STAT_CARD_ENTRANCE_DELAY + (i * STAT_CARD_STAGGER_MS));
          self._entranceTimeouts.push(timeout);
        });
      },

      _bindEvents: function() {
        if (!this.$statCards) return;
        for (var i = 0; i < this.$statCards.length; i++) {
          this.$statCards[i].addEventListener('touchstart', handleStatCardTouchStart, { passive: true });
          this.$statCards[i].addEventListener('touchend', handleStatCardTouchEnd, { passive: true });
          this.$statCards[i].addEventListener('click', handleStatCardTap);
        }
        document.addEventListener('click', handleOutsideTap);
      },

      destroy: function() {
        // Clear entrance timeouts
        this._entranceTimeouts.forEach(function(t) { clearTimeout(t); });
        this._entranceTimeouts = [];
        // Remove event listeners
        if (this.$statCards) {
          for (var i = 0; i < this.$statCards.length; i++) {
            this.$statCards[i].removeEventListener('touchstart', handleStatCardTouchStart);
            this.$statCards[i].removeEventListener('touchend', handleStatCardTouchEnd);
            this.$statCards[i].removeEventListener('click', handleStatCardTap);
          }
        }
        document.removeEventListener('click', handleOutsideTap);
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Component — Module Overlay
    // ================================================================

    var _isOverlayTransitioning = false;

    function handleModuleClose(e) {
      if (e) e.preventDefault();
      OptiPlan.components.moduleOverlay.close();
    }

    function handleBackdropTap(e) {
      if (e.target === OptiPlan.components.moduleOverlay.$backdrop) {
        OptiPlan.components.moduleOverlay.close();
      }
    }

    function handlePopState(e) {
      if (OptiPlan.state.currentLayer === 'module-expand') {
        OptiPlan.components.moduleOverlay.close({ fromPopstate: true });
      }
    }

    function handleEscapeKey(e) {
      if (e.key === 'Escape' && OptiPlan.state.currentLayer === 'module-expand') {
        OptiPlan.components.moduleOverlay.close();
      }
    }

    function _updateSidebarForModule(moduleId) {
      var $items = OptiPlan.components.sidebar.$navItems;
      if (!$items) return;
      $items.forEach(function($item) {
        $item.classList.remove('sidebar__nav-item--active');
        $item.removeAttribute('aria-current');
        if ($item.dataset.module === moduleId) {
          $item.classList.add('sidebar__nav-item--active');
          $item.setAttribute('aria-current', 'page');
        }
      });
    }

    function _resetSidebarToDashboard() {
      var $items = OptiPlan.components.sidebar.$navItems;
      if (!$items) return;
      $items.forEach(function($item) {
        $item.classList.remove('sidebar__nav-item--active');
        $item.removeAttribute('aria-current');
        if ($item.dataset.module === 'dashboard') {
          $item.classList.add('sidebar__nav-item--active');
          $item.setAttribute('aria-current', 'page');
        }
      });
    }

    OptiPlan.components.moduleOverlay = {
      $backdrop: null,
      $overlay: null,
      $content: null,
      $title: null,
      $subtitle: null,
      $icon: null,
      $backBtn: null,
      _currentModuleId: null,
      _triggerElement: null,
      _transitionTimeouts: [],
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        this.$backdrop = document.querySelector('.module-overlay-backdrop');
        this.$overlay = document.querySelector('.module-overlay');
        this.$content = document.querySelector('.module-overlay__content');
        this.$title = document.querySelector('.module-overlay__title');
        this.$subtitle = document.querySelector('.module-overlay__subtitle');
        this.$icon = document.querySelector('.module-overlay__icon');
        this.$backBtn = document.querySelector('.module-overlay__back');
        this._bindEvents();
        this._initialized = true;
      },

      expand: function(moduleId) {
        if (_isOverlayTransitioning) return;
        // Dismiss tooltip when opening overlay
        OptiPlan.components.tooltip.hide();
        var self = this;
        var config = MODULE_OVERLAY_CONFIG[moduleId];
        if (!config) {
          console.warn('[OptiPlan ModuleOverlay] Unknown module:', moduleId);
          return;
        }

        // If already showing a different module, switch
        if (this._currentModuleId && this._currentModuleId !== moduleId) {
          this._switchModule(moduleId);
          return;
        }

        _isOverlayTransitioning = true;
        var previousLayer = OptiPlan.state.currentLayer;
        this._currentModuleId = moduleId;
        this._triggerElement = document.activeElement;

        // Set module color via CSS custom property
        this.$overlay.style.setProperty('--module', 'var(--' + moduleId + ')');

        // Populate header
        this.$title.textContent = config.title;
        this.$subtitle.textContent = config.subtitle;
        this.$icon.className = 'module-overlay__icon ti ' + config.icon;

        // Activate overlay
        this.$backdrop.classList.add('module-overlay-backdrop--active');
        this.$overlay.classList.remove('module-overlay--closing');
        this.$overlay.classList.add('module-overlay--active');

        // Move focus into overlay for accessibility
        this.$backBtn.focus();

        // Update state
        OptiPlan.state.activeModule = moduleId;
        OptiPlan.state.transition('module-expand');

        // History management: pushState only on fresh open, replaceState when switching modules
        // This prevents deep history stack accumulation over 30+ sessions
        if (previousLayer === 'module-expand') {
          window.history.replaceState({ layer: 'module-expand', moduleId: moduleId }, '');
        } else {
          window.history.pushState({ layer: 'module-expand', moduleId: moduleId }, '');
        }

        // Update sidebar active state
        _updateSidebarForModule(moduleId);

        // Render module content (if module exists)
        if (OptiPlan.modules[moduleId]) {
          if (OptiPlan.modules[moduleId].init) {
            OptiPlan.modules[moduleId].init();
          }
          if (OptiPlan.modules[moduleId].render) {
            var dataKey = config.dataKey;
            var data = MODULE_DATA[dataKey];
            OptiPlan.modules[moduleId].render(data);
          }
        }

        // Clear transitioning flag after animation
        var expandDoneTimeout = setTimeout(function handleExpandDone() {
          _isOverlayTransitioning = false;
        }, 500);
        self._transitionTimeouts.push(expandDoneTimeout);
      },

      close: function(opts) {
        if (_isOverlayTransitioning) return;
        if (!this._currentModuleId) return;
        var self = this;
        opts = opts || {};

        _isOverlayTransitioning = true;

        // Use faster close animation
        this.$overlay.classList.add('module-overlay--closing');

        // Deactivate
        this.$backdrop.classList.remove('module-overlay-backdrop--active');
        this.$overlay.classList.remove('module-overlay--active');

        var closingModuleId = this._currentModuleId;

        // After transition, clean up
        var closeDoneTimeout = setTimeout(function handleCloseDone() {
          if (OptiPlan.modules[closingModuleId] && OptiPlan.modules[closingModuleId].destroy) {
            OptiPlan.modules[closingModuleId].destroy();
          }
          self.$content.innerHTML = '';
          self.$overlay.classList.remove('module-overlay--closing');
          self._currentModuleId = null;
          _isOverlayTransitioning = false;
        }, 350);
        self._transitionTimeouts.push(closeDoneTimeout);

        // Update state
        OptiPlan.state.activeModule = null;
        OptiPlan.state.transition('overview');

        // Reset sidebar to Dashboard
        _resetSidebarToDashboard();

        // Reset card flip state if any card is flipped
        var flippedCard = document.querySelector('.stat-card--flipped');
        if (flippedCard) {
          flippedCard.classList.remove('stat-card--flipped');
        }

        // Clean up history if not triggered by browser back button
        if (!opts.fromPopstate) {
          window.history.back();
        }

        // Restore focus to triggering element
        if (self._triggerElement && self._triggerElement.focus) {
          self._triggerElement.focus();
          self._triggerElement = null;
        }
      },

      _switchModule: function(newModuleId) {
        var self = this;
        _isOverlayTransitioning = true;

        // Close current (fast)
        this.$overlay.classList.add('module-overlay--closing');
        this.$overlay.classList.remove('module-overlay--active');

        var oldModuleId = this._currentModuleId;

        var switchDoneTimeout = setTimeout(function handleSwitchDone() {
          if (OptiPlan.modules[oldModuleId] && OptiPlan.modules[oldModuleId].destroy) {
            OptiPlan.modules[oldModuleId].destroy();
          }
          self.$content.innerHTML = '';
          self.$overlay.classList.remove('module-overlay--closing');
          self._currentModuleId = null;
          _isOverlayTransitioning = false;

          // Open new module
          self.expand(newModuleId);
        }, 350);
        self._transitionTimeouts.push(switchDoneTimeout);
      },

      _bindEvents: function() {
        this.$backBtn.addEventListener('click', handleModuleClose);
        this.$backdrop.addEventListener('click', handleBackdropTap);
        window.addEventListener('popstate', handlePopState);
        document.addEventListener('keydown', handleEscapeKey);
      },

      destroy: function() {
        // Clear all tracked transition timeouts
        for (var i = 0; i < this._transitionTimeouts.length; i++) {
          clearTimeout(this._transitionTimeouts[i]);
        }
        this._transitionTimeouts = [];
        _isOverlayTransitioning = false;

        this.$backBtn.removeEventListener('click', handleModuleClose);
        this.$backdrop.removeEventListener('click', handleBackdropTap);
        window.removeEventListener('popstate', handlePopState);
        document.removeEventListener('keydown', handleEscapeKey);
        if (this._currentModuleId) {
          if (OptiPlan.modules[this._currentModuleId] && OptiPlan.modules[this._currentModuleId].destroy) {
            OptiPlan.modules[this._currentModuleId].destroy();
          }
          this.$content.innerHTML = '';
          this._currentModuleId = null;
        }
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Modules — Placeholder Stubs
    // ================================================================

    // ================================================================
    // MODULE: OptiTrack
    // ================================================================
    OptiPlan.modules.optitrack = {
      $content: null,
      _entranceTimeouts: [],

      init: function() {
        this.$content = document.querySelector('.module-overlay__content');
      },

      render: function(data) {
        var self = this;
        this.$content = document.querySelector('.module-overlay__content');
        if (!this.$content || !data) return;

        // Clear pending entrance timeouts from any previous render
        for (var t = 0; t < this._entranceTimeouts.length; t++) {
          clearTimeout(this._entranceTimeouts[t]);
        }
        this._entranceTimeouts = [];

        var html = '';

        // --- Metrics Summary Row ---
        html += '<div class="optitrack-section optitrack-metrics" data-optitrack-section="metrics">';
        html += self._renderMetricCard(data.totalItems, '\u05E1\u05D4\u05F4\u05DB \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD');
        html += self._renderMetricCard(data.approvalRate + '%', '\u05D0\u05D7\u05D5\u05D6 \u05D0\u05D9\u05E9\u05D5\u05E8\u05D9\u05DD');
        html += self._renderMetricCard(data.objections, '\u05D4\u05EA\u05E0\u05D2\u05D3\u05D5\u05D9\u05D5\u05EA');
        html += self._renderMetricCard(data.pending, '\u05DE\u05DE\u05EA\u05D9\u05E0\u05D9\u05DD');
        html += '</div>';

        // --- Permit Matrix ---
        html += '<div class="optitrack-section" data-optitrack-section="matrix">';
        html += '<div class="optitrack-section-title"><i class="ti ti-table optitrack-section-title__icon"></i>\u05DE\u05D8\u05E8\u05D9\u05E6\u05EA \u05D4\u05D9\u05EA\u05E8\u05D9\u05DD</div>';
        html += '<div class="permit-matrix">';
        html += self._renderPermitMatrix(data);
        html += '</div>';
        html += '</div>';

        // --- Traffic Arrangements & Licensing ---
        if (data.trafficLicensing) {
          html += '<div class="optitrack-section" data-optitrack-section="traffic">';
          html += '<div class="optitrack-section-title"><i class="ti ti-road optitrack-section-title__icon"></i>\u05D4\u05E1\u05D3\u05E8\u05D9 \u05EA\u05E0\u05D5\u05E2\u05D4 \u05D5\u05EA\u05D4\u05DC\u05D9\u05DB\u05D9 \u05E8\u05D9\u05E9\u05D5\u05D9</div>';
          html += '<div class="optirisk-table" style="direction:rtl">';
          html += '<div class="optirisk-table__header">' +
            '<span class="optirisk-table__col optirisk-table__col--name">\u05E7\u05D8\u05E2</span>' +
            '<span class="optirisk-table__col optirisk-table__col--severity">\u05E1\u05D8\u05D8\u05D5\u05E1</span>' +
            '<span class="optirisk-table__col optirisk-table__col--mitigation">\u05E8\u05E9\u05D5\u05EA \u05DE\u05D0\u05E9\u05E8\u05EA</span>' +
            '<span class="optirisk-table__col optirisk-table__col--name">\u05E4\u05E8\u05D8\u05D9\u05DD</span>' +
            '</div>';
          var tlStatusCss = { '\u05D0\u05D5\u05E9\u05E8': 'optirisk-badge--low', '\u05D1\u05EA\u05D4\u05DC\u05D9\u05DA': 'optirisk-badge--active', '\u05DE\u05DE\u05EA\u05D9\u05DF': 'optirisk-badge--medium', '\u05DC\u05D0 \u05D4\u05D5\u05D2\u05E9': 'optirisk-badge--monitoring' };
          for (var tl = 0; tl < data.trafficLicensing.length; tl++) {
            var item = data.trafficLicensing[tl];
            var altClass = tl % 2 === 1 ? ' optirisk-table__row--alt' : '';
            var badgeCss = tlStatusCss[item.status] || 'optirisk-badge--monitoring';
            html += '<div class="optirisk-table__row' + altClass + '">' +
              '<span class="optirisk-table__col optirisk-table__col--name" style="font-weight:600">' + item.section + '</span>' +
              '<span class="optirisk-table__col optirisk-table__col--severity"><span class="optirisk-badge ' + badgeCss + '">' + item.status + '</span></span>' +
              '<span class="optirisk-table__col optirisk-table__col--mitigation">' + item.authority + '</span>' +
              '<span class="optirisk-table__col optirisk-table__col--name">' + item.details + '</span>' +
              '</div>';
          }
          html += '</div>';
          html += '</div>';
        }

        // --- Activity Feed ---
        html += '<div class="optitrack-section" data-optitrack-section="feed">';
        html += '<div class="optitrack-section-title"><i class="ti ti-activity optitrack-section-title__icon"></i>\u05E4\u05D9\u05D3 \u05E4\u05E2\u05D9\u05DC\u05D5\u05EA</div>';
        html += '<div class="activity-feed">';
        for (var i = 0; i < data.activityFeed.length; i++) {
          html += self._renderActivityItem(data.activityFeed[i]);
        }
        html += '</div>';
        html += '</div>';

        this.$content.innerHTML = html;

        // Staggered entrance animation
        var sections = this.$content.querySelectorAll('.optitrack-section');
        for (var s = 0; s < sections.length; s++) {
          (function(section, delay) {
            var timeout = setTimeout(function() {
              section.classList.add('optitrack-section--visible');
            }, delay);
            self._entranceTimeouts.push(timeout);
          })(sections[s], s * 100);
        }
      },

      _renderMetricCard: function(value, label) {
        return '<div class="optitrack-metric">' +
          '<span class="optitrack-metric__value">' + value + '</span>' +
          '<span class="optitrack-metric__label">' + label + '</span>' +
          '</div>';
      },

      _renderPermitMatrix: function(data) {
        var authorities = data.authorities;
        var matrix = data.permitMatrix;

        // SVG dimensions — RTL layout: grid on left, row labels on right
        var colWidth = 80;
        var rowHeight = 40;
        var cellGap = 4;
        var labelWidth = 40;
        var headerHeight = 55;
        var gridWidth = authorities.length * (colWidth + cellGap);
        var svgWidth = gridWidth + labelWidth;
        var svgHeight = headerHeight + (matrix.length * (rowHeight + cellGap));

        var svg = '<svg class="permit-matrix__svg" viewBox="0 0 ' + svgWidth + ' ' + svgHeight + '" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="\u05DE\u05D8\u05E8\u05D9\u05E6\u05EA \u05D4\u05D9\u05EA\u05E8\u05D9\u05DD">';

        // Column headers (authority names) — RTL: first authority on right
        for (var c = 0; c < authorities.length; c++) {
          var cx = gridWidth - c * (colWidth + cellGap) - colWidth / 2;
          svg += '<text class="permit-matrix__col-label" x="' + cx + '" y="' + (headerHeight - 8) + '" text-anchor="middle">' + authorities[c].name + '</text>';
        }

        // Rows
        var statusLabels = {
          'approved': '\u2713',
          'pending': '?',
          'objection': '\u2717',
          'not-submitted': '\u2014',
          'in-review': '\u25CB'
        };

        for (var r = 0; r < matrix.length; r++) {
          var row = matrix[r];
          var ry = headerHeight + r * (rowHeight + cellGap);

          // Row label — RTL: on the right side
          svg += '<text class="permit-matrix__label" x="' + (gridWidth + 8) + '" y="' + (ry + rowHeight / 2 + 4) + '" text-anchor="start">' + row.section.toUpperCase() + '</text>';

          // Cells — RTL: first authority column on right
          for (var col = 0; col < authorities.length; col++) {
            var status = row.statuses[col];
            var cellX = gridWidth - (col + 1) * (colWidth + cellGap) + cellGap;
            var cssClass = 'permit-cell--' + status;
            var label = statusLabels[status] || status;

            svg += '<rect class="' + cssClass + '" x="' + cellX + '" y="' + ry + '" width="' + colWidth + '" height="' + rowHeight + '" rx="4" />';
            svg += '<text class="permit-matrix__cell-text" x="' + (cellX + colWidth / 2) + '" y="' + (ry + rowHeight / 2 + 4) + '" text-anchor="middle">' + label + '</text>';
          }
        }

        svg += '</svg>';
        return svg;
      },

      _renderActivityItem: function(item) {
        var firstLetter = item.name.charAt(0);
        var avatarColor = this._getAvatarColor(firstLetter);
        var relativeTime = item.timestamp;
        var badgeInfo = this._getStatusBadge(item.status);

        return '<div class="activity-item">' +
          '<div class="activity-item__avatar" style="background:' + avatarColor + '">' + firstLetter + '</div>' +
          '<div class="activity-item__body">' +
            '<div class="activity-item__header">' +
              '<span class="activity-item__name">' + item.name + '</span>' +
              '<span class="activity-item__time">' + relativeTime + '</span>' +
            '</div>' +
            '<p class="activity-item__desc">' + item.description + '</p>' +
          '</div>' +
          '<span class="activity-item__badge activity-item__badge--' + item.status + '">' + badgeInfo + '</span>' +
        '</div>';
      },

      _getAvatarColor: function(letter) {
        var colors = ['var(--optigantt)', 'var(--optidocs)', 'var(--optitrack)', 'var(--optibiz)', 'var(--optirisk)', 'var(--status-online)'];
        var code = letter.charCodeAt(0);
        return colors[code % colors.length];
      },

      _getStatusBadge: function(status) {
        var labels = {
          approved: '\u05DE\u05D0\u05D5\u05E9\u05E8',
          pending: '\u05DE\u05DE\u05EA\u05D9\u05DF',
          objection: '\u05D4\u05EA\u05E0\u05D2\u05D3\u05D5\u05EA',
          'in-review': '\u05D1\u05D1\u05D3\u05D9\u05E7\u05D4'
        };
        return labels[status] || status;
      },

      destroy: function() {
        // Clear entrance timeouts
        for (var i = 0; i < this._entranceTimeouts.length; i++) {
          clearTimeout(this._entranceTimeouts[i]);
        }
        this._entranceTimeouts = [];
        if (this.$content) this.$content.innerHTML = '';
        this.$content = null;
      }
    };

    // ================================================================
    // MODULE: OptiBiz
    // ================================================================
    OptiPlan.modules.optibiz = {
      $content: null,
      _entranceTimeouts: [],

      init: function() {
        this.$content = document.querySelector('.module-overlay__content');
      },

      render: function(data) {
        var self = this;
        if (!this.$content || !data) return;

        // Clear pending entrance timeouts from any previous render
        for (var t = 0; t < this._entranceTimeouts.length; t++) {
          clearTimeout(this._entranceTimeouts[t]);
        }
        this._entranceTimeouts = [];

        var fmt = OptiPlan.utils.formatCurrencyShort;
        var html = '';

        // --- Financial KPI Metrics Row ---
        html += '<div class="optibiz-section optibiz-metrics" data-optibiz-section="metrics">';
        html += self._renderMetricWithBar(
          fmt(data.budgetUtilized) + ' / ' + fmt(data.budgetTotal),
          '\u05E0\u05D9\u05E6\u05D5\u05DC \u05EA\u05E7\u05E6\u05D9\u05D1',
          data.budgetUtilization
        );
        html += self._renderMetricCard(data.budgetUtilization + '%', '\u05D0\u05D7\u05D5\u05D6 \u05E0\u05D9\u05E6\u05D5\u05DC');
        html += self._renderMetricCard(fmt(data.burnRate), '\u05E7\u05E6\u05D1 \u05E9\u05E8\u05D9\u05E4\u05D4 \u05D7\u05D5\u05D3\u05E9\u05D9');
        html += self._renderVarianceCard(data.variance);
        html += '</div>';

        // --- Cash Flow Chart ---
        html += '<div class="optibiz-section optibiz-chart-wrap" data-optibiz-section="chart">';
        html += '<div class="optibiz-section-title"><i class="ti ti-chart-bar optibiz-section-title__icon"></i>\u05EA\u05D6\u05E8\u05D9\u05DD \u05DE\u05D6\u05D5\u05DE\u05E0\u05D9\u05DD \u2014 ' + data.cashFlow.length + ' \u05D7\u05D5\u05D3\u05E9\u05D9\u05DD</div>';
        html += self._renderCashFlowChart(data);
        html += '</div>';

        // --- Legend ---
        html += '<div class="optibiz-section optibiz-legend" data-optibiz-section="legend">';
        html += '<div class="optibiz-legend__item"><span class="optibiz-legend__swatch optibiz-legend__swatch--plan"></span><span class="optibiz-legend__label">\u05EA\u05DB\u05E0\u05D5\u05DF</span></div>';
        html += '<div class="optibiz-legend__item"><span class="optibiz-legend__swatch optibiz-legend__swatch--actual"></span><span class="optibiz-legend__label">\u05D1\u05D9\u05E6\u05D5\u05E2</span></div>';
        html += '<div class="optibiz-legend__item"><span class="optibiz-legend__line"></span><span class="optibiz-legend__label">\u05DE\u05E6\u05D8\u05D1\u05E8</span></div>';
        html += '</div>';

        this.$content.innerHTML = html;

        // Staggered entrance animation
        var sections = this.$content.querySelectorAll('.optibiz-section');
        for (var s = 0; s < sections.length; s++) {
          (function(section, delay) {
            var timeout = setTimeout(function() {
              section.classList.add('optibiz-section--visible');
            }, delay);
            self._entranceTimeouts.push(timeout);
          })(sections[s], s * 100);
        }
      },

      _renderMetricCard: function(value, label) {
        return '<div class="optibiz-metric">' +
          '<span class="optibiz-metric__value">' + value + '</span>' +
          '<span class="optibiz-metric__label">' + label + '</span>' +
          '</div>';
      },

      _renderMetricWithBar: function(value, label, percent) {
        return '<div class="optibiz-metric">' +
          '<span class="optibiz-metric__value">' + value + '</span>' +
          '<span class="optibiz-metric__label">' + label + '</span>' +
          '<div class="optibiz-metric__bar">' +
            '<div class="optibiz-metric__bar-fill" style="width: ' + percent + '%"></div>' +
          '</div>' +
          '</div>';
      },

      _renderVarianceCard: function(variance) {
        var isNegative = variance < 0;
        var formatted = (isNegative ? '-' : '+') + OptiPlan.utils.formatCurrencyShort(variance);
        var cssClass = isNegative ? ' optibiz-metric__value--negative' : '';
        return '<div class="optibiz-metric">' +
          '<span class="optibiz-metric__value' + cssClass + '">' + formatted + '</span>' +
          '<span class="optibiz-metric__label">\u05E1\u05D8\u05D9\u05D9\u05D4</span>' +
          '</div>';
      },

      _renderCashFlowChart: function(data) {
        var fmt = OptiPlan.utils.formatCurrencyShort;

        // Chart dimensions (viewBox units)
        var svgWidth = 720;
        var svgHeight = 320;
        var leftMargin = 80;
        var rightMargin = 60;
        var topMargin = 20;
        var bottomMargin = 40;
        var chartWidth = svgWidth - leftMargin - rightMargin;
        var chartHeight = svgHeight - topMargin - bottomMargin;
        var monthCount = data.cashFlow.length;
        var groupWidth = chartWidth / monthCount;
        var barWidth = groupWidth * 0.35;
        var barGap = 2;

        // Single pass: compute maxVal, cumulativeMax, and cumulative data points
        var maxVal = 0;
        var cumulative = 0;
        var cumulativeData = [];
        for (var i = 0; i < monthCount; i++) {
          if (data.cashFlow[i].plan > maxVal) maxVal = data.cashFlow[i].plan;
          if (data.cashFlow[i].actual > maxVal) maxVal = data.cashFlow[i].actual;
          cumulative += data.cashFlow[i].actual;
          cumulativeData.push(cumulative);
        }
        maxVal = Math.ceil(maxVal / 20000000) * 20000000;
        var cumulativeMax = Math.ceil(cumulative / 200000000) * 200000000;

        var svg = '<svg class="optibiz-chart__svg" viewBox="0 0 ' + svgWidth + ' ' + svgHeight + '" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="\u05EA\u05E8\u05E9\u05D9\u05DD \u05EA\u05D6\u05E8\u05D9\u05DD \u05DE\u05D6\u05D5\u05DE\u05E0\u05D9\u05DD">';

        // Grid lines and Y-axis labels (left — monthly)
        var tickCount = 5;
        for (var t = 0; t <= tickCount; t++) {
          var tickVal = (maxVal / tickCount) * t;
          var tickY = topMargin + chartHeight - (tickVal / maxVal * chartHeight);
          svg += '<line class="optibiz-chart__grid-line" x1="' + leftMargin + '" y1="' + tickY + '" x2="' + (svgWidth - rightMargin) + '" y2="' + tickY + '" />';
          svg += '<text class="optibiz-chart__axis-label" x="' + (leftMargin - 8) + '" y="' + (tickY + 3) + '" text-anchor="end">' + fmt(tickVal) + '</text>';
        }

        // Right Y-axis labels (cumulative — forced billions scale)
        var rightTickCount = 4;
        for (var rt = 0; rt <= rightTickCount; rt++) {
          var rTickVal = (cumulativeMax / rightTickCount) * rt;
          var rTickY = topMargin + chartHeight - (rTickVal / cumulativeMax * chartHeight);
          svg += '<text class="optibiz-chart__axis-label--right" x="' + (svgWidth - rightMargin + 8) + '" y="' + (rTickY + 3) + '" text-anchor="start">' + fmt(rTickVal, 'B') + '</text>';
        }

        // Bars and month labels
        var trendPoints = [];
        for (var m = 0; m < monthCount; m++) {
          var entry = data.cashFlow[m];
          var groupX = leftMargin + (m * groupWidth);
          var planBarX = groupX + (groupWidth - 2 * barWidth - barGap) / 2;
          var actualBarX = planBarX + barWidth + barGap;

          // Plan bar
          var planH = (entry.plan / maxVal) * chartHeight;
          var planY = topMargin + chartHeight - planH;
          svg += '<rect class="optibiz-bar--plan" x="' + planBarX + '" y="' + planY + '" width="' + barWidth + '" height="' + planH + '" rx="2" />';

          // Actual bar
          var actualH = (entry.actual / maxVal) * chartHeight;
          var actualY = topMargin + chartHeight - actualH;
          svg += '<rect class="optibiz-bar--actual" x="' + actualBarX + '" y="' + actualY + '" width="' + barWidth + '" height="' + actualH + '" rx="2" />';

          // X-axis month label
          var labelX = groupX + groupWidth / 2;
          svg += '<text class="optibiz-chart__month-label" x="' + labelX + '" y="' + (topMargin + chartHeight + 20) + '" text-anchor="middle">' + data.monthLabels[m] + '</text>';

          // Collect trend point
          var px = leftMargin + (m * groupWidth) + groupWidth / 2;
          var py = topMargin + chartHeight - (cumulativeData[m] / cumulativeMax * chartHeight);
          trendPoints.push(px + ',' + py);
        }

        // Running total trend line (uses right axis scale)
        svg += '<polyline class="optibiz-trend-line" points="' + trendPoints.join(' ') + '" />';

        // Trend line data point markers
        for (var d = 0; d < monthCount; d++) {
          var dx = leftMargin + (d * groupWidth) + groupWidth / 2;
          var dy = topMargin + chartHeight - (cumulativeData[d] / cumulativeMax * chartHeight);
          svg += '<circle class="optibiz-trend-dot" cx="' + dx + '" cy="' + dy + '" r="3" />';
        }

        svg += '</svg>';
        return svg;
      },

      destroy: function() {
        for (var i = 0; i < this._entranceTimeouts.length; i++) {
          clearTimeout(this._entranceTimeouts[i]);
        }
        this._entranceTimeouts = [];
        if (this.$content) this.$content.innerHTML = '';
        this.$content = null;
      }
    };

    // ================================================================
    // MODULE: OptiRisk
    // ================================================================
    OptiPlan.modules.optirisk = {
      $content: null,
      _entranceTimeouts: [],

      init: function() {
        this.$content = document.querySelector('.module-overlay__content');
      },

      render: function(data) {
        var self = this;
        this.$content = document.querySelector('.module-overlay__content');
        if (!this.$content || !data) return;

        // Clear pending entrance timeouts from any previous render
        for (var t = 0; t < this._entranceTimeouts.length; t++) {
          clearTimeout(this._entranceTimeouts[t]);
        }
        this._entranceTimeouts = [];

        var html = '';

        // --- Metrics Summary Row ---
        html += '<div class="optirisk-section optirisk-metrics" data-optirisk-section="metrics">';
        html += self._renderMetricCard(data.activeRisks, '\u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD \u05E4\u05E2\u05D9\u05DC\u05D9\u05DD', false);
        html += self._renderMetricCard(data.critical, '\u05E7\u05E8\u05D9\u05D8\u05D9\u05D9\u05DD', true);
        var occupiedCells = 0;
        for (var r = 0; r < data.heatMap.length; r++) {
          for (var c = 0; c < data.heatMap[r].length; c++) {
            if (data.heatMap[r][c] > 0) occupiedCells++;
          }
        }
        html += self._renderMetricCard(occupiedCells + '/25', '\u05EA\u05D0\u05D9 \u05E1\u05D9\u05DB\u05D5\u05DF \u05E4\u05E2\u05D9\u05DC\u05D9\u05DD', false);
        html += '</div>';

        // --- Heat Map Section ---
        html += '<div class="optirisk-section optirisk-heatmap-wrap" data-optirisk-section="heatmap">';
        html += '<div class="optirisk-section-title"><i class="ti ti-chart-dots-3 optirisk-section-title__icon"></i>\u05DE\u05E4\u05EA \u05D7\u05D5\u05DD \u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD</div>';
        html += self._renderHeatMap(data);
        // --- Color Scale Legend ---
        html += self._renderLegend();
        html += '</div>';

        // --- Top Risks Table ---
        html += '<div class="optirisk-section" data-optirisk-section="table">';
        html += '<div class="optirisk-section-title"><i class="ti ti-list-details optirisk-section-title__icon"></i>\u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD \u05DE\u05D5\u05D1\u05D9\u05DC\u05D9\u05DD</div>';
        html += self._renderTopRisksTable(data);
        html += '</div>';

        this.$content.innerHTML = html;

        // Staggered entrance animation (skip delays for reduced-motion)
        var sections = this.$content.querySelectorAll('.optirisk-section');
        var prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) {
          for (var s = 0; s < sections.length; s++) {
            sections[s].classList.add('optirisk-section--visible');
          }
        } else {
          for (var s = 0; s < sections.length; s++) {
            (function(section, delay) {
              var timeout = setTimeout(function() {
                section.classList.add('optirisk-section--visible');
              }, delay);
              self._entranceTimeouts.push(timeout);
            })(sections[s], s * 100);
          }
        }
      },

      _renderMetricCard: function(value, label, isCritical) {
        var valueClass = 'optirisk-metric__value';
        if (isCritical) valueClass += ' optirisk-metric__value--critical';
        return '<div class="optirisk-metric">' +
          '<span class="' + valueClass + '">' + value + '</span>' +
          '<span class="optirisk-metric__label">' + label + '</span>' +
          '</div>';
      },

      _getZone: function(row, col) {
        var sum = row + col;
        if (sum <= 1) return 0;
        if (sum <= 3) return 1;
        if (sum <= 4) return 2;
        if (sum <= 6) return 3;
        return 4;
      },

      _renderHeatMap: function(data) {
        var self = this;
        var gridStartX = 110;
        var gridStartY = 30;
        var cellWidth = 52;
        var cellHeight = 44;
        var cellGap = 4;
        var gridWidth = 5 * (cellWidth + cellGap) - cellGap;
        var gridHeight = 5 * (cellHeight + cellGap) - cellGap;
        var svgWidth = gridStartX + gridWidth + 20;
        var svgHeight = gridStartY + gridHeight + 50;

        var svg = '<svg class="optirisk-heatmap__svg" viewBox="0 0 ' + svgWidth + ' ' + svgHeight + '" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="\u05DE\u05E4\u05EA \u05D7\u05D5\u05DD \u05E1\u05D9\u05DB\u05D5\u05E0\u05D9\u05DD">';

        // Y-axis title (Probability)
        var axisTitleY = gridStartY + gridHeight / 2;
        svg += '<text class="optirisk-heatmap__axis-title" x="12" y="' + axisTitleY + '" text-anchor="middle" transform="rotate(-90, 12, ' + axisTitleY + ')">\u05E1\u05D1\u05D9\u05E8\u05D5\u05EA</text>';

        // Row labels (probability — Hebrew, low at bottom, high at top)
        for (var r = 0; r < 5; r++) {
          var visualRow = 4 - r;
          var cy = gridStartY + visualRow * (cellHeight + cellGap) + cellHeight / 2 + 4;
          svg += '<text class="optirisk-heatmap__row-label" x="' + (gridStartX - 8) + '" y="' + cy + '" text-anchor="end">' + data.probLabels[r] + '</text>';
        }

        // Grid cells
        for (var row = 0; row < 5; row++) {
          for (var col = 0; col < 5; col++) {
            var visualRow = 4 - row;
            var x = gridStartX + col * (cellWidth + cellGap);
            var y = gridStartY + visualRow * (cellHeight + cellGap);
            var zone = self._getZone(row, col);
            var count = data.heatMap[row][col];

            svg += '<rect class="risk-cell--zone-' + zone + '" x="' + x + '" y="' + y + '" width="' + cellWidth + '" height="' + cellHeight + '" rx="4" />';

            var countClass = count > 0 ? (zone <= 1 ? 'optirisk-heatmap__count--bright' : 'optirisk-heatmap__count--nonzero') : 'optirisk-heatmap__count--zero';
            svg += '<text class="optirisk-heatmap__count ' + countClass + '" x="' + (x + cellWidth / 2) + '" y="' + (y + cellHeight / 2 + 5) + '" text-anchor="middle">' + count + '</text>';
          }
        }

        // Column labels (impact — Hebrew)
        var gridBottom = gridStartY + gridHeight;
        for (var c = 0; c < 5; c++) {
          var cx = gridStartX + c * (cellWidth + cellGap) + cellWidth / 2;
          svg += '<text class="optirisk-heatmap__col-label" x="' + cx + '" y="' + (gridBottom + 20) + '" text-anchor="middle">' + data.impactLabels[c] + '</text>';
        }

        // X-axis title (Impact)
        var axisTitleX = gridStartX + gridWidth / 2;
        svg += '<text class="optirisk-heatmap__axis-title" x="' + axisTitleX + '" y="' + (gridBottom + 40) + '" text-anchor="middle">\u05D4\u05E9\u05E4\u05E2\u05D4</text>';

        svg += '</svg>';
        return svg;
      },

      _renderLegend: function() {
        var labels = ['\u05E0\u05DE\u05D5\u05DA', '\u05E0\u05DE\u05D5\u05DA-\u05D1\u05D9\u05E0\u05D5\u05E0\u05D9', '\u05D1\u05D9\u05E0\u05D5\u05E0\u05D9', '\u05D2\u05D1\u05D5\u05D4', '\u05E7\u05E8\u05D9\u05D8\u05D9'];
        var html = '<div class="optirisk-legend">';
        for (var i = 0; i < labels.length; i++) {
          html += '<div class="optirisk-legend__item">' +
            '<span class="optirisk-legend__swatch optirisk-legend__swatch--zone-' + i + '"></span>' +
            '<span class="optirisk-legend__label">' + labels[i] + '</span>' +
            '</div>';
        }
        html += '</div>';
        return html;
      },

      _renderTopRisksTable: function(data) {
        var severityLabels = {
          critical: '\u05E7\u05E8\u05D9\u05D8\u05D9',
          high: '\u05D2\u05D1\u05D5\u05D4',
          medium: '\u05D1\u05D9\u05E0\u05D5\u05E0\u05D9',
          low: '\u05E0\u05DE\u05D5\u05DA'
        };
        var mitigationLabels = {
          active: '\u05D8\u05D9\u05E4\u05D5\u05DC \u05E4\u05E2\u05D9\u05DC',
          monitoring: '\u05E0\u05D9\u05D8\u05D5\u05E8',
          resolved: '\u05D8\u05D5\u05E4\u05DC',
          'legal-review': '\u05D1\u05D3\u05D9\u05E7\u05D4 \u05DE\u05E9\u05E4\u05D8\u05D9\u05EA'
        };
        var trendMap = {
          up: { arrow: '\u2191', cssClass: 'optirisk-trend--up' },
          down: { arrow: '\u2193', cssClass: 'optirisk-trend--down' },
          stable: { arrow: '\u2192', cssClass: 'optirisk-trend--stable' }
        };

        var html = '<div class="optirisk-table">';

        // Table header
        html += '<div class="optirisk-table__header">' +
          '<span class="optirisk-table__col optirisk-table__col--name">\u05E1\u05D9\u05DB\u05D5\u05DF</span>' +
          '<span class="optirisk-table__col optirisk-table__col--severity">\u05D7\u05D5\u05DE\u05E8\u05D4</span>' +
          '<span class="optirisk-table__col optirisk-table__col--trend">\u05DE\u05D2\u05DE\u05D4</span>' +
          '<span class="optirisk-table__col optirisk-table__col--mitigation">\u05E1\u05D8\u05D8\u05D5\u05E1 \u05D8\u05D9\u05E4\u05D5\u05DC</span>' +
          '</div>';

        // Table rows
        for (var i = 0; i < data.topRisks.length; i++) {
          var risk = data.topRisks[i];
          var altClass = i % 2 === 1 ? ' optirisk-table__row--alt' : '';
          var trend = trendMap[risk.trend] || trendMap.stable;

          html += '<div class="optirisk-table__row' + altClass + '">' +
            '<span class="optirisk-table__col optirisk-table__col--name">' + risk.name + '</span>' +
            '<span class="optirisk-table__col optirisk-table__col--severity"><span class="optirisk-badge optirisk-badge--' + risk.severity + '">' + (severityLabels[risk.severity] || risk.severity) + '</span></span>' +
            '<span class="optirisk-table__col optirisk-table__col--trend"><span class="optirisk-trend ' + trend.cssClass + '">' + trend.arrow + '</span></span>' +
            '<span class="optirisk-table__col optirisk-table__col--mitigation"><span class="optirisk-badge optirisk-badge--' + risk.mitigation + '">' + (mitigationLabels[risk.mitigation] || risk.mitigation) + '</span></span>' +
            '</div>';
        }

        html += '</div>';
        return html;
      },

      destroy: function() {
        for (var i = 0; i < this._entranceTimeouts.length; i++) {
          clearTimeout(this._entranceTimeouts[i]);
        }
        this._entranceTimeouts = [];
        if (this.$content) this.$content.innerHTML = '';
        this.$content = null;
      }
    };

    // ================================================================
    // MODULE: OptiDocs
    // ================================================================
    OptiPlan.modules.optidocs = {
      $content: null,
      _entranceTimeouts: [],

      init: function() {
        this.$content = document.querySelector('.module-overlay__content');
      },

      render: function(data) {
        var self = this;
        this.$content = document.querySelector('.module-overlay__content');
        if (!this.$content || !data) return;

        // Clear pending entrance timeouts from any previous render
        for (var t = 0; t < this._entranceTimeouts.length; t++) {
          clearTimeout(this._entranceTimeouts[t]);
        }
        this._entranceTimeouts = [];

        var statusLabels = {
          approved: '\u05D0\u05D5\u05E9\u05E8',
          pending: '\u05DE\u05DE\u05EA\u05D9\u05DF',
          overdue: '\u05D1\u05D0\u05D9\u05D7\u05D5\u05E8'
        };

        var html = '';

        // --- Metrics Summary Row ---
        html += '<div class="optidocs-section optidocs-metrics">';
        html += self._renderMetricCard(data.total, '\u05E1\u05D4\u05F4\u05DB \u05DE\u05E1\u05DE\u05DB\u05D9\u05DD', '');
        html += self._renderMetricCard(data.completionRate + '%', '\u05D0\u05D7\u05D5\u05D6 \u05D4\u05E9\u05DC\u05DE\u05D4', '');
        html += self._renderMetricCard(data.pending, '\u05DE\u05DE\u05EA\u05D9\u05E0\u05D9\u05DD', '');
        html += self._renderMetricCard(data.overdue, '\u05D1\u05D0\u05D9\u05D7\u05D5\u05E8', 'optidocs-metric__value--overdue');
        html += '</div>';

        // --- Document Table ---
        html += '<div class="optidocs-section optidocs-table-wrapper">';
        html += '<div class="optidocs-table">';

        // Header row
        html += '<div class="optidocs-table__header">';
        html += '<span class="optidocs-table__col optidocs-table__col--header">\u05DE\u05E1\u05DE\u05DA</span>';
        html += '<span class="optidocs-table__col optidocs-table__col--header">\u05E1\u05D5\u05D2</span>';
        html += '<span class="optidocs-table__col optidocs-table__col--header">\u05E1\u05D8\u05D8\u05D5\u05E1</span>';
        html += '<span class="optidocs-table__col optidocs-table__col--header">\u05EA\u05D0\u05E8\u05D9\u05DA</span>';
        html += '<span class="optidocs-table__col optidocs-table__col--header">\u05D0\u05D7\u05E8\u05D0\u05D9</span>';
        html += '</div>';

        // Data rows
        for (var i = 0; i < data.documents.length; i++) {
          var doc = data.documents[i];
          var altClass = i % 2 === 1 ? ' optidocs-table__row--alt' : '';
          var statusKey = doc.status;
          var statusLabel = statusLabels[statusKey] || statusKey;
          var formattedDate = OptiPlan.utils.formatDate(doc.date);

          html += '<div class="optidocs-table__row' + altClass + '">';
          html += '<span class="optidocs-table__col optidocs-table__col--name">' + doc.name + '</span>';
          html += '<span class="optidocs-table__col optidocs-table__col--type">' + doc.type + '</span>';
          html += '<span class="optidocs-table__col optidocs-table__col--status"><span class="optidocs-badge optidocs-badge--' + statusKey + '">' + statusLabel + '</span></span>';
          html += '<span class="optidocs-table__col optidocs-table__col--date">' + formattedDate + '</span>';
          html += '<span class="optidocs-table__col optidocs-table__col--assignee"><span class="optidocs-assignee">' + doc.assignee + '</span></span>';
          html += '</div>';
        }

        html += '</div>';
        html += '</div>';

        this.$content.innerHTML = html;

        // Staggered entrance animation (skip delays for reduced-motion)
        var sections = this.$content.querySelectorAll('.optidocs-section');
        var prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (prefersReducedMotion) {
          for (var s = 0; s < sections.length; s++) {
            sections[s].classList.add('optidocs-section--visible');
          }
        } else {
          for (var s = 0; s < sections.length; s++) {
            (function(section, delay) {
              var timeout = setTimeout(function applyDocsVisible() {
                section.classList.add('optidocs-section--visible');
              }, delay);
              self._entranceTimeouts.push(timeout);
            })(sections[s], s * 100);
          }
        }
      },

      _renderMetricCard: function(value, label, valueClass) {
        var cls = 'optidocs-metric__value';
        if (valueClass) cls += ' ' + valueClass;
        return '<div class="optidocs-metric">' +
          '<span class="' + cls + '">' + value + '</span>' +
          '<span class="optidocs-metric__label">' + label + '</span>' +
          '</div>';
      },

      destroy: function() {
        for (var i = 0; i < this._entranceTimeouts.length; i++) {
          clearTimeout(this._entranceTimeouts[i]);
        }
        this._entranceTimeouts = [];
        if (this.$content) this.$content.innerHTML = '';
        this.$content = null;
      }
    };

    // ================================================================
    // MODULE: OptiGantt
    // ================================================================
    OptiPlan.modules.optigantt = {
      $content: null,
      _entranceTimeouts: [],

      init: function() {
        this.$content = document.querySelector('.module-overlay__content');
      },

      render: function(data) {
        var self = this;
        this.$content = document.querySelector('.module-overlay__content');
        if (!this.$content || !data) return;

        // Clear pending entrance timeouts from any previous render
        for (var t = 0; t < this._entranceTimeouts.length; t++) {
          clearTimeout(this._entranceTimeouts[t]);
        }
        this._entranceTimeouts = [];

        var html = '';

        // --- Task 1: Metrics Summary Row ---
        var totalSections = data.sections.length;
        var onTrack = 0;
        var delayed = 0;
        for (var m = 0; m < data.sections.length; m++) {
          if (data.sections[m].progress >= 50) {
            onTrack++;
          } else {
            delayed++;
          }
        }
        var milestoneCount = data.milestones.length;

        html += '<div class="optigantt-section optigantt-metrics" data-optigantt-section="metrics">';
        html += self._renderMetricCard(totalSections, '\u05E7\u05D8\u05E2\u05D9\u05DD');
        html += self._renderMetricCard(onTrack, '\u05D1\u05DE\u05E1\u05DC\u05D5\u05DC');
        html += self._renderMetricCard(delayed, '\u05D1\u05E2\u05D9\u05DB\u05D5\u05D1');
        html += self._renderMetricCard(milestoneCount, '\u05D0\u05D1\u05E0\u05D9 \u05D3\u05E8\u05DA');
        html += '</div>';

        // --- Tasks 2-7: SVG Gantt Chart ---
        html += '<div class="optigantt-section optigantt-chart" data-optigantt-section="chart">';
        html += self._renderGanttChart(data);
        html += '</div>';

        this.$content.innerHTML = html;

        // --- Task 9: Staggered entrance animation ---
        var sections = this.$content.querySelectorAll('.optigantt-section');
        for (var s = 0; s < sections.length; s++) {
          (function(section, delay) {
            var timeout = setTimeout(function applyGanttVisible() {
              section.classList.add('optigantt-section--visible');
            }, delay);
            self._entranceTimeouts.push(timeout);
          })(sections[s], s * 100);
        }
      },

      _renderMetricCard: function(value, label) {
        return '<div class="optigantt-metric">' +
          '<span class="optigantt-metric__value">' + value + '</span>' +
          '<span class="optigantt-metric__label">' + label + '</span>' +
          '</div>';
      },

      _renderGanttChart: function(data) {
        // Chart dimensions (viewBox units)
        var svgWidth = 920;
        var svgHeight = 340;
        var labelAreaWidth = 170;
        var gridStartX = 20;
        var gridEndX = svgWidth - labelAreaWidth;
        var gridWidth = gridEndX - gridStartX;
        var topPadding = 30;
        var bottomPadding = 30;
        var rowCount = data.sections.length;
        var rowHeight = 40;
        var gridHeight = rowCount * rowHeight;
        var gridStartY = topPadding;
        var gridEndY = gridStartY + gridHeight;

        // Timeline date range
        var timelineStart = new Date('2022-04-01');
        var timelineEnd = new Date('2027-12-31');
        var totalMs = timelineEnd.getTime() - timelineStart.getTime();

        // Date to X position helper
        function dateToX(dateStr) {
          var d = new Date(dateStr);
          var elapsedMs = d.getTime() - timelineStart.getTime();
          return gridStartX + (elapsedMs / totalMs) * gridWidth;
        }

        var svg = '<svg class="optigantt-chart__svg" viewBox="0 0 ' + svgWidth + ' ' + svgHeight + '" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="\u05DC\u05D5\u05D7 \u05D6\u05DE\u05E0\u05D9\u05DD \u2014 \u05EA\u05E8\u05E9\u05D9\u05DD \u05D2\u05E0\u05D8">';

        // --- Task 2: Monthly column grid lines and x-axis labels ---
        var startYear = 2022;
        var startMonth = 4; // April 2022
        var endYear = 2027;
        var endMonth = 12;

        for (var y = startYear; y <= endYear; y++) {
          var mStart = (y === startYear) ? startMonth : 1;
          var mEnd = (y === endYear) ? endMonth : 12;
          for (var mo = mStart; mo <= mEnd; mo++) {
            var monthStr = y + '-' + (mo < 10 ? '0' : '') + mo + '-01';
            var x = dateToX(monthStr);

            // Grid line
            svg += '<line class="optigantt-chart__grid-line" x1="' + x + '" y1="' + gridStartY + '" x2="' + x + '" y2="' + gridEndY + '" />';

            // Year label at January
            if (mo === 1) {
              svg += '<text class="optigantt-chart__year-label" x="' + x + '" y="' + (gridStartY - 6) + '" text-anchor="middle">' + y + '</text>';
            }
            // Quarter labels (every 3 months: Jan, Apr, Jul, Oct)
            if (mo % 3 === 1) {
              var monthNames = ['', '\u05D9\u05E0\u05D5\u05F3', '\u05E4\u05D1\u05E8\u05F3', '\u05DE\u05E8\u05E5', '\u05D0\u05E4\u05E8\u05F3', '\u05DE\u05D0\u05D9', '\u05D9\u05D5\u05E0\u05F3', '\u05D9\u05D5\u05DC\u05F3', '\u05D0\u05D5\u05D2\u05F3', '\u05E1\u05E4\u05D8\u05F3', '\u05D0\u05D5\u05E7\u05F3', '\u05E0\u05D5\u05D1\u05F3', '\u05D3\u05E6\u05DE\u05F3'];
              svg += '<text class="optigantt-chart__axis-label" x="' + x + '" y="' + (gridEndY + 15) + '" text-anchor="middle">' + monthNames[mo] + '</text>';
            }
          }
        }

        // --- Task 3: Section Row Labels (Y-Axis) ---
        var sectionIdLabels = ['A1', 'A2', 'A3', 'A4', 'A5', 'A6'];
        for (var r = 0; r < rowCount; r++) {
          var rowCenterY = gridStartY + (r * rowHeight) + (rowHeight / 2);
          var sectionLabel = sectionIdLabels[r] + ' ' + data.sections[r].name;
          svg += '<text class="optigantt-chart__row-label" x="' + (gridEndX + 8) + '" y="' + (rowCenterY + 4) + '" text-anchor="start">' + sectionLabel + '</text>';

          // Row separator lines (between sections)
          if (r < rowCount - 1) {
            var separatorY = gridStartY + ((r + 1) * rowHeight);
            svg += '<line class="optigantt-chart__row-separator" x1="' + gridStartX + '" y1="' + separatorY + '" x2="' + gridEndX + '" y2="' + separatorY + '" />';
          }
        }

        // --- Task 4: Planned Duration Bars ---
        var barHeight = 20;
        var barRx = 3;
        for (var p = 0; p < data.sections.length; p++) {
          var sec = data.sections[p];
          var planX1 = dateToX(sec.plannedStart);
          var planX2 = dateToX(sec.plannedEnd);
          var planWidth = planX2 - planX1;
          var barY = gridStartY + (p * rowHeight) + (rowHeight - barHeight) / 2;

          svg += '<rect class="optigantt-bar--plan" x="' + planX1 + '" y="' + barY + '" width="' + planWidth + '" height="' + barHeight + '" rx="' + barRx + '" />';
        }

        // --- Task 5: Actual Progress Bars ---
        for (var a = 0; a < data.sections.length; a++) {
          var secA = data.sections[a];
          var actStartX = dateToX(secA.actualStart);
          var actBarY = gridStartY + (a * rowHeight) + (rowHeight - barHeight) / 2;
          var actEndX;

          if (secA.actualEnd !== null) {
            // Section complete — use actual end date
            actEndX = dateToX(secA.actualEnd);
          } else {
            // In progress — calculate from progress percentage
            var plannedDurationMs = new Date(secA.plannedEnd).getTime() - new Date(secA.plannedStart).getTime();
            var progressMs = plannedDurationMs * (secA.progress / 100);
            var progressDate = new Date(new Date(secA.actualStart).getTime() + progressMs);
            actEndX = gridStartX + ((progressDate.getTime() - timelineStart.getTime()) / totalMs) * gridWidth;
          }

          var actWidth = actEndX - actStartX;
          if (actWidth > 0) {
            svg += '<rect class="optigantt-bar--actual" x="' + actStartX + '" y="' + actBarY + '" width="' + actWidth + '" height="' + barHeight + '" rx="' + barRx + '" />';
          }
        }

        // --- Task 6: Diamond Milestone Markers ---
        for (var mi = 0; mi < data.milestones.length; mi++) {
          var ms = data.milestones[mi];
          var msX = dateToX(ms.date);

          // Find row index for this milestone's section
          var msRowIdx = 0;
          for (var si = 0; si < data.sections.length; si++) {
            if (data.sections[si].id === ms.section) {
              msRowIdx = si;
              break;
            }
          }
          var msCenterY = gridStartY + (msRowIdx * rowHeight) + (rowHeight / 2);
          var diamondSize = 5;

          // Determine CSS class based on milestone type
          var milestoneClass = 'optigantt-milestone';
          if (ms.type === 'review') {
            milestoneClass += ' optigantt-milestone--review';
          } else if (ms.type === 'launch') {
            milestoneClass += ' optigantt-milestone--launch';
          }

          // Diamond polygon (rotated square)
          var points = msX + ',' + (msCenterY - diamondSize) + ' ' +
                       (msX + diamondSize) + ',' + msCenterY + ' ' +
                       msX + ',' + (msCenterY + diamondSize) + ' ' +
                       (msX - diamondSize) + ',' + msCenterY;
          svg += '<polygon class="' + milestoneClass + '" points="' + points + '" />';

          // Milestone label — positioned above diamond
          svg += '<text class="optigantt-milestone__label" x="' + msX + '" y="' + (msCenterY - diamondSize - 4) + '" text-anchor="middle">' + ms.label + '</text>';
        }

        // --- Task 7: Today Indicator Line ---
        var today = new Date();
        var todayMs = today.getTime() - timelineStart.getTime();
        if (todayMs >= 0 && todayMs <= totalMs) {
          var todayX = gridStartX + (todayMs / totalMs) * gridWidth;
          svg += '<path class="optigantt-today" d="M' + todayX + ' ' + gridStartY + ' L' + todayX + ' ' + gridEndY + '" />';
          svg += '<text class="optigantt-today__label" x="' + todayX + '" y="' + (gridEndY + 26) + '" text-anchor="middle">\u05D4\u05D9\u05D5\u05DD</text>';
        }

        svg += '</svg>';
        return svg;
      },

      destroy: function() {
        for (var i = 0; i < this._entranceTimeouts.length; i++) {
          clearTimeout(this._entranceTimeouts[i]);
        }
        this._entranceTimeouts = [];
        if (this.$content) this.$content.innerHTML = '';
        this.$content = null;
      }
    };

    // ================================================================
    // SECTION: AI Chat
    // ================================================================

    function handleChatOpen(e) {
      if (e) e.preventDefault();
      // Dismiss tooltip when opening chat panel
      OptiPlan.components.tooltip.hide();
      // Close module overlay if open (mutually exclusive)
      if (OptiPlan.state.currentLayer === 'module-expand') {
        OptiPlan.components.moduleOverlay.close();
      }
      OptiPlan.state.set('chatOpen', true);
      _updateSidebarForModule('opium-ai');
      handleActivityReset();
    }

    function handleChatClose(e) {
      if (e) e.preventDefault();
      // Abort in-flight LLM request on panel close
      if (OptiPlan.ai._abortController) {
        OptiPlan.ai._abortController.abort();
        OptiPlan.ai._abortController = null;
      }
      if (OptiPlan.ai._abortTimeoutId) {
        clearTimeout(OptiPlan.ai._abortTimeoutId);
        OptiPlan.ai._abortTimeoutId = null;
      }
      // Clear cache-only response timeout
      if (OptiPlan.ai._responseTimeout) {
        clearTimeout(OptiPlan.ai._responseTimeout);
        OptiPlan.ai._responseTimeout = null;
      }
      // Reset typing state
      OptiPlan.ai.showTypingIndicator(false);
      OptiPlan.state.set('chatOpen', false);
      _resetSidebarToDashboard();
    }

    function handleChatBackdropTap(e) {
      if (e.target === OptiPlan.ai.$backdrop) {
        handleChatClose(e);
      }
    }

    function handleInputKeydown(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        OptiPlan.ai.sendMessage(OptiPlan.ai.$input.value);
        handleActivityReset();
      }
    }

    function handleSendTap(e) {
      e.preventDefault();
      OptiPlan.ai.sendMessage(OptiPlan.ai.$input.value);
      handleActivityReset();
    }

    function handleChipTap(e) {
      e.preventDefault();
      var chipText = e.currentTarget.textContent.trim();
      OptiPlan.ai.sendMessage(chipText);
      handleActivityReset();
    }

    function handleInsightCardTap(e) {
      e.preventDefault();
      var $card = e.currentTarget;
      var context = $card.getAttribute('data-insight-context');
      if (!context) return;
      // Open chat panel and send context as a message
      handleChatOpen(e);
      setTimeout(function() {
        OptiPlan.ai.sendMessage(context);
      }, 400);
      handleActivityReset();
    }

    OptiPlan.ai = {
      history: [],
      _initialized: false,
      _responseTimeout: null,
      _isTyping: false,
      _abortController: null,
      _abortTimeoutId: null,
      $chatPanel: null,
      $backdrop: null,
      $messages: null,
      $input: null,
      $sendBtn: null,
      $chips: null,

      init: function() {
        if (this._initialized) { this.destroy(); }
        this.$chatPanel = document.getElementById('chatPanel');
        this.$backdrop = document.getElementById('chatBackdrop');
        this.$messages = document.getElementById('chatMessages');
        this.$input = document.getElementById('chatInput');
        this.$sendBtn = document.getElementById('chatSend');

        // Build chips from AI_CACHE
        var $chipsContainer = document.getElementById('chatChips');
        var cacheKeys = Object.keys(AI_CACHE);
        var chipCount = Math.min(cacheKeys.length, 4);
        for (var i = 0; i < chipCount; i++) {
          var chipBtn = document.createElement('button');
          chipBtn.className = 'chat-panel__chip';
          chipBtn.textContent = AI_CACHE[cacheKeys[i]].question;
          chipBtn.addEventListener('click', handleChipTap);
          $chipsContainer.appendChild(chipBtn);
        }
        this.$chips = $chipsContainer.querySelectorAll('.chat-panel__chip');

        // Close button
        var $closeBtn = document.getElementById('chatClose');
        if ($closeBtn) {
          $closeBtn.addEventListener('touchstart', handleChatClose, { passive: false });
          $closeBtn.addEventListener('click', handleChatClose);
        }

        // Backdrop tap
        if (this.$backdrop) {
          this.$backdrop.addEventListener('click', handleChatBackdropTap);
        }

        // Input events
        if (this.$input) {
          this.$input.addEventListener('keydown', handleInputKeydown);
        }

        // Send button
        if (this.$sendBtn) {
          this.$sendBtn.addEventListener('touchstart', handleSendTap, { passive: false });
          this.$sendBtn.addEventListener('click', handleSendTap);
        }

        // Wire AI indicator as tap target
        var $aiIndicator = document.querySelector('.ai-indicator');
        if ($aiIndicator) {
          $aiIndicator.style.cursor = 'pointer';
          $aiIndicator.addEventListener('click', handleChatOpen);
          $aiIndicator.addEventListener('touchstart', handleChatOpen, { passive: false });
        }

        // Wire AI insight notification cards
        this._$insightCards = document.querySelectorAll('.ai-insight-card');
        for (var ic = 0; ic < this._$insightCards.length; ic++) {
          this._$insightCards[ic].addEventListener('click', handleInsightCardTap);
        }

        this._initialized = true;
      },

      _buildSystemPrompt: function() {
        var p = PROJECT_DATA;
        return 'אתה עוזר AI מומחה לפרויקטי תשתית ובנייה. אתה משמש כיועץ בכיר לפרויקט "' + p.projectName + '".\n\n' +
          'פרטי הפרויקט:\n' +
          '- שם: ' + p.projectName + '\n' +
          '- תקציב כולל: ' + (p.totalBudget / 1000000000).toFixed(1) + ' מיליארד ₪\n' +
          '- מזמין: ' + p.client + '\n' +
          '- מספר קטעים: ' + p.sections.length + ' (A1-A6)\n' +
          '- סיכונים פעילים: ' + OPTIRISK_DATA.activeRisks + ', מתוכם ' + OPTIRISK_DATA.critical + ' קריטיים\n' +
          '- שיעור אישור תיאומים: ' + OPTITRACK_DATA.approvalRate + '%\n' +
          '- מסמכים: ' + OPTIDOCS_DATA.total + ' סה"כ, ' + OPTIDOCS_DATA.completionRate + '% הושלמו\n' +
          '- ניצול תקציב: ' + OPTIBIZ_DATA.budgetUtilization + '%, סטייה: ' + (OPTIBIZ_DATA.variance / 1000000).toFixed(0) + ' מיליון ₪\n' +
          '- לוח זמנים: ' + OPTIGANTT_DATA.sections.length + ' קטעים בפרויקט\n\n' +
          'כללים:\n' +
          '1. ענה תמיד בעברית בלבד\n' +
          '2. הפנה לנתוני פרויקט ספציפיים בכל תשובה (שמות קטעים, מספרים, אחוזים)\n' +
          '3. לעולם אל תגיד "אני לא יודע" — תמיד ספק תשובה רלוונטית על בסיס הנתונים הזמינים\n' +
          '4. שמור על תשובות קצרות ומקצועיות (2-4 משפטים)\n' +
          '5. השתמש במינוחים מקצועיים של תשתיות ובנייה\n' +
          '6. אם השאלה לא קשורה לפרויקט, הפנה את השיחה חזרה לנתוני הפרויקט';
      },

      _buildMessages: function(text) {
        var messages = [];
        var start = 0;
        var cap = MAX_CHAT_HISTORY * 2;
        if (this.history.length > cap) {
          start = this.history.length - cap;
        }
        for (var i = start; i < this.history.length; i++) {
          messages.push({ role: this.history[i].role, content: this.history[i].content });
        }
        return messages;
      },

      sendMessage: function(text) {
        if (!text || typeof text !== 'string') return;
        text = text.trim();
        if (!text) return;
        if (this._isTyping) return;

        // Add user bubble
        var userBubbleHtml = '<div class="chat-bubble chat-bubble--user">' +
          '<div class="chat-bubble__text">' + this._escapeHtml(text) + '</div>' +
          '<span class="chat-bubble__time">' + this._getTimeString() + '</span>' +
          '</div>';
        this.$messages.insertAdjacentHTML('beforeend', userBubbleHtml);
        this.$messages.scrollTop = this.$messages.scrollHeight;

        // Push to history
        this.history.push({ role: 'user', content: text });

        // Clear input
        if (this.$input) {
          this.$input.value = '';
        }

        // Show typing indicator
        this.showTypingIndicator(true);

        var self = this;

        // Abort any previous in-flight request
        if (this._abortController) {
          this._abortController.abort();
        }

        // Skip API call if no API key configured — cache-only mode
        if (!API_KEY) {
          var cached = this.findCachedResponse(text);
          this._responseTimeout = setTimeout(function showCached() {
            self.displayResponse(cached);
          }, 800 + Math.floor(Math.random() * 700));
          return;
        }

        var controller = new AbortController();
        this._abortController = controller;

        var timeoutId = setTimeout(function abortTimeout() {
          controller.abort();
        }, LLM_TIMEOUT_MS);
        this._abortTimeoutId = timeoutId;

        fetch(LLM_API_URL, {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            'x-api-key': API_KEY,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: LLM_MODEL,
            max_tokens: LLM_MAX_TOKENS,
            system: self._buildSystemPrompt(),
            messages: self._buildMessages(text)
          }),
          signal: controller.signal
        })
        .then(function handleResponse(res) {
          clearTimeout(timeoutId);
          if (!res.ok) {
            throw new Error('API returned ' + res.status);
          }
          return res.json();
        })
        .then(function handleData(data) {
          var responseText = data.content && data.content[0] && data.content[0].text;
          if (!responseText) {
            throw new Error('Empty response from API');
          }
          self.displayResponse(responseText);
        })
        .catch(function handleError(err) {
          clearTimeout(timeoutId);
          console.warn('[OptiPlan AI]', err.message);
          var fallback = self.findCachedResponse(text);
          self.displayResponse(fallback);
        })
        .finally(function cleanupAbort() {
          self._abortController = null;
          self._abortTimeoutId = null;
        });
      },

      displayResponse: function(text) {
        // Hide typing indicator
        this.showTypingIndicator(false);

        // Cap history BEFORE push — remove oldest pair if at limit
        if (this.history.length >= MAX_CHAT_HISTORY * 2) {
          this.history.shift();
          this.history.shift();
          // Remove oldest DOM bubbles
          var $bubbles = this.$messages.querySelectorAll('.chat-bubble');
          if ($bubbles.length >= 2) {
            $bubbles[0].remove();
            $bubbles[1].remove();
          }
        }

        // Wrap numeric data (digits, decimals, percentages, currency) with JetBrains Mono span
        var escaped = this._escapeHtml(text);
        var formatted = escaped.replace(/([\u20AA$€]?\s*[\d,]+\.?\d*\s*%?)/g, '<span class="chat-bubble__numeric">$1</span>');

        // Add AI bubble
        var aiBubbleHtml = '<div class="chat-bubble chat-bubble--ai">' +
          '<div class="chat-bubble__text">' + formatted + '</div>' +
          '<span class="chat-bubble__time">' + this._getTimeString() + '</span>' +
          '</div>';
        this.$messages.insertAdjacentHTML('beforeend', aiBubbleHtml);

        // Push to history
        this.history.push({ role: 'assistant', content: text });

        // Scroll to bottom
        this.$messages.scrollTop = this.$messages.scrollHeight;

        // Re-enable send button
        if (this.$sendBtn) {
          this.$sendBtn.disabled = false;
        }
      },

      findCachedResponse: function(text) {
        var cacheKeys = Object.keys(AI_CACHE);
        var bestMatch = null;
        var bestScore = 0;
        var userWords = text.split(/\s+/);

        for (var i = 0; i < cacheKeys.length; i++) {
          var entry = AI_CACHE[cacheKeys[i]];
          var qWords = entry.question.split(/\s+/);
          var score = 0;

          for (var j = 0; j < userWords.length; j++) {
            for (var k = 0; k < qWords.length; k++) {
              if (userWords[j] === qWords[k] && userWords[j].length > 2) {
                score++;
              }
            }
          }

          // Boost score if cache key appears in user text
          if (text.indexOf(cacheKeys[i]) !== -1) {
            score += 3;
          }

          if (score > bestScore) {
            bestScore = score;
            bestMatch = entry.answer;
          }
        }

        if (bestScore === 0 || !bestMatch) {
          return 'על בסיס נתוני פרויקט הרחבת קו המטרו, גוש דן — המערכת מנתחת כעת את המידע. ניתן לשאול שאלות ספציפיות על תקציב, לוח זמנים, סיכונים או תיאומים.';
        }

        return bestMatch;
      },

      showTypingIndicator: function(show) {
        if (show) {
          this._isTyping = true;
          if (this.$sendBtn) this.$sendBtn.disabled = true;
          var typingHtml = '<div class="chat-typing" id="chat-typing">' +
            '<span class="chat-typing__dot"></span>' +
            '<span class="chat-typing__dot"></span>' +
            '<span class="chat-typing__dot"></span>' +
            '</div>';
          this.$messages.insertAdjacentHTML('beforeend', typingHtml);
          this.$messages.scrollTop = this.$messages.scrollHeight;
        } else {
          this._isTyping = false;
          var $typing = document.getElementById('chat-typing');
          if ($typing) $typing.remove();
        }
      },

      _escapeHtml: function(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      },

      _getTimeString: function() {
        return new Intl.DateTimeFormat('he-IL', {
          hour: '2-digit',
          minute: '2-digit'
        }).format(new Date());
      },

      destroy: function() {
        if (this._responseTimeout) {
          clearTimeout(this._responseTimeout);
          this._responseTimeout = null;
        }

        // Abort in-flight LLM request
        if (this._abortController) {
          this._abortController.abort();
          this._abortController = null;
        }
        if (this._abortTimeoutId) {
          clearTimeout(this._abortTimeoutId);
          this._abortTimeoutId = null;
        }

        this.history = [];
        this._isTyping = false;

        var $closeBtn = document.getElementById('chatClose');
        if ($closeBtn) {
          $closeBtn.removeEventListener('click', handleChatClose);
          $closeBtn.removeEventListener('touchstart', handleChatClose);
        }

        if (this.$backdrop) {
          this.$backdrop.removeEventListener('click', handleChatBackdropTap);
        }

        if (this.$input) {
          this.$input.removeEventListener('keydown', handleInputKeydown);
        }

        if (this.$sendBtn) {
          this.$sendBtn.removeEventListener('click', handleSendTap);
          this.$sendBtn.removeEventListener('touchstart', handleSendTap);
        }

        if (this.$chips) {
          this.$chips.forEach(function($chip) {
            $chip.removeEventListener('click', handleChipTap);
          });
        }

        var $aiIndicator = document.querySelector('.ai-indicator');
        if ($aiIndicator) {
          $aiIndicator.removeEventListener('click', handleChatOpen);
          $aiIndicator.removeEventListener('touchstart', handleChatOpen);
        }

        if (this.$messages) this.$messages.innerHTML = '';

        // Clear dynamically-created chip buttons to prevent duplication on re-init
        var $chipsContainer = document.getElementById('chatChips');
        if ($chipsContainer) $chipsContainer.innerHTML = '';

        this.$chatPanel = null;
        this.$backdrop = null;
        this.$messages = null;
        this.$input = null;
        this.$sendBtn = null;
        this.$chips = null;
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Theme Toggle Handler
    // ================================================================

    function handleThemeToggle(e) {
      var currentTheme = document.body.getAttribute('data-theme');
      var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      OptiPlan.state.set('theme', newTheme);
    }

    function handleThemeToggleKeydown(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        handleThemeToggle(e);
      }
    }

    OptiPlan.components.themeToggle = {
      $toggle: null,
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        this.$toggle = document.getElementById('themeToggle');
        if (!this.$toggle) return;
        this.$toggle.addEventListener('click', handleThemeToggle);
        this.$toggle.addEventListener('keydown', handleThemeToggleKeydown);
        this._initialized = true;
      },

      destroy: function() {
        if (this.$toggle) {
          this.$toggle.removeEventListener('click', handleThemeToggle);
          this.$toggle.removeEventListener('keydown', handleThemeToggleKeydown);
        }
        this.$toggle = null;
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Idle Auto-Reset
    // ================================================================

    function executeIdleReset() {
      // Close chat panel if open
      if (OptiPlan.state.chatOpen) {
        handleChatClose();
      }

      // Clear chat history and DOM for clean investor session
      if (OptiPlan.ai.$messages) {
        OptiPlan.ai.$messages.innerHTML = '';
      }
      OptiPlan.ai.history = [];

      // Dismiss tooltip on any idle reset (before layer check)
      OptiPlan.components.tooltip.hide();

      var currentLayer = OptiPlan.state.currentLayer;

      if (currentLayer === 'overview' || currentLayer === 'idle') {
        // Already at rest — nothing else to reset
        return;
      }

      if (currentLayer === 'module-expand') {
        OptiPlan.components.moduleOverlay.close();
        console.log('[OptiPlan Idle] Auto-reset from module-expand to overview');
      } else if (currentLayer === 'card-flip') {
        var flippedCard = document.querySelector('.stat-card--flipped');
        if (flippedCard) {
          flippedCard.classList.remove('stat-card--flipped');
        }
        OptiPlan.state.activeModule = null;
        OptiPlan.state.transition('overview');
        console.log('[OptiPlan Idle] Auto-reset from card-flip to overview');
      }
    }

    function handleActivityReset() {
      if (OptiPlan.state._idleTimer) {
        clearTimeout(OptiPlan.state._idleTimer);
      }
      OptiPlan.state._idleTimer = setTimeout(executeIdleReset, IDLE_TIMEOUT_MS);
    }

    OptiPlan.components.idleReset = {
      _initialized: false,

      init: function() {
        if (this._initialized) { this.destroy(); }
        document.addEventListener('touchstart', handleActivityReset, { passive: true });
        document.addEventListener('click', handleActivityReset, { passive: true });
        handleActivityReset();
        this._initialized = true;
      },

      destroy: function() {
        document.removeEventListener('touchstart', handleActivityReset);
        document.removeEventListener('click', handleActivityReset);
        if (OptiPlan.state._idleTimer) {
          clearTimeout(OptiPlan.state._idleTimer);
          OptiPlan.state._idleTimer = null;
        }
        this._initialized = false;
      }
    };

    // ================================================================
    // SECTION: Initialization
    // ================================================================

    OptiPlan.init = function() {
      // Theme toggle (proper lifecycle)
      OptiPlan.components.themeToggle.init();

      // Set initial layer to overview
      OptiPlan.state.currentLayer = 'idle';
      var transitionResult = OptiPlan.state.transition('overview');
      if (!transitionResult) {
        console.warn('[OptiPlan Init] Initial transition to overview failed');
      }

      // Initialize components
      OptiPlan.components.sidebar.init();
      OptiPlan.components.topbar.init();
      OptiPlan.components.heroGauges.init();
      OptiPlan.components.statCards.init();
      OptiPlan.components.moduleOverlay.init();
      OptiPlan.components.tooltip.init();

      // AI Chat
      OptiPlan.ai.init();

      // Touch hardening (pull-to-refresh prevention)
      OptiPlan.touch.init();

      // Idle auto-reset
      OptiPlan.components.idleReset.init();
    };

    document.addEventListener('DOMContentLoaded', OptiPlan.init.bind(OptiPlan));
  </script>
</body>
</html>
