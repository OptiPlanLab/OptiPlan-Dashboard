<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024, user-scalable=no">
  <meta name="robots" content="noindex">
  <title>OptiPlan — מרכז בקרה</title>

  <!-- Google Fonts — Varela Round (UI) + JetBrains Mono (data/mono) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Tabler Icons Webfont -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">

  <style>
    /* ================================================================ */
    /* SECTION: CSS Reset & Base                                         */
    /* ================================================================ */

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ================================================================ */
    /* SECTION: Design Tokens (Custom Properties)                        */
    /* ================================================================ */

    :root {
      /* Typography */
      --font-main: 'Varela Round', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;

      /* Spacing */
      --gap: 16px;
      --gap-sm: 8px;
      --gap-lg: 24px;

      /* Border Radius */
      --radius: 14px;
      --radius-sm: 8px;

      /* Transitions */
      --transition: 0.35s cubic-bezier(0.16, 1, 0.3, 1);
      --transition-flip: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      --transition-bounce: 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);

      /* Palette D — Module Colors */
      --optitrack: #0991F3;
      --optibiz: #F6AE2D;
      --optirisk: #FF7A3C;
      --optidocs: #4395FD;
      --optigantt: #0B3C5D;

      /* Status Colors */
      --status-online: #22C55E;
      --status-online-glow: rgba(34,197,94,0.5);
    }

    [data-theme="dark"] {
      --bg-body: #0A0E1A;
      --bg-sidebar: #0F1328;
      --bg-card: #141833;
      --bg-card-hover: #1A2044;
      --bg-input: #181E3A;
      --border: rgba(255,255,255,0.07);
      --border-hover: rgba(255,255,255,0.12);
      --text-primary: #E5E7EB;
      --text-secondary: rgba(255,255,255,0.58);
      --text-muted: rgba(255,255,255,0.30);
      --shadow-card: 0 4px 20px rgba(0,0,0,0.40);
      --shadow-card-hover: 0 8px 36px rgba(0,0,0,0.55);
      --gradient-body: radial-gradient(ellipse 70% 55% at 15% 8%, rgba(9,145,243,0.06) 0%, transparent 55%),
                       radial-gradient(ellipse 55% 45% at 85% 85%, rgba(246,174,45,0.04) 0%, transparent 55%),
                       linear-gradient(165deg, #0A0E1A 0%, #0D1228 45%, #101636 75%, #0A0E1A 100%);
      --toggle-bg: #181E3A;
      --toggle-knob: #F59E0B;
      --sidebar-active: rgba(9,145,243,0.12);
      --bar-track: rgba(255,255,255,0.06);
      --ring-track: rgba(255,255,255,0.05);
    }

    [data-theme="light"] {
      --bg-body: #F0F2F8;
      --bg-sidebar: #FFFFFF;
      --bg-card: #FFFFFF;
      --bg-card-hover: #F7F8FC;
      --bg-input: #F0F2F8;
      --border: rgba(0,0,0,0.07);
      --border-hover: rgba(0,0,0,0.13);
      --text-primary: #1A1E36;
      --text-secondary: rgba(0,0,0,0.55);
      --text-muted: rgba(0,0,0,0.32);
      --shadow-card: 0 2px 12px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
      --shadow-card-hover: 0 6px 24px rgba(0,0,0,0.10);
      --gradient-body: linear-gradient(165deg, #F0F2F8 0%, #E8EBF4 50%, #F0F2F8 100%);
      --toggle-bg: #E2E6F0;
      --toggle-knob: #0991F3;
      --sidebar-active: rgba(9,145,243,0.08);
      --bar-track: rgba(0,0,0,0.06);
      --ring-track: rgba(0,0,0,0.06);
    }

    /* ================================================================ */
    /* SECTION: Layout — Body & Main Shell                               */
    /* ================================================================ */

    body {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      background: var(--gradient-body);
      background-color: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font-main);
    }

    /* ================================================================ */
    /* SECTION: Layout — Sidebar (240px, RTL right-side)                 */
    /* ================================================================ */

    .sidebar {
      width: 240px;
      height: 100vh;
      position: fixed;
      inset-inline-end: 0;
      top: 0;
      background: var(--bg-sidebar);
      border-inline-start: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    /* ================================================================ */
    /* SECTION: Layout — Topbar (58px height)                            */
    /* ================================================================ */

    .topbar {
      height: 58px;
      background: var(--bg-sidebar);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 var(--gap);
      position: sticky;
      top: 0;
      z-index: 50;
      flex-shrink: 0;
    }

    /* ================================================================ */
    /* SECTION: Layout — Main Grid                                       */
    /* ================================================================ */

    .main-content {
      flex: 1;
      margin-inline-end: 240px;
      display: flex;
      flex-direction: column;
      overflow: auto;
      min-height: 100vh;
    }

    /* ================================================================ */
    /* SECTION: Theme Toggle                                             */
    /* ================================================================ */

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      touch-action: manipulation;
    }

    .theme-toggle__track {
      width: 44px;
      height: 24px;
      border-radius: 12px;
      background: var(--toggle-bg);
      border: 1px solid var(--border);
      position: relative;
      transition: background var(--transition), border-color var(--transition);
    }

    .theme-toggle__knob {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--toggle-knob);
      position: absolute;
      top: 2px;
      /* RTL: knob starts at inline-end (logical end = left in RTL visual) */
      inset-inline-end: 2px;
      transition: transform var(--transition-bounce),
                  background var(--transition);
      will-change: transform;
    }

    /* In light theme, shift knob to the other side */
    [data-theme="light"] .theme-toggle__knob {
      transform: translateX(-22px);
    }

    .theme-toggle__label {
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--font-main);
    }

    /* ================================================================ */
    /* SECTION: Component — Sidebar Content                              */
    /* ================================================================ */

    .sidebar__brand {
      padding: var(--gap) var(--gap);
      display: flex;
      justify-content: center;
    }

    .sidebar__brand-pill {
      display: inline-block;
      padding: 4px 14px;
      background: linear-gradient(135deg, var(--optitrack), var(--optibiz));
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--bg-body);
    }

    .sidebar__avatar {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      margin-bottom: var(--gap-sm);
    }

    .sidebar__avatar-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--optitrack);
      color: var(--bg-body);
      font-family: var(--font-main);
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .sidebar__avatar-info {
      display: flex;
      flex-direction: column;
    }

    .sidebar__avatar-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: var(--font-main);
    }

    .sidebar__avatar-role {
      font-size: 11px;
      color: var(--text-secondary);
      font-family: var(--font-main);
    }

    .sidebar__nav {
      flex: 1;
      overflow-y: auto;
      padding: 0 var(--gap-sm);
    }

    .sidebar__section-label {
      display: block;
      padding: var(--gap) var(--gap-sm) 4px;
      font-family: var(--font-mono);
      font-size: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
    }

    .sidebar__nav-item {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      min-height: 44px;
      padding: 0 var(--gap-sm);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      text-decoration: none;
      cursor: pointer;
      transition: background var(--transition), color var(--transition),
                  border-color var(--transition);
      border-inline-start: 3px solid transparent;
      touch-action: manipulation;
    }

    .sidebar__nav-item--active {
      border-inline-start: 3px solid var(--optitrack);
      background: var(--sidebar-active);
      color: var(--text-primary);
    }

    .sidebar__nav-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .sidebar__nav-label {
      font-family: var(--font-main);
      font-size: 13px;
      flex: 1;
    }

    .sidebar__dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .sidebar__footer {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: var(--gap-sm) var(--gap);
      border-top: 1px solid var(--border);
    }

    .sidebar__footer-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--status-online);
      box-shadow: 0 0 6px var(--status-online-glow);
      animation: sidebar-pulse 2s ease-in-out infinite;
      flex-shrink: 0;
    }

    .sidebar__footer-api,
    .sidebar__footer-version {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    .sidebar__footer-version {
      margin-inline-start: auto;
    }

    /* ================================================================ */
    /* SECTION: Component — Topbar Content                               */
    /* ================================================================ */

    .topbar__title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .topbar__title {
      font-family: var(--font-main);
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .topbar__subtitle {
      font-family: var(--font-main);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .topbar__actions {
      display: flex;
      align-items: center;
      gap: var(--gap);
      margin-inline-start: auto;
    }

    .topbar__clock {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--text-muted);
    }

    .topbar__search {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      padding: 6px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted);
      font-family: var(--font-main);
      font-size: 13px;
      cursor: default;
    }

    .topbar__search-icon {
      font-size: 16px;
      color: var(--text-muted);
    }

    .topbar__search-text {
      color: var(--text-muted);
      font-family: var(--font-main);
      font-size: 13px;
    }

    .topbar__bell {
      position: relative;
      font-size: 20px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .topbar__bell-badge {
      position: absolute;
      top: -2px;
      inset-inline-end: -2px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--optirisk);
    }

    /* ================================================================ */
    /* SECTION: Component — Hero Gauges                                  */
    /* ================================================================ */

    .hero-gauges {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: var(--gap-lg);
      padding: var(--gap-lg) 0;
    }

    .hero-gauge {
      width: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .hero-gauge__svg {
      width: 100%;
      height: auto;
    }

    .hero-gauge__track {
      stroke: var(--ring-track);
    }

    .hero-gauge__fill {
      transition: stroke-dashoffset 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    [data-gauge="financial"] .hero-gauge__fill {
      stroke: var(--optibiz);
    }

    [data-gauge="coordination"] .hero-gauge__fill {
      stroke: var(--optitrack);
    }

    [data-gauge="schedule"] .hero-gauge__fill {
      stroke: var(--optigantt);
    }

    .hero-gauge__value {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 24px;
      fill: var(--text-primary);
    }

    .hero-gauge__label {
      font-family: var(--font-main);
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: var(--gap-sm);
    }

    .hero-gauge__fill.is-animating {
      will-change: stroke-dashoffset;
    }

    .hero-gauge__fill.is-idle {
      animation: gauge-pulse 3s ease-in-out infinite;
      will-change: opacity;
    }

    /* ================================================================ */
    /* SECTION: Animations & Keyframes                                   */
    /* ================================================================ */

    @keyframes sidebar-pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 0 6px var(--status-online-glow);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.15);
        box-shadow: 0 0 10px var(--status-online-glow);
      }
    }

    @keyframes gauge-pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.85;
      }
    }

    /* ================================================================ */
    /* SECTION: Utilities                                                */
    /* ================================================================ */

    .u-hidden {
      display: none !important;
    }

    .u-rtl-flip {
      transform: scaleX(-1);
    }

    /* ================================================================ */
    /* SECTION: Responsive / Accessibility                               */
    /* ================================================================ */

    /* Reduced motion — accessibility */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Phone viewport — show optimize message */
    @media (max-width: 767px) {
      .viewport-overlay--phone {
        display: flex;
      }
    }

    .viewport-overlay--phone {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font-main);
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: var(--gap-lg);
      text-align: center;
    }

    /* Portrait orientation on tablet — show rotation prompt */
    @media (orientation: portrait) and (min-width: 768px) {
      .viewport-overlay--portrait {
        display: flex;
      }
    }

    .viewport-overlay--portrait {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-body);
      color: var(--text-primary);
      font-family: var(--font-main);
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: var(--gap-lg);
      text-align: center;
    }

    /* Touch interaction baseline */
    * {
      touch-action: manipulation;
      -webkit-touch-callout: none;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Preserve text selection and restore touch defaults in standard text contexts */
    input, textarea, [contenteditable] {
      user-select: text;
      -webkit-user-select: text;
      touch-action: auto;
      -webkit-touch-callout: auto;
    }
  </style>
</head>
<body data-theme="dark" data-palette="d" data-skin="1">
  <!-- data-palette and data-skin reserved for future story variants (palettes A-C, skins 2+) -->

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="ניווט ראשי">
    <!-- Brand Badge -->
    <div class="sidebar__brand">
      <span class="sidebar__brand-pill">OPTIPLAN</span>
    </div>

    <!-- User Avatar -->
    <div class="sidebar__avatar">
      <div class="sidebar__avatar-circle">בע</div>
      <div class="sidebar__avatar-info">
        <span class="sidebar__avatar-name">בן עקיבא</span>
        <span class="sidebar__avatar-role">מנהל פרויקט</span>
      </div>
    </div>

    <!-- Navigation: Modules -->
    <nav class="sidebar__nav">
      <span class="sidebar__section-label">מודולים</span>
      <a class="sidebar__nav-item sidebar__nav-item--active" data-module="dashboard" href="#" role="button" aria-current="page">
        <i class="ti ti-dashboard sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">לוח בקרה</span>
        <span class="sidebar__dot" style="background: var(--optitrack)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optitrack" href="#" role="button">
        <i class="ti ti-chart-dots-3 sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiTrack — תיאומים</span>
        <span class="sidebar__dot" style="background: var(--optitrack)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optibiz" href="#" role="button">
        <i class="ti ti-chart-bar sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiBiz — פיננסי</span>
        <span class="sidebar__dot" style="background: var(--optibiz)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optirisk" href="#" role="button">
        <i class="ti ti-shield-check sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiRisk — סיכונים</span>
        <span class="sidebar__dot" style="background: var(--optirisk)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optidocs" href="#" role="button">
        <i class="ti ti-file-text sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiDocs — מסמכים</span>
        <span class="sidebar__dot" style="background: var(--optidocs)"></span>
      </a>
      <a class="sidebar__nav-item" data-module="optigantt" href="#" role="button">
        <i class="ti ti-calendar-event sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">OptiGantt — לוח זמנים</span>
        <span class="sidebar__dot" style="background: var(--optigantt)"></span>
      </a>

      <!-- Tools Section -->
      <span class="sidebar__section-label">כלים</span>
      <a class="sidebar__nav-item" data-module="opium-ai" href="#" role="button">
        <i class="ti ti-robot sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">Opium AI</span>
      </a>
      <a class="sidebar__nav-item" data-module="section-map" href="#" role="button">
        <i class="ti ti-map sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">מפת קטעים</span>
      </a>
      <a class="sidebar__nav-item" data-module="reports" href="#" role="button">
        <i class="ti ti-report sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">דוחות</span>
      </a>

      <!-- System Section -->
      <span class="sidebar__section-label">מערכת</span>
      <a class="sidebar__nav-item" data-module="settings" href="#" role="button">
        <i class="ti ti-settings sidebar__nav-icon"></i>
        <span class="sidebar__nav-label">הגדרות</span>
      </a>
    </nav>

    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle" role="button" aria-label="החלפת ערכת נושא" tabindex="0">
      <div class="theme-toggle__track" aria-hidden="true">
        <div class="theme-toggle__knob"></div>
      </div>
      <span class="theme-toggle__label">ערכת נושא</span>
    </div>

    <!-- Footer -->
    <div class="sidebar__footer">
      <span class="sidebar__footer-dot"></span>
      <span class="sidebar__footer-api">API 18ms</span>
      <span class="sidebar__footer-version">v2.4.1</span>
    </div>
  </aside>

  <!-- Main content area -->
  <div class="main-content">
    <!-- Topbar -->
    <header class="topbar" aria-label="סרגל עליון">
      <div class="topbar__title-block">
        <span class="topbar__title">מרכז בקרה</span>
        <span class="topbar__subtitle">הרחבת קו מטרו, גוש דן</span>
      </div>
      <div class="topbar__actions">
        <span class="topbar__clock" id="topbarClock"></span>
        <div class="topbar__search">
          <i class="ti ti-search topbar__search-icon"></i>
          <span class="topbar__search-text">חיפוש...</span>
        </div>
        <div class="topbar__bell">
          <i class="ti ti-bell"></i>
          <span class="topbar__bell-badge"></span>
        </div>
      </div>
    </header>

    <!-- Primary content region (hero gauges, stat cards etc. added in Stories 1.4–1.5) -->
    <main id="mainRegion">
      <!-- Hero Gauges — 3 animated SVG ring gauges (Story 1.4) -->
      <section class="hero-gauges">
        <div class="hero-gauge" data-gauge="financial">
          <svg class="hero-gauge__svg" viewBox="0 0 120 120">
            <circle class="hero-gauge__track" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" />
            <circle class="hero-gauge__fill" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" stroke-linecap="round"
                    transform="rotate(-90 60 60)" />
            <text class="hero-gauge__value" x="60" y="60"
                  text-anchor="middle" dominant-baseline="central"></text>
          </svg>
          <span class="hero-gauge__label">בריאות פיננסית</span>
        </div>
        <div class="hero-gauge" data-gauge="coordination">
          <svg class="hero-gauge__svg" viewBox="0 0 120 120">
            <circle class="hero-gauge__track" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" />
            <circle class="hero-gauge__fill" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" stroke-linecap="round"
                    transform="rotate(-90 60 60)" />
            <text class="hero-gauge__value" x="60" y="60"
                  text-anchor="middle" dominant-baseline="central"></text>
          </svg>
          <span class="hero-gauge__label">השלמת תיאומים</span>
        </div>
        <div class="hero-gauge" data-gauge="schedule">
          <svg class="hero-gauge__svg" viewBox="0 0 120 120">
            <circle class="hero-gauge__track" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" />
            <circle class="hero-gauge__fill" cx="60" cy="60" r="50"
                    stroke-width="8" fill="none" stroke-linecap="round"
                    transform="rotate(-90 60 60)" />
            <text class="hero-gauge__value" x="60" y="60"
                  text-anchor="middle" dominant-baseline="central"></text>
          </svg>
          <span class="hero-gauge__label">עמידה בלוח זמנים</span>
        </div>
      </section>
    </main>
  </div>

  <!-- Viewport overlays — content populated in Story 1.3 -->
  <div class="viewport-overlay--phone" role="alert" aria-live="polite">אנא בחר במצב נוף או בטאבלט</div>
  <div class="viewport-overlay--portrait" role="alert" aria-live="polite">אנא הפוך את המכשיר לנוף</div>

  <script>
    // ================================================================
    // SECTION: Configuration Constants
    // ================================================================

    const API_KEY = '';
    const IDLE_TIMEOUT_MS = 90000;
    const MAX_CHAT_HISTORY = 5;

    // ================================================================
    // SECTION: Data Constants
    // ================================================================

    const PROJECT_DATA = {
      projectName: 'הרחבת קו מטרו, גוש דן',
      projectSubtitle: 'קו M1 — מת"א מרכז לפ"ת',
      client: 'נת"ע',
      projectId: 'NTA-M1-2022',
      totalBudget: 1800000000,
      currency: 'NIS',
      startDate: '2022-04-01',
      targetEndDate: '2027-12-31',
      sections: [
        { id: 'a1', name: 'תל אביב מרכז – גבעתיים', phase: 'complete', progress: 100 },
        { id: 'a2', name: 'גבעתיים – רמת גן', phase: 'execution', progress: 78 },
        { id: 'a3', name: 'רמת גן – בני ברק', phase: 'execution', progress: 52 },
        { id: 'a4', name: 'בני ברק – פתח תקווה', phase: 'planning', progress: 31 },
        { id: 'a5', name: 'פתח תקווה מרכז – שרונה', phase: 'planning', progress: 15 },
        { id: 'a6', name: 'שרונה – גוש דן מזרח', phase: 'design', progress: 8 }
      ]
    };

    const OPTITRACK_DATA = {
      totalItems: 347,
      approved: 222,
      approvalRate: 64,
      pending: 35,
      objections: 12,
      inReview: 78,
      authorities: [
        { name: 'עירייה', nameEn: 'Municipality', total: 89, approved: 62, pending: 14, objections: 4, inReview: 9 },
        { name: 'חברת חשמל', nameEn: 'Israel Electric Corp', total: 72, approved: 51, pending: 8, objections: 3, inReview: 10 },
        { name: 'מקורות', nameEn: 'Water Authority', total: 68, approved: 45, pending: 7, objections: 3, inReview: 13 },
        { name: 'בזק', nameEn: 'Communications', total: 61, approved: 40, pending: 4, objections: 2, inReview: 15 },
        { name: 'רשות העתיקות', nameEn: 'Antiquities Authority', total: 57, approved: 24, pending: 2, objections: 0, inReview: 31 }
      ],
      permitMatrix: [
        { section: 'a1', statuses: ['approved','approved','approved','approved','approved'] },
        { section: 'a2', statuses: ['approved','approved','approved','pending','objection'] },
        { section: 'a3', statuses: ['approved','approved','in-review','pending','objection'] },
        { section: 'a4', statuses: ['in-review','in-review','pending','pending','not-submitted'] },
        { section: 'a5', statuses: ['pending','not-submitted','not-submitted','not-submitted','not-submitted'] },
        { section: 'a6', statuses: ['not-submitted','not-submitted','not-submitted','not-submitted','not-submitted'] }
      ],
      activityFeed: [
        { id: 1, initials: 'ד.ל', name: 'דניאלה לוי', timestamp: 'לפני 3 דק׳', description: 'אישור עיריית גבעתיים לפריסת תשתית קטע א2', status: 'approved' },
        { id: 2, initials: 'מ.כ', name: 'מיכאל כהן', timestamp: 'לפני 18 דק׳', description: 'הגשת בקשה לרשות העתיקות — קטע א3 חפירות', status: 'pending' },
        { id: 3, initials: 'א.ש', name: 'אביטל שמאי', timestamp: 'לפני 42 דק׳', description: 'התנגדות חברת חשמל לתנאי חציית מנהרה קטע א2', status: 'objection' },
        { id: 4, initials: 'ר.ב', name: 'רונן בן-דוד', timestamp: 'לפני 1:15 שע׳', description: 'חתימת הסכם תיאום עם מקורות — קטע א1 הושלם', status: 'approved' },
        { id: 5, initials: 'נ.פ', name: 'נטע פרידמן', timestamp: 'לפני 2:30 שע׳', description: 'בדיקת ביניים בזק — חוות דעת מקצועית בהכנה', status: 'in-review' },
        { id: 6, initials: 'י.ג', name: 'יובל גרין', timestamp: 'לפני 4 שע׳', description: 'פגישת תיאום עם נציגי עירייה — לוח זמנים קטע א4', status: 'in-review' }
      ]
    };

    const OPTIBIZ_DATA = {
      budgetTotal: 1800000000,
      budgetUtilized: 1220000000,
      budgetUtilization: 68,
      burnRate: 101666667,
      variance: -22000000,
      monthLabels: ['ינו׳','פבר׳','מרץ','אפר׳','מאי','יונ׳','יול׳','אוג׳','ספט׳','אוק׳','נוב׳','דצמ׳'],
      cashFlow: [
        { month: 'ינו׳', plan: 100000000, actual: 72000000 },
        { month: 'פבר׳', plan: 118000000, actual: 85000000 },
        { month: 'מרץ',  plan: 138000000, actual: 98000000 },
        { month: 'אפר׳', plan: 150000000, actual: 110000000 },
        { month: 'מאי',  plan: 160000000, actual: 118000000 },
        { month: 'יונ׳', plan: 165000000, actual: 125000000 },
        { month: 'יול׳', plan: 168000000, actual: 128000000 },
        { month: 'אוג׳', plan: 175000000, actual: 135000000 },
        { month: 'ספט׳', plan: 168000000, actual: 130000000 },
        { month: 'אוק׳', plan: 162000000, actual: 122000000 },
        { month: 'נוב׳', plan: 152000000, actual: 55000000 },
        { month: 'דצמ׳', plan: 144000000, actual: 42000000 }
      ]
    };

    const OPTIRISK_DATA = {
      activeRisks: 23,
      critical: 8,
      heatMap: [
        [0, 1, 0, 0, 0],
        [1, 2, 1, 0, 0],
        [0, 2, 2, 1, 0],
        [0, 1, 3, 2, 2],
        [0, 0, 1, 2, 2]
      ],
      probLabels: ['נמוכה', 'נמוכה-בינונית', 'בינונית', 'בינונית-גבוהה', 'גבוהה'],
      impactLabels: ['נמוכה', 'נמוכה-בינונית', 'בינונית', 'גבוהה', 'קריטי'],
      topRisks: [
        { id: 1, name: 'עיכובי רשות העתיקות — קטע א4', severity: 'critical', trend: 'up', mitigation: 'active', prob: 4, impact: 5 },
        { id: 2, name: 'עלייה בעלות חומרי גלם וחציבה', severity: 'critical', trend: 'up', mitigation: 'monitoring', prob: 5, impact: 4 },
        { id: 3, name: 'מחלוקות קנין — קטע א3', severity: 'critical', trend: 'stable', mitigation: 'legal-review', prob: 4, impact: 4 },
        { id: 4, name: 'מחסור בכוח אדם מהנדסים', severity: 'high', trend: 'down', mitigation: 'resolved', prob: 3, impact: 4 },
        { id: 5, name: 'סיכוני ממשק בין-קבלני — קטע א2/א3', severity: 'high', trend: 'up', mitigation: 'active', prob: 4, impact: 3 },
        { id: 6, name: 'אי עמידה בלוח זמנים — קטע א5', severity: 'high', trend: 'up', mitigation: 'monitoring', prob: 5, impact: 3 }
      ]
    };

    const OPTIDOCS_DATA = {
      total: 847,
      approved: 796,
      completionRate: 94,
      pending: 38,
      overdue: 13,
      documents: [
        { id: 'D001', name: 'תוכנית בינוי קטע א1', type: 'תוכנית', status: 'approved', date: '2024-03-15', assignee: 'ד.ל' },
        { id: 'D002', name: 'דוח סקר קרקע א2', type: 'דוח', status: 'approved', date: '2024-05-22', assignee: 'מ.כ' },
        { id: 'D003', name: 'היתר בנייה א3 — שלב א', type: 'היתר', status: 'pending', date: '2024-09-10', assignee: 'א.ש' },
        { id: 'D004', name: 'תסקיר השפעה על הסביבה', type: 'תסקיר', status: 'approved', date: '2024-01-30', assignee: 'ר.ב' },
        { id: 'D005', name: 'חוזה קבלן ראשי — קטע א4', type: 'חוזה', status: 'approved', date: '2024-07-08', assignee: 'נ.פ' },
        { id: 'D006', name: 'בקשת שינוי — מנהרה א3', type: 'בקשת שינוי', status: 'overdue', date: '2024-10-01', assignee: 'י.ג' },
        { id: 'D007', name: 'תוכנית ניהול בטיחות א2', type: 'תוכנית', status: 'approved', date: '2024-04-18', assignee: 'ד.ל' },
        { id: 'D008', name: 'פרוטוקול בדיקת איכות א1', type: 'פרוטוקול', status: 'approved', date: '2024-06-30', assignee: 'מ.כ' }
      ]
    };

    const OPTIGANTT_DATA = {
      sections: [
        { id: 'a1', name: 'תל אביב מרכז – גבעתיים', plannedStart: '2022-04-01', plannedEnd: '2024-06-30', actualStart: '2022-04-01', actualEnd: '2024-07-15', progress: 100 },
        { id: 'a2', name: 'גבעתיים – רמת גן', plannedStart: '2023-01-01', plannedEnd: '2025-03-31', actualStart: '2023-01-15', actualEnd: null, progress: 78 },
        { id: 'a3', name: 'רמת גן – בני ברק', plannedStart: '2023-07-01', plannedEnd: '2025-12-31', actualStart: '2023-08-01', actualEnd: null, progress: 52 },
        { id: 'a4', name: 'בני ברק – פתח תקווה', plannedStart: '2024-01-01', plannedEnd: '2026-06-30', actualStart: '2024-03-01', actualEnd: null, progress: 31 },
        { id: 'a5', name: 'פתח תקווה מרכז – שרונה', plannedStart: '2024-07-01', plannedEnd: '2027-03-31', actualStart: '2024-10-01', actualEnd: null, progress: 15 },
        { id: 'a6', name: 'שרונה – גוש דן מזרח', plannedStart: '2025-01-01', plannedEnd: '2027-12-31', actualStart: '2025-03-01', actualEnd: null, progress: 8 }
      ],
      milestones: [
        { date: '2024-07-15', label: 'השלמת קטע א1', section: 'a1', type: 'completion' },
        { date: '2025-06-30', label: 'בדיקות הפעלה — שלב א', section: 'a2', type: 'review' },
        { date: '2026-12-31', label: 'תחילת הפעלה מסחרית', section: 'a4', type: 'launch' },
        { date: '2027-12-31', label: 'השלמת פרויקט', section: 'a6', type: 'completion' }
      ]
    };

    const AI_CACHE = {
      'תקציב': {
        question: 'מה המצב התקציבי של הפרויקט?',
        answer: 'פרויקט הרחבת קו המטרו עומד על תקציב כולל של 1.8 מיליארד ₪. נכון להיום, נוצל 1.22 מיליארד ₪ — שיעור ניצול של 68%. הפרויקט נמצא מתחת לתקציב המתוכנן בכ-22 מיליון ₪, המעיד על ניהול פיננסי יעיל.'
      },
      'לוח זמנים': {
        question: 'האם הפרויקט עומד בלוח הזמנים?',
        answer: 'הפרויקט מציג ביצועי לוח זמנים מעורבים: קטע א1 הושלם בהצלחה, קטע א2 מתקדם ב-78%, וקטע א3 ב-52%. קטעים א4–א6 בשלבי תכנון ועיצוב. לוח הזמנים הכולל — פיניש דצמבר 2027 — נשמר.'
      },
      'סיכונים': {
        question: 'מהם הסיכונים הקריטיים של הפרויקט?',
        answer: 'זוהו 23 סיכונים פעילים, מתוכם 8 סיכונים קריטיים. הסיכונים המשמעותיים ביותר: עיכובי רשות העתיקות בקטע א4, עלייה בעלות חומרי גלם, ומחלוקות קנין בקטע א3. כל הסיכונים הקריטיים מנוהלים אקטיבית עם תוכניות מיטיגציה.'
      },
      'תיאומים': {
        question: 'מה מצב התיאומים עם הרשויות?',
        answer: 'מתוך 347 פריטי תיאום עם 5 רשויות, 222 אושרו (64%), 35 ממתינים לאישור, ו-12 נמצאים בהתנגדות. רשות העתיקות מציגה את קצב האישור האיטי ביותר — מה שמשפיע ישירות על קטע א4.'
      },
      'קטע א3': {
        question: 'מה מצב קטע א3?',
        answer: 'קטע א3 (רמת גן – בני ברק) מתקדם ב-52% ביחס לתכנון. שלב הביצוע החל באוגוסט 2023, עם תאריך יעד לסיום בסוף 2025. האתגרים הנוכחיים: מחלוקות קנין שנמצאות בבדיקה משפטית ותיאומים עם רשות העתיקות.'
      },
      'ניצול תקציב': {
        question: 'מה שיעור ניצול התקציב?',
        answer: 'שיעור ניצול התקציב עומד על 68% — 1.22 מיליארד ₪ מתוך 1.8 מיליארד ₪. קצב השריפה החודשי הממוצע הוא כ-102 מיליון ₪. בהינתן לוח הזמנים הנוכחי, הפרויקט צפוי לסיים בתוך המסגרת התקציבית.'
      },
      'הצלחה': {
        question: 'האם הפרויקט יצליח?',
        answer: 'על בסיס נתוני פרויקט הרחבת קו המטרו, המדדים מצביעים על מגמה חיובית: קטע א1 הושלם בהצלחה, הניצול התקציבי ביחס לתכנון תקין, ו-64% מהתיאומים עם רשויות אושרו. הפרויקט מציג בשלות תפעולית גבוהה ועמידה ביעדיו העיקריים.'
      },
      'הישגים': {
        question: 'מה ההישגים העיקריים עד כה?',
        answer: 'ההישגים הבולטים: (1) השלמת מלאה של קטע א1 — 17 ק"מ של תשתית מטרו. (2) 222 אישורים רגולטוריים מ-5 רשויות שונות. (3) שמירה על תקציב עם חיסכון של 22 מיליון ₪. (4) קצב בנייה של קטע א2 עולה על התחזית ב-3%.'
      }
    };

    // Freeze all data constants to enforce read-only access at runtime
    Object.freeze(PROJECT_DATA);
    Object.freeze(PROJECT_DATA.sections);
    Object.freeze(OPTITRACK_DATA);
    Object.freeze(OPTITRACK_DATA.authorities);
    Object.freeze(OPTITRACK_DATA.permitMatrix);
    Object.freeze(OPTITRACK_DATA.activityFeed);
    Object.freeze(OPTIBIZ_DATA);
    Object.freeze(OPTIBIZ_DATA.cashFlow);
    Object.freeze(OPTIRISK_DATA);
    Object.freeze(OPTIRISK_DATA.heatMap);
    Object.freeze(OPTIRISK_DATA.topRisks);
    Object.freeze(OPTIDOCS_DATA);
    Object.freeze(OPTIDOCS_DATA.documents);
    Object.freeze(OPTIGANTT_DATA);
    Object.freeze(OPTIGANTT_DATA.sections);
    Object.freeze(OPTIGANTT_DATA.milestones);
    Object.freeze(AI_CACHE);

    // ================================================================
    // SECTION: OptiPlan Namespace & State Management
    // ================================================================

    const _ALLOWED_TRANSITIONS = {
      'idle':          ['overview'],
      'overview':      ['card-flip', 'idle'],
      'card-flip':     ['overview', 'module-expand'],
      'module-expand': ['overview']
    };

    const OptiPlan = {
      state: {
        currentLayer: 'idle',
        activeModule: null,
        activeCard: null,
        theme: 'dark',
        _idleTimer: null,
        _clockInterval: null,

        transition: function(targetLayer) {
          const allowed = _ALLOWED_TRANSITIONS[this.currentLayer];
          if (!allowed || !allowed.includes(targetLayer)) {
            console.warn('[OptiPlan State] Invalid transition:', this.currentLayer, '→', targetLayer);
            return false;
          }
          this.currentLayer = targetLayer;
          OptiPlan.ui.reflectLayer(targetLayer);
          return true;
        },

        set: function(key, value) {
          this[key] = value;
          OptiPlan.ui.reflect(key, value);
        }
      },

      components: {},
      animations: {},
      modules: {},
      ai: {},
      touch: {},
      utils: {},
      data: {},
      ui: {}
    };

    // ================================================================
    // SECTION: Utility Functions
    // ================================================================

    OptiPlan.utils.formatCurrency = function(amount) {
      if (typeof amount !== 'number' || isNaN(amount)) {
        console.warn('[OptiPlan Utils] Invalid currency amount:', amount);
        return '';
      }
      return new Intl.NumberFormat('he-IL').format(amount);
    };

    OptiPlan.utils.formatPercent = function(value) {
      if (typeof value !== 'number' || isNaN(value)) {
        console.warn('[OptiPlan Utils] Invalid percent value:', value);
        return '';
      }
      return `${value}%`;
    };

    OptiPlan.utils.formatDate = function(dateStr) {
      if (!dateStr || isNaN(new Date(dateStr))) {
        console.warn('[OptiPlan Utils] Invalid date string:', dateStr);
        return '';
      }
      const d = new Date(dateStr);
      const day   = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year  = String(d.getFullYear()).slice(-2);
      return `${day}/${month}/${year}`;
    };

    // ================================================================
    // SECTION: UI Reflection Layer
    // ================================================================

    OptiPlan.ui.reflectLayer = function(layer) {
      // Stub — expanded by future stories
      // No logging on valid transitions; only log in error paths
    };

    OptiPlan.ui.reflect = function(key, value) {
      // Stub — expanded by future stories
      if (key === 'theme') {
        document.body.setAttribute('data-theme', value);
      }
    };

    // ================================================================
    // SECTION: Animation Orchestration (stub)
    // ================================================================

    // OptiPlan.animations populated by future stories

    // ================================================================
    // SECTION: Touch & Event Management (stub)
    // ================================================================

    // OptiPlan.touch populated by future stories

    // ================================================================
    // SECTION: Component — Sidebar
    // ================================================================

    function handleNavItemTap(e) {
      e.preventDefault();
      const $tapped = e.currentTarget;
      const $items = OptiPlan.components.sidebar.$navItems;
      $items.forEach(function($item) {
        $item.classList.remove('sidebar__nav-item--active');
        $item.removeAttribute('aria-current');
      });
      $tapped.classList.add('sidebar__nav-item--active');
      $tapped.setAttribute('aria-current', 'page');
    }

    OptiPlan.components.sidebar = {
      $sidebar: null,
      $navItems: null,

      init: function() {
        this.$sidebar = document.querySelector('.sidebar');
        this.$navItems = this.$sidebar.querySelectorAll('.sidebar__nav-item');
        this.$navItems.forEach(function($item) {
          $item.addEventListener('touchstart', handleNavItemTap, { passive: false });
          $item.addEventListener('click', handleNavItemTap);
        });
        this.render();
      },

      render: function() {
        var $dashboard = this.$sidebar.querySelector('[data-module="dashboard"]');
        if ($dashboard) {
          $dashboard.classList.add('sidebar__nav-item--active');
          $dashboard.setAttribute('aria-current', 'page');
        }
      },

      destroy: function() {
        this.$navItems.forEach(function($item) {
          $item.removeEventListener('touchstart', handleNavItemTap);
          $item.removeEventListener('click', handleNavItemTap);
        });
      }
    };

    // ================================================================
    // SECTION: Component — Topbar
    // ================================================================

    var _clockFormatter = new Intl.DateTimeFormat('he-IL', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });

    function updateTopbarClock() {
      var $clock = OptiPlan.components.topbar.$clock;
      if (!$clock) return;
      $clock.textContent = _clockFormatter.format(new Date());
    }

    OptiPlan.components.topbar = {
      $topbar: null,
      $clock: null,

      init: function() {
        this.$topbar = document.querySelector('.topbar');
        this.$clock = document.getElementById('topbarClock');
        updateTopbarClock();
        OptiPlan.state._clockInterval = setInterval(updateTopbarClock, 30000);
      },

      render: function() {
        updateTopbarClock();
      },

      destroy: function() {
        if (OptiPlan.state._clockInterval) {
          clearInterval(OptiPlan.state._clockInterval);
          OptiPlan.state._clockInterval = null;
        }
      }
    };

    // ================================================================
    // SECTION: Component — Hero Gauges
    // ================================================================

    var HERO_GAUGE_CONFIG = [
      { key: 'financial', value: OPTIBIZ_DATA.budgetUtilization, label: '\u05D1\u05E8\u05D9\u05D0\u05D5\u05EA \u05E4\u05D9\u05E0\u05E0\u05E1\u05D9\u05EA' },
      { key: 'coordination', value: OPTITRACK_DATA.approvalRate, label: '\u05D4\u05E9\u05DC\u05DE\u05EA \u05EA\u05D9\u05D0\u05D5\u05DE\u05D9\u05DD' },
      { key: 'schedule', value: 52, label: '\u05E2\u05DE\u05D9\u05D3\u05D4 \u05D1\u05DC\u05D5\u05D7 \u05D6\u05DE\u05E0\u05D9\u05DD' }
    ];

    var HERO_GAUGE_RADIUS = 50;
    var HERO_GAUGE_CIRCUMFERENCE = 2 * Math.PI * HERO_GAUGE_RADIUS;
    var HERO_GAUGE_FILL_DELAY = 400;
    var HERO_GAUGE_PULSE_DELAY = 1200;

    function _heroGaugeSetOffset($fill, percent) {
      var offset = HERO_GAUGE_CIRCUMFERENCE * (1 - percent / 100);
      $fill.style.strokeDashoffset = offset;
    }

    OptiPlan.components.heroGauges = {
      $heroGauges: null,
      $gauges: null,
      _fillTimeout: null,
      _pulseTimeout: null,

      init: function() {
        this.$heroGauges = document.querySelector('.hero-gauges');
        if (!this.$heroGauges) return;
        this.$gauges = this.$heroGauges.querySelectorAll('.hero-gauge');
        this.render();
      },

      render: function() {
        var self = this;
        var circumference = HERO_GAUGE_CIRCUMFERENCE;

        self.$gauges.forEach(function($gauge, index) {
          var config = HERO_GAUGE_CONFIG[index];
          if (!config) return;

          var $fill = $gauge.querySelector('.hero-gauge__fill');
          var $value = $gauge.querySelector('.hero-gauge__value');

          // Set initial state: full circumference = hidden
          $fill.style.strokeDasharray = circumference;
          $fill.style.strokeDashoffset = circumference;

          // Set percentage text
          $value.textContent = OptiPlan.utils.formatPercent(config.value);
        });

        // After 400ms delay, animate to target offset (CSS transition handles animation)
        self._fillTimeout = setTimeout(function() {
          self.$gauges.forEach(function($gauge, index) {
            var config = HERO_GAUGE_CONFIG[index];
            if (!config) return;
            var $fill = $gauge.querySelector('.hero-gauge__fill');
            $fill.classList.add('is-animating');
            _heroGaugeSetOffset($fill, config.value);
          });
        }, HERO_GAUGE_FILL_DELAY);

        // After fill animation completes (~1200ms), remove will-change and add idle pulse class
        self._pulseTimeout = setTimeout(function() {
          self.$gauges.forEach(function($gauge) {
            var $fill = $gauge.querySelector('.hero-gauge__fill');
            $fill.classList.remove('is-animating');
            $fill.classList.add('is-idle');
          });
        }, HERO_GAUGE_PULSE_DELAY);
      },

      destroy: function() {
        if (this._fillTimeout) {
          clearTimeout(this._fillTimeout);
          this._fillTimeout = null;
        }
        if (this._pulseTimeout) {
          clearTimeout(this._pulseTimeout);
          this._pulseTimeout = null;
        }
        if (this.$gauges) {
          this.$gauges.forEach(function($gauge) {
            var $fill = $gauge.querySelector('.hero-gauge__fill');
            $fill.classList.remove('is-animating');
            $fill.classList.remove('is-idle');
          });
        }
      }
    };

    // ================================================================
    // SECTION: Theme Toggle Handler
    // ================================================================

    function handleThemeToggle(e) {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      OptiPlan.state.set('theme', newTheme);
    }

    function handleThemeToggleKeydown(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        handleThemeToggle(e);
      }
    }

    // ================================================================
    // SECTION: Initialization
    // ================================================================

    OptiPlan.init = function() {
      // Attach theme toggle listener
      const $themeToggle = document.getElementById('themeToggle');
      if ($themeToggle) {
        $themeToggle.addEventListener('click', handleThemeToggle);
        $themeToggle.addEventListener('keydown', handleThemeToggleKeydown);
      }

      // Set initial layer to overview
      OptiPlan.state.currentLayer = 'idle';
      const transitionResult = OptiPlan.state.transition('overview');
      if (!transitionResult) {
        console.warn('[OptiPlan Init] Initial transition to overview failed');
      }

      // Initialize components
      OptiPlan.components.sidebar.init();
      OptiPlan.components.topbar.init();
      OptiPlan.components.heroGauges.init();
    };

    document.addEventListener('DOMContentLoaded', OptiPlan.init.bind(OptiPlan));
  </script>
</body>
</html>
